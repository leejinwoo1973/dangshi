<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ íƒ€ì„ë¼ì¸ DB</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=KoPub+Batang:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>

    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { box-sizing: border-box !important; }
        :root { --line-color: #8B0000; --text-color: #333; --edit-color: #0056b3; --link-color: #1a0dab; --dot-color: #aaa; --tag-bg: #fff; --tag-border: #ccc; }
        body { font-family: 'KoPub Batang', 'Noto Serif KR', serif; color: var(--text-color); margin: 0; padding: 0; background-color: #fdfbf7; background-attachment: fixed; transition: background 0.3s; }
        
        /* [í—¤ë”] */
        #stickyHeader { position: -webkit-sticky; position: sticky; top: 0; z-index: 100; background-color: #fdfbf7; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding-top: 20px; transition: background 0.3s; }
        header { text-align: center; margin-bottom: 10px; padding: 0 20px;}
        h1 { color: var(--line-color); margin: 0 0 5px 0; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); }
        .page-desc { color: #555; font-size: 0.95rem; margin-bottom: 15px; font-weight: bold; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        
        .search-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-input { padding: 8px; border: 2px solid var(--line-color); border-radius: 20px; width: 250px; outline: none; }
        .filter-select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .stat-btn, .print-btn, .btn-common { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight:bold; transition: transform 0.2s; }
        .btn-map { background: #28a745; } .btn-rel { background: #6f42c1; } .btn-stat { background: #17a2b8; } .print-btn { background: #333; }
        .stat-btn:hover, .btn-common:hover { transform: scale(1.05); }

        /* [íƒ€ì„ë¼ì¸] */
        .timeline-headers { position: relative; max-width: 1000px; width: 100%; height: 60px; margin: 0 auto; padding-bottom: 15px; }
        #badgeLeft, #badgeRight { position: absolute; top: 0; display: inline-block; padding: 12px 0; width: 160px; border-radius: 15px; font-weight: bold; font-size: 1.2rem; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); text-align: center; background-color: #fff; }
        #badgeLeft { right: 50%; margin-right: 50px; } #badgeRight { left: 50%; margin-left: 50px; }

        .timeline { position: relative; max-width: 1000px; margin: 0 auto; padding-bottom: 80px; padding-top: 20px; }
        .timeline::after { content: ''; position: absolute; width: 4px; background-color: var(--line-color); top: 0; bottom: 0; left: 50%; margin-left: -2px; z-index: 0; }
        .container { padding: 10px 50px; position: relative; width: 50%; }
        .left { left: 0; text-align: right; } .right { left: 50%; text-align: left; }
        
        .content { padding: 15px; position: relative; transition: transform 0.2s; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 2px 2px 5px rgba(0,0,0,0.05); background: white; text-align: left; }
        .left .content { text-align: right; }
        .content:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; }
        
        .year-bubble { position: absolute; width: 50px; height: 50px; background-color: white; border: 3px solid var(--line-color); border-radius: 50%; z-index: 10; text-align: center; line-height: 50px; font-weight: bold; font-size: 14px; color: var(--line-color); top: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .year-bubble:hover { background-color: var(--line-color); color: white; transform: scale(1.1); }
        .left .year-bubble { right: -25px; } .right .year-bubble { left: -25px; }
        
        .minor-row { width: 100%; height: 20px; position: relative; margin: 5px 0; }
        .minor-dot { position: absolute; left: 50%; margin-left: -6px; width: 12px; height: 12px; background-color: white; border: 2px solid var(--dot-color); border-radius: 50%; cursor: pointer; z-index: 5; transition: all 0.2s; }
        .minor-dot:hover { background-color: var(--edit-color); border-color: var(--edit-color); transform: scale(1.5); }
        .minor-dot::before { content: attr(data-tooltip); position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .minor-dot:hover::before { opacity: 1; }

        .thumb-img { max-width: 80px; max-height: 80px; display: block; margin: 5px; border: 1px solid #ddd; padding: 2px; background: #fff; }
        .left .thumb-img { float: left; margin-right: 15px; } .right .thumb-img { float: right; margin-left: 15px; }
        .era-tag { font-size: 0.8em; color: #666; display: block; margin-bottom: 2px;}
        .title-text { font-size: 1.3em; font-weight: bold; cursor: pointer; color: #000; border-bottom: none; }
        .title-text:hover { color: var(--line-color); text-decoration: underline; }
        .clearfix::after { content: ""; clear: both; display: table; }
        .action-btns { margin-top: 5px; font-size: 0.8rem; display: none; }
        .btn-text { cursor: pointer; text-decoration: underline; margin-left: 8px; }
        .btn-del { color: red; } .btn-edit { color: var(--edit-color); }
        .tag-badge { display: inline-block; font-size: 0.8rem; background: var(--tag-bg); color: #555; padding: 2px 8px; border: 1px solid var(--tag-border); border-radius: 5px; margin-right: 6px; margin-bottom: 6px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .tag-badge:hover { transform: translateY(-1px); box-shadow: 0 3px 5px rgba(0,0,0,0.1); background-color: #f8f9fa; border-color: #999; color: var(--line-color); }

        /* [ëª¨ë‹¬ ê³µí†µ] */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 2% auto; padding: 30px; border: 1px solid #888; width: 85%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; position: sticky; top: 0; right: 0; z-index: 10; background: rgba(255,255,255,0.9); padding: 0 10px; border-radius: 5px;}
        .close:hover { color: #000; }
        #floatingCloseBtn { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 3100; background-color: rgba(0, 0, 0, 0.75); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; backdrop-filter: blur(4px); transition: all 0.2s; }
        .back-btn { display: none; float: left; background: #eee; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #333; }

        /* [ìƒì„¸ ëª¨ë‹¬ ë‚´ë¶€] */
        .modal-body-container { background: #fdfbf7; padding: 25px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: block; overflow: hidden; }
        #mImg { float: left; margin-right: 25px; margin-bottom: 10px; max-width: 250px; width: 35%; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-radius: 5px; border: 3px solid #fff; }
        #mName { margin-top: 0; margin-bottom: 10px; font-size: 2em; color: #333; border-bottom: 2px solid var(--line-color); display: inline-block; line-height: 1.2; margin-right: 15px; }
        #mTags { display: inline-block; margin-bottom: 10px; vertical-align: middle; }
        #mDesc { font-size: 1.05rem; line-height: 2.2; color: #333; text-align: justify; margin-top: 10px; display: block; }
        #itemMapContainer { width: 100%; height: 250px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; display: none; clear: both; }
        #mContentArea { clear: both; margin-top: 40px; padding-top: 20px; border-top: 1px dashed #ddd; }
        
        details.outer-details { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow: visible !important; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        summary.outer-summary { padding: 15px; cursor: pointer; background: #f8f9fa; font-weight: bold; font-size: 1.1em; list-style: none; display: flex; align-items: center; justify-content: space-between; }
        summary.outer-summary:hover { background: #e9ecef; }
        summary.outer-summary::before { content: 'ğŸ“œ '; margin-right: 8px; }
        
        .poem-body { padding: 25px; white-space: pre-wrap; line-height: 2.2; color: #222; border-top: 1px solid #eee; font-family: 'KoPub Batang', serif; font-size: 1.1rem; overflow: visible; }
        .hanja-text { font-size: 1.3rem; color: #111; margin-bottom: 10px; line-height: 2.5; }
        details.inner-details { border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 15px; overflow: visible; }
        summary.inner-summary { font-size: 0.9rem; color: #555; cursor: pointer; list-style: none; font-weight: bold; margin-bottom: 10px;}
        summary.inner-summary::before { content: 'ğŸ’¡ '; }
        .explain-text { white-space: pre-wrap; line-height: 1.8; color: #444; }

        .wiki-link { color: #d63384; font-weight: bold; cursor: pointer; border-bottom: 1px dotted #d63384; }
        .img-card { display: block; border: 1px solid #ddd; padding: 5px; background: #fff; max-width: 90%; text-decoration: none !important; color: inherit !important; margin: 10px auto; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 15px 0; background: #000; clear: both; border-radius: 8px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .simp-btn { font-size: 0.8rem; background: #fff0f5; color: #d63384; border: 1px solid #d63384; border-radius: 3px; cursor: pointer; padding: 2px 5px; margin-top: 5px; display: inline-block; margin-right: 5px;}
        .simplified-box { display: none; font-family: 'Noto Serif SC', serif; color: #555; background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #d63384; line-height: 1.8; white-space: pre-wrap; }
        ruby { display: inline-block; text-align: center; margin: 0 2px; ruby-position: under; }
        rt { font-size: 0.6em; color: #777; font-family: sans-serif; display: block; line-height: 1.2; user-select: none; }
        .qtfm-btn { display: inline-block; background-color: #E60026; color: white; padding: 5px 12px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: bold; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .source-credit { margin-top: 30px; text-align: right; border-top: 1px dashed #ddd; padding-top: 10px; font-size: 0.85rem; color: #888; display: block; clear: both; }
        .source-credit img { vertical-align: middle; margin-right: 3px; max-height: 20px; }
        .fn-marker { cursor: pointer; color: var(--link-color); font-weight: bold; font-size: 0.6em; vertical-align: super; position: relative; top: -0.2em; }
        .fn-marker:hover::after { content: attr(data-tooltip); position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 0.95rem; width: max-content; max-width: 300px; white-space: normal; line-height: 1.5; z-index: 9999; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: left; }
        .fn-list { margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 0.9rem; color: #555; clear: both; background: #f9f9f9; padding: 15px; border-radius: 5px; }
        .fn-item { margin-bottom: 5px; }
        .fn-back { text-decoration: none; margin-right: 5px; color: #999; font-weight: bold; }

        /* [ê´€ë¦¬ì íŒ¨ë„ ë° ì‹œí¬ë¦¿ ë²„íŠ¼] */
        #adminPanel { display: none; position: fixed; top: 60px; right: 20px; width: 500px; background: white; border: 2px solid #333; padding: 25px; z-index: 2100; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; font-family: sans-serif; }
        .form-group { margin-bottom: 12px; } .form-group label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 5px;}
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; font-size: 14px; }
        textarea { resize: vertical; } input[type="color"] { padding: 0; height: 35px; cursor: pointer;}
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-save { background-color: var(--line-color); color: white; border: none; padding: 12px; flex: 1; cursor: pointer; font-weight: bold; font-size: 14px;}
        .btn-reset { background-color: #666; color: white; border: none; padding: 12px; cursor: pointer;}
        .config-section { background: #eef; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ccd; }
        .config-toggle { width: 100%; text-align: left; background: none; border: none; cursor: pointer; font-weight: bold; padding: 0; }
        .tool-btn { color: white; border: none; padding: 3px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 5px; }
        .btn-green { background-color: #28a745; } .btn-blue { background-color: #007bff; } .btn-purple { background-color: #6f42c1; } .btn-orange { background-color: #fd7e14; }
        .syntax-guide { font-size: 11px; color: #555; background: #f8f9fa; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; line-height: 1.5; letter-spacing: -0.5px; }
        .syntax-guide code { background: #fff; border: 1px solid #ccc; padding: 1px 4px; border-radius: 3px; color: #d63384; font-family: monospace; font-weight: bold; }
        
        .admin-btn { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #333; color: white; border: none; cursor: pointer; z-index: 2000; border-radius: 5px; display: none; }
        
        /* [v13.10] ì‹œí¬ë¦¿ ë¡œê·¸ì¸ ë²„íŠ¼ (íˆ¬ëª…) */
        .login-trigger { position: fixed; bottom: 0; right: 0; width: 50px; height: 50px; background: transparent; z-index: 9999; cursor: default; }

        /* [íŠ¹ìˆ˜ ê¸°ëŠ¥] */
        #map { width: 100%; height: 500px; border-radius: 8px; border: 2px solid #333; }
        #network { width: 100%; height: 600px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }
        #cropperModal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); }
        .crop-container { width:90%; height:70vh; margin:5vh auto; }
        .crop-controls { text-align:center; margin-top:10px; }
        .custom-map-marker { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 5px rgba(0,0,0,0.3); background-size: cover; background-position: center; background-color: #ccc; text-align: center; line-height: 34px; font-weight: bold; color: white; }
        .custom-map-marker.default-marker { background-color: var(--line-color); }
        .custom-map-marker:hover { transform: scale(1.1); border-color: var(--line-color); transition: all 0.2s; }
        .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem;}
        .stat-table th, .stat-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .stat-table th { background-color: #f2f2f2; font-weight: bold; }
        .stat-scroll-box { max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .stat-rank-table { width: 100%; border-collapse: collapse; }
        .stat-rank-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .rank-num { font-weight: bold; color: #8B0000; width: 30px; text-align: center; }

        footer { text-align: center; padding: 20px; border-top: 1px solid #ddd; color: #888; font-size: 0.9rem; font-family: 'Noto Serif KR', serif; background-color: #fdfbf7; }

        @media (max-width: 768px) {
            #mImg { float: none; display: block; margin: 0 auto 15px auto; width: 70%; max-width: 250px; }
            #mName, #mTags { text-align: center; display: block; width: 100%; border-bottom: none;}
            #mName { font-size: 1.5em; margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 10px;}
            .modal-content { padding: 15px; width: 95%; }
            .modal-body-container { text-align: center; padding: 15px; }
            .thumb-img, .tag-container, .content small, .action-btns { display: none !important; }
            .content { padding: 10px 15px; min-height: auto; display: flex; flex-direction: column; justify-content: center; }
            .title-text { font-size: 1.15rem; margin-bottom: 0; border-bottom: none; line-height: 1.3; }
            .era-tag { font-size: 0.85rem; margin-bottom: 3px; color: #666; font-weight: bold; }
            .timeline-headers { display: flex; height: auto; padding: 0 10px; }
            #badgeLeft, #badgeRight { position: static; width: 48%; margin: 0 1%; padding: 10px 0; font-size: 1rem; }
            .container { padding: 10px 30px; } 
            .left .content { align-items: flex-end; text-align: right; }
            .right .content { align-items: flex-start; text-align: left; }
        }
        @media print {
            .admin-btn, .search-bar, .action-btns, .config-section, .btn-group, .help-trigger, .modal, .simp-btn, .pinyin-btn, .tts-btn, .login-trigger, #floatingCloseBtn { display: none !important; }
            #stickyHeader { position: static; box-shadow: none; }
            body { background: white !important; color: black; padding-top: 0 !important; }
            .content { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; }
            .timeline::after { background-color: #ccc; }
            .year-bubble { border-color: #333; color: #333; }
        }
    </style>
</head>
<body>
    <div id="stickyHeader">
        <header>
            <h1 id="pageTitle">ë‚˜ë§Œì˜ ì—­ì‚¬ ì—°í‘œ</h1>
            <p id="pageDesc" class="page-desc">ë¡œë”© ì¤‘...</p>
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="ì´ë¦„, ë‚´ìš©, íƒœê·¸ ê²€ìƒ‰..." onkeyup="filterData()">
                <select id="eraFilter" class="filter-select" onchange="filterData()"> <option value="all">ëª¨ë“  ì‹œëŒ€</option> </select>
                <button class="btn-common btn-rel" onclick="openRelModal()">ğŸ•¸ï¸ ê´€ê³„ë„</button>
                <button class="btn-common btn-map" onclick="openMapModal()">ğŸ—ºï¸ ì§€ë„</button>
                <button class="stat-btn" onclick="openStatModal()">ğŸ“Š í†µê³„</button>
                <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </header>
        <div class="timeline-headers"><span id="badgeLeft">Left</span><span id="badgeRight">Right</span></div>
    </div>

    <button id="floatingCloseBtn" onclick="closeModal('detailModal')">âŒ ë‹«ê¸°</button>
    <button id="adminToggle" class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬/ì„¤ì •</button>

    <div id="adminPanel">
        <div class="config-section">
            <button class="config-toggle" onclick="toggleConfig()">ğŸ› ï¸ ë””ìì¸ ë° ì„¤ì • (í¼ì¹˜ê¸°)</button>
            <div id="configForm" style="display:none; margin-top:10px;">
                <div class="form-group"><label>ë©”ì¸ ì œëª©</label> <input type="text" id="cfgTitle"></div>
                <div class="form-group"><label>ì•ˆë‚´ ë¬¸êµ¬</label> <textarea id="cfgDesc" rows="2"></textarea></div>
                <div class="form-group"><label>ë°”ë‹¥ê¸€(Copyright) ë‚´ìš©</label> <input type="text" id="cfgCopyright"></div>
                <div class="form-group" style="display:flex; gap:5px;"><div style="flex:1;"><label>ì™¼ìª½ ì´ë¦„</label><input type="text" id="cfgLabelLeft"></div><div style="flex:1;"><label>ì˜¤ë¥¸ìª½ ì´ë¦„</label><input type="text" id="cfgLabelRight"></div></div>
                <div class="form-group"><label>ë°°ê²½ìƒ‰</label> <input type="color" id="cfgBgColor" style="width:100%;"></div>
                <div class="form-group"><label>ë°°ê²½ ì´ë¯¸ì§€</label> <input type="text" id="cfgBgImage"></div>
                <div class="form-group"><label>ë°˜ë³µ</label> <select id="cfgBgRepeat"><option value="repeat">ë°˜ë³µ</option><option value="cover">ê½‰ ì±„ìš°ê¸°</option></select></div>
                <div class="form-group" style="display:flex; gap:5px;"><div style="flex:1;"><label>ì¢Œì¸¡ ìƒ‰</label><input type="color" id="cfgLeftColor" style="width:100%;"></div><div style="flex:1;"><label>ìš°ì¸¡ ìƒ‰</label><input type="color" id="cfgRightColor" style="width:100%;"></div></div>
                <button class="btn-save" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            </div>
        </div>
        <h3 id="formTitle" style="margin-top:20px; border-top:2px solid #333; padding-top:10px;">ë°ì´í„° ì…ë ¥</h3>
        
        <div class="form-group" style="background:#fff3cd; padding:10px; border-radius:5px; border:1px solid #ffeeba; display:flex; gap:10px;">
            <div style="flex:1;"><label>ğŸ¨ ê°•ì¡°ìƒ‰</label><input type="color" id="inCardColor" value="#ffffff" style="width:100%;"></div>
            <div style="flex:0 0 auto;"><button type="button" onclick="document.getElementById('inCardColor').value = '';" style="font-size:11px;">ê¸°ë³¸ê°’</button></div>
        </div>
        <div class="form-group" style="background:#f0f8ff; padding:10px; border-radius:5px; border:1px solid #cceeff;">
            <label style="margin-bottom:0;"><input type="checkbox" id="inShow" checked> <strong>í¬ê²Œ ë³´ì´ê¸°</strong></label>
        </div>
        
        <div class="form-group" style="background:#e8f5e9; padding:10px; border-radius:5px; margin-bottom:10px;">
             <label>ğŸ“ ì§€ë„ ìœ„ì¹˜ (ì˜ì–´ ê²€ìƒ‰ ê¶Œì¥)</label>
             <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" id="inLocationSearch" placeholder="ì˜ˆ: Chang'an" style="flex:1;"><button type="button" onclick="searchLocation()" class="tool-btn btn-green" style="padding:5px 10px;">ğŸ”</button></div>
             <div style="display:flex; gap:5px;"><input type="number" id="inLat" placeholder="ìœ„ë„" style="flex:1;"><input type="number" id="inLng" placeholder="ê²½ë„" style="flex:1;"></div>
             <input type="text" id="inGeoName" placeholder="ì¥ì†Œëª… (ì˜ˆ: ì¥ì•ˆ)" style="margin-top:5px; width:100%;">
        </div>

        <div class="form-group"><label>ìœ„ì¹˜</label> <select id="inType" onchange="updateFormUI()"><option value="poet" id="optLeft">ì™¼ìª½</option><option value="history" id="optRight">ì˜¤ë¥¸ìª½</option></select></div>
        <div class="form-group"><label>ì—°ë„ (ì‹œì‘ ~ ì¢…ë£Œ)</label>
            <div style="display:flex; gap:5px;"><input type="number" id="inYear" placeholder="ì‹œì‘(ì¶œìƒ)" style="flex:1;"><span style="padding-top:10px;">~</span><input type="number" id="inDeathYear" placeholder="ì¢…ë£Œ(ì‚¬ë§)" style="flex:1;"><input type="text" id="inEra" placeholder="ì‹œëŒ€" style="flex:1;"></div>
        </div>
        <div class="form-group"><label>ì œëª©/ì´ë¦„</label>
            <div style="display:flex; gap:5px;"><input type="text" id="inName" placeholder="í•œê¸€ ì´ë¦„" style="flex:1;"><input type="text" id="inHanja" placeholder="í•œì (ì„ íƒ)" style="flex:1;"></div>
        </div>
        <div class="form-group"><label>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ (ì´ë¦„:ê´€ê³„)</label><input type="text" id="inRelations" placeholder="ì˜ˆ: ë‘ë³´:ì¹œêµ¬, ë§¹í˜¸ì—°:ì¡´ê²½"></div>
        <div class="form-group"><label>íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label> <input type="text" id="inTags" placeholder="ì˜ˆ: ì „ìŸ, ì´ë³„, ìœ ë°°"></div>
        <div class="form-group"><label>ìš”ì•½ (4ì¤„)</label> <textarea id="inDesc" rows="4"></textarea></div>
        <div class="form-group"><label>ì´ë¯¸ì§€</label>
            <input type="text" id="inImg" placeholder="ì´ë¯¸ì§€ URL">
            <div style="margin-top:5px;">
                <button type="button" onclick="document.getElementById('imgInput').click()" style="background:#666; color:white; border:none; padding:5px 10px; border-radius:3px;">ğŸ“· PC ì‚¬ì§„ ì—…ë¡œë“œ (ìë™ í¬ë¡­)</button>
                <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImageSelect(this)">
            </div>
        </div>
        <div class="form-group">
            <label id="detailLabel" style="display:inline-block; margin-bottom:5px;">ìƒì„¸ ë‚´ìš©</label>
            <div style="margin-bottom:5px;">
                <button type="button" class="tool-btn btn-green" onclick="autoPinyin()">ğŸ”  ë³‘ìŒ</button> <button type="button" class="tool-btn btn-blue" onclick="autoTone()">ğŸ”² í‰ì¸¡</button> <button type="button" class="tool-btn btn-orange" onclick="insertAudio()">ğŸµ ì˜¤ë””ì˜¤</button> <button type="button" class="tool-btn btn-purple" onclick="insertLicense()">ğŸ“œ ì¶œì²˜</button>
            </div>
            <div class="syntax-guide">
                <code>%%êµµê²Œ%%</code> &nbsp; <code>$$ê¸°ìš¸ì„$$</code> &nbsp; <code>[* ì£¼ì„ë‚´ìš©]</code><br>
                <code>[ë§í¬](ì£¼ì†Œ)</code> &nbsp; <code>{{ì´ë¯¸ì§€|ì£¼ì†Œ|ì„¤ëª…}}</code> &nbsp; <code>{{ì˜¤ë””ì˜¤|ì£¼ì†Œ}}</code><br>
                <code>===</code> (êµ¬ë¶„) &nbsp; <code>+++</code> (ê°„ì²´) &nbsp; <code>---</code> (í•´ì„¤)
            </div>
            <textarea id="inContent" rows="15"></textarea>
        </div>
        <div class="btn-group"><button id="btnSave" class="btn-save" onclick="saveData()">ì €ì¥</button><button class="btn-reset" onclick="clearForm()">ì·¨ì†Œ</button></div>
        <hr>
        <div class="btn-group"><button class="btn-download" onclick="exportData()">ğŸ’¾ DB ë‹¤ìš´ë¡œë“œ</button><input type="file" id="fileInput" onchange="importData(this)" style="display:none;"><button class="btn-reset" style="width:100%;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ DB ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
        <button class="btn-reset" style="width:100%; background:darkred; margin-top:5px;" onclick="resetAllData()">âš ï¸ ë¡œì»¬ ì´ˆê¸°í™”</button>
    </div>
    
    <div class="timeline" id="timeline-root"></div>
    <footer id="pageFooter"></footer>
    <div class="login-trigger" onclick="adminLogin()" title=""></div>

    <div id="detailModal" class="modal">
        <div class="modal-content"><button id="backBtn" class="back-btn" onclick="goBack()">â¬… ë’¤ë¡œ</button><span class="close" onclick="closeModal('detailModal')">&times;</span><div style="clear:both;"></div>
            <div class="modal-body-container">
                <img id="mImg" class="img-card" style="display:none;">
                <div id="mName"></div><div id="mTags"></div><div id="mDesc"></div><div style="clear:both;"></div>
            </div>
            <div id="itemMapContainer"></div>
            <div id="mContentArea"></div>
        </div>
    </div>
    <div id="contextModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('contextModal')">&times;</span><h3 style="text-align:center; border-bottom:2px solid #8B0000; padding-bottom:10px;">âŒ› <span id="ctxTargetYear"></span>ë…„ ì „í›„ ê¸°ë¡</h3><ul id="ctxList" class="ctx-list"></ul></div></div>
    <div id="statModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('statModal')">&times;</span><h3>ğŸ“Š ë°ì´í„° í†µê³„</h3><div id="statContent"></div></div></div>
    <div id="mapModal" class="modal"><div class="modal-content" style="max-width: 900px;"><span class="close" onclick="closeModal('mapModal')">&times;</span><h3>ğŸ—ºï¸ ì—­ì‚¬ ì§€ë„ (í´ë¦­í•˜ì—¬ ì´ë™)</h3><div id="map"></div></div></div>
    <div id="relModal" class="modal"><div class="modal-content" style="max-width: 1000px;"><span class="close" onclick="closeModal('relModal')">&times;</span><h3>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ë„</h3><div id="network"></div></div></div>
    <div id="cropperModal"><div class="crop-container"><div style="height:80%;"><img id="cropImage" style="max-width:100%;"></div><div class="crop-controls"><button class="btn-common btn-map" onclick="performCrop()">âœ‚ï¸ ìë¥´ê¸° & ì €ì¥</button><button class="btn-common" onclick="document.getElementById('cropperModal').style.display='none'">ì·¨ì†Œ</button></div></div></div>

    <script>
        const defaultConfig = { title: "ë‹¹ë‚˜ë¼ ì—­ì‚¬ì™€ ì‹œì¸ ì—°í‘œ", desc: "ë‚˜ë§Œì˜ ì—­ì‚¬ ë°ì´í„°ë² ì´ìŠ¤", leftLabel: "ì‹œì¸ / ì‘í’ˆ", rightLabel: "ì—­ì‚¬ / ì‚¬ê±´", bgColor: "#fdfbf7", bgImage: "", bgRepeat: "repeat", leftCardColor: "#ffffff", rightCardColor: "#ffffff", copyright: "" };
        let db=[], config={}, editingId=null, modalHistory=[], currentOpenId=null;
        let isAdmin = false; 
        let map = null; let markersLayer = null; let cropper = null; let itemMap = null;

        function applyConfigUI() {
            document.getElementById('pageTitle').innerText = config.title; document.getElementById('pageDesc').innerText = config.desc;
            document.title = config.title; 
            document.getElementById('pageFooter').innerHTML = config.copyright || "";
            document.getElementById('cfgCopyright').value = config.copyright || "";
            const badgeLeft = document.getElementById('badgeLeft'); const badgeRight = document.getElementById('badgeRight');
            badgeLeft.innerText = config.leftLabel; badgeRight.innerText = config.rightLabel;
            badgeLeft.style.backgroundColor = config.leftCardColor || "#ffffff"; badgeRight.style.backgroundColor = config.rightCardColor || "#ffffff";
            document.getElementById('cfgTitle').value = config.title; document.getElementById('cfgDesc').value = config.desc;
            document.getElementById('cfgLabelLeft').value = config.leftLabel; document.getElementById('cfgLabelRight').value = config.rightLabel;
            document.getElementById('cfgBgColor').value = config.bgColor || "#fdfbf7"; document.getElementById('cfgBgImage').value = config.bgImage || "";
            document.getElementById('cfgLeftColor').value = config.leftCardColor || "#ffffff"; document.getElementById('cfgRightColor').value = config.rightCardColor || "#ffffff";
            document.getElementById('optLeft').innerText = "ì™¼ìª½: " + config.leftLabel; document.getElementById('optRight').innerText = "ì˜¤ë¥¸ìª½: " + config.rightLabel;
            document.body.style.backgroundColor = config.bgColor || "#fdfbf7"; document.getElementById('stickyHeader').style.backgroundColor = config.bgColor || "#fdfbf7";
            document.getElementById('pageFooter').style.backgroundColor = config.bgColor || "#fdfbf7";
            if(config.bgImage) { document.body.style.backgroundImage = `url('${config.bgImage}')`; document.body.style.backgroundSize = config.bgRepeat === 'cover' ? 'cover' : 'auto'; document.body.style.backgroundRepeat = config.bgRepeat === 'cover' ? 'no-repeat' : 'repeat'; } else { document.body.style.backgroundImage = 'none'; }
            updateFormUI(); setTimeout(adjustPadding, 100);
        }

        async function init() {
            try {
                try { const r = await fetch('database.json'); if(r.ok) { const j = await r.json(); db = j.data || []; config = j.config || defaultConfig; } else throw new Error("No ext DB"); } 
                catch (e) { const s = localStorage.getItem('tangTimelineDB'); db = s ? JSON.parse(s) : []; const c = localStorage.getItem('tangTimelineConfig'); config = c ? JSON.parse(c) : {...defaultConfig}; }
                applyConfigUI(); populateEraFilter(); render();
                document.getElementById('pageDesc').innerText = config.desc; document.getElementById('adminToggle').style.display = 'none';
                adjustPadding(); window.addEventListener('resize', adjustPadding);
            } catch (e) { alert("ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message); }
        }

        function adjustPadding() { const h = document.getElementById('stickyHeader').offsetHeight; document.getElementById('timeline-root').style.paddingTop = (h + 30) + 'px'; }
        async function adminLogin() { if (isAdmin) return; const p = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:"); if (!p) return; const h = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p)))).map(b => b.toString(16).padStart(2, '0')).join(''); if (h === "6eb20c53054a7218e6731761b7539d9e38f6f5e39e53c2d78e0edd732de650f2") { isAdmin = true; document.getElementById('adminToggle').style.display = 'block'; alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”!"); render(); } else alert("ì˜¤ë¥˜"); }
        function saveToLocal() { db.sort((a, b) => a.year - b.year); localStorage.setItem('tangTimelineDB', JSON.stringify(db)); }
        function exportData() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ data: db, config: config })); const n = document.createElement('a'); n.href = d; n.download = "database.json"; document.body.appendChild(n); n.click(); n.remove(); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { try { const l = JSON.parse(e.target.result); if(l.data) { db = l.data; config = l.config || defaultConfig; } else db = l; localStorage.setItem('tangTimelineConfig', JSON.stringify(config)); saveToLocal(); applyConfigUI(); alert('ì™„ë£Œ'); } catch(err) { alert('ì˜¤ë¥˜: ' + err.message); } }; r.readAsText(f); }

        async function searchLocation() { const q = document.getElementById('inLocationSearch').value; if(!q) return; try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`); const j = await r.json(); if(j.length>0) { document.getElementById('inLat').value = parseFloat(j[0].lat).toFixed(4); document.getElementById('inLng').value = parseFloat(j[0].lon).toFixed(4); alert("ë°œê²¬: "+j[0].display_name); } else alert("ì‹¤íŒ¨"); } catch(e){alert("ì˜¤ë¥˜");} }
        function handleImageSelect(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('cropperModal').style.display = 'block'; const img = document.getElementById('cropImage'); img.src = e.target.result; if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 }); }; reader.readAsDataURL(input.files[0]); } }
        function performCrop() { if(!cropper) return; const canvas = cropper.getCroppedCanvas({ width:200, height:200 }); document.getElementById('inImg').value = canvas.toDataURL('image/jpeg', 0.8); document.getElementById('cropperModal').style.display='none'; }

        function autoPinyin() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'symbol', nonZh: 'consecutive' }); i.setRangeText(t.map(x => x.isZh ? `${x.origin}(${x.pinyin})` : x.origin).join('')); }
        function autoTone() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'num', nonZh: 'consecutive' }); i.setRangeText(t.map(x => { if (!x.isZh) return x.origin; return `${x.origin}(${/[34]$/.test(x.pinyin)?'â—':'â—‹'})`; }).join('')); }
        function insertLicense() { const c = prompt("1.ë™ì–‘ê³ ì „ 2.ë‚˜ë¬´ìœ„í‚¤ 3.ìœ„í‚¤ë°±ê³¼"); let h=""; if(c=='1') h="ìë£Œì¶œì²˜: <a href='http://db.cyberseodang.or.kr' target='_blank'><img src='http://db.cyberseodang.or.kr/images/front/logo_b.png'></a>"; else if(c=='2') h="ì¶œì²˜: <a href='https://namu.wiki' target='_blank'>ë‚˜ë¬´ìœ„í‚¤</a>"; else if(c=='3') h="ì¶œì²˜: ìœ„í‚¤ë°±ê³¼"; const i=document.getElementById('inContent'); const s=i.selectionStart; i.value = i.value.substring(0,s)+`\n### ${h} ###`+i.value.substring(i.selectionEnd); }
        function insertAudio() { let u = prompt("ì˜¤ë””ì˜¤ íŒŒì¼ëª…"); if(u) { if(!u.startsWith('http')) u='https://tangshi.kr/mp3/'+u; document.getElementById('inContent').setRangeText(`{{ì˜¤ë””ì˜¤|${u}}}`); } }
        function cleanTitle(t) { return t ? t.replace(/\[.*?\]/g, '').trim() : ""; }
        function cleanTextForCard(t) { if(!t) return ""; return t.replace(/\{\{.*?\}\}/g, '').replace(/###.*?###/g, '').replace(/%%(.*?)%%/g, '$1').replace(/\$\$(.*?)\$\$/g, '$1').replace(/\[\[(.*?)\]\]/g, '$1').substring(0, 40)+"..."; }
        
        function parseText(t, m=false) { 
            if(!t) return "";
            t = t.replace(/%%(.*?)%%/g, '<b>$1</b>').replace(/\$\$(.*?)\$\$/g, '<span style="color:#888; font-style:italic;">$1</span>')
                 .replace(/'''(.*?)'''/g, '<b>$1</b>').replace(/''(.*?)''/g, '<i>$1</i>').replace(/~~(.*?)~~/g, '<del>$1</del>').replace(/--(.*?)--/g, '<del>$1</del>').replace(/__(.*?)__/g, '<u>$1</u>').replace(/\^\^(.*?)\^\^/g, '<sup>$1</sup>').replace(/,,(.*?),,/g, '<sub>$1</sub>')
                 .replace(/{{{#([a-zA-Z0-9]+)\s+(.*?)}}}/g, '<span style="color:$1">$2</span>').replace(/{{{([+\-]\d)\s+(.*?)}}}/g, (m, s, c) => `<span style="font-size:${1.0+(parseInt(s)*0.2)}em">${c}</span>`);

            let footnotes = []; let fnCount = 0; const blockId = Math.random().toString(36).substr(2, 5);
            t = t.replace(/\[\*\s*(.*?)\]/g, (match, content) => {
                fnCount++; footnotes.push({ id: `${blockId}-${fnCount}`, num: fnCount, content: content });
                return `<sup class="fn-marker" data-tooltip="${content.replace(/"/g, '&quot;')}"><a href="#fn-${blockId}-${fnCount}" id="ref-${blockId}-${fnCount}">[${fnCount}]</a></sup>`;
            });

            if(m) t = t.replace(/([\u2E80-\u2EFF\u31C0-\u31EF\u3200-\u32FF\u3400-\u4DBF\u4E00-\u9FBF\uF900-\uFAFF])\(([^)]+)\)/g, "<ruby>$1<rt>$2</rt></ruby>"); 
            t = t.replace(/(https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([\w-]{11})(?:\S+)?)/g, '<div class="video-container"><iframe src="https://www.youtube.com/embed/$2" frameborder="0" allowfullscreen></iframe></div>')
                 .replace(/\{\{ì˜¤ë””ì˜¤\|(.*?)\}\}/g, '<div style="margin-top:10px;"><audio controls src="$1" style="width:100%; border-radius:20px;"></audio></div>')
                 .replace(/###(.*?)###/g, '<div class="source-credit">$1</div>')
                 .replace(/\[\[(.+?)\]\]/g, '<span class="wiki-link" onclick="openModalByName(\'$1\')">$1</span>')
                 .replace(/\{\{(.+?)\s*\|\s*(.+?)\s*\|\s*(.+?)\}\}/g, '<a href="$2" target="_blank" class="img-card"><img src="$1" alt="$3"><span class="img-caption">$3</span></a>');

            if (footnotes.length > 0) { t += `<div class="fn-list"><hr>`; footnotes.forEach(fn => { t += `<div id="fn-${fn.id}" class="fn-item"><a href="#ref-${fn.id}" class="fn-back">^</a> <b>[${fn.num}]</b> ${fn.content}</div>`; }); t += `</div>`; }
            return t;
        }

        function openMapModal() {
            document.getElementById('mapModal').style.display = 'block';
            setTimeout(() => {
                if (!map) { map = L.map('map').setView([34.26, 108.94], 5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map); markersLayer = L.layerGroup().addTo(map); } 
                else { map.invalidateSize(); }
                markersLayer.clearLayers();
                db.forEach(item => {
                    if(item.lat && item.lng) { 
                        let iconHtml = item.img ? `<div class="custom-map-marker" style="background-image: url('${item.img}');"></div>` : `<div class="custom-map-marker default-marker">${cleanTitle(item.name).charAt(0)}</div>`;
                        const customIcon = L.divIcon({ html: iconHtml, className: 'marker-container', iconSize: [40, 40], iconAnchor: [20, 20] });
                        const m = L.marker([item.lat, item.lng], {icon: customIcon});
                        m.bindTooltip(`<b>${cleanTitle(item.name)}</b><br><small>${item.geoName||''}</small>`);
                        m.on('click', () => { closeModal('mapModal'); openModal(item.id); });
                        markersLayer.addLayer(m); 
                    }
                });
            }, 200);
        }
        function openRelModal() {
            document.getElementById('relModal').style.display = 'block';
            const nodes = []; const edges = []; const ids = new Set();
            db.forEach(item => {
                if(!item.isShow || !item.relations) return;
                const name = cleanTitle(item.name);
                if(!ids.has(name)) { 
                    if(item.img) nodes.push({id:name, label:name, shape:'circularImage', image:item.img, size:30, borderWidth:3, color:{border:'#ffcc00', background:'#ffffff'}});
                    else nodes.push({id:name, label:name, size:25, shape:'dot', color:'#ffcc00'}); 
                    ids.add(name); 
                }
                item.relations.split(',').forEach(r => {
                    const p = r.split(':'); const target = p[0].trim();
                    if(!ids.has(target)) { nodes.push({id:target, label:target, size:20, shape:'dot', color:'#eee'}); ids.add(target); }
                    edges.push({from:name, to:target, label:p[1]||'', arrows:'to'});
                });
            });
            const container = document.getElementById('network');
            new vis.Network(container, { nodes, edges }, { nodes:{font:{size:16, face:'KoPub Batang'}}, physics:{stabilization:false}, interaction:{hover:true} });
        }

        function render(query = "", eraFilter = "all") {
            const root = document.getElementById('timeline-root'); root.innerHTML = '';
            const safeQuery = query ? query.trim().toLowerCase() : "";
            const filtered = db.filter(item => {
                const eraMatch = eraFilter === 'all' || item.era === eraFilter;
                if (!safeQuery) return eraMatch;
                let textMatch = (item.name.toLowerCase().includes(safeQuery) || item.desc.toLowerCase().includes(safeQuery) || (item.tags && item.tags.join(" ").toLowerCase().includes(safeQuery)));
                if (!textMatch && item.historyDetail && item.historyDetail.toLowerCase().includes(safeQuery)) textMatch = true;
                if (!textMatch && item.poems) if (item.poems.some(p => p.title && p.title.toLowerCase().includes(safeQuery) || p.content && p.content.toLowerCase().includes(safeQuery))) textMatch = true;
                return eraMatch && textMatch;
            });

            filtered.forEach(item => {
                if (item.isShow) {
                    const div = document.createElement('div'); div.className = item.type === 'poet' ? 'container left' : 'container right';
                    const imgTag = item.img ? `<img src="${item.img}" class="thumb-img">` : '';
                    let cardBg = (item.cardColor && item.cardColor !== "#ffffff") ? item.cardColor : (item.type === 'poet' ? config.leftCardColor : config.rightCardColor) || "#ffffff";
                    
                    const btns = isAdmin ? `<div class="action-btns" style="display:block;"><span class="btn-text btn-edit" onclick="editItem(${item.id})">[ìˆ˜ì •]</span><span class="btn-text btn-del" onclick="deleteItem(${item.id})">[ì‚­ì œ]</span></div>` : '';
                    let titleHtml = cleanTitle(item.name);
                    if (item.type === 'poet') {
                        let subInfo = []; if (item.hanja) subInfo.push(item.hanja);
                        if (item.deathYear) subInfo.push(`${item.year}~${item.deathYear}`); else subInfo.push(item.year);
                        if (subInfo.length > 0) titleHtml += ` <span style='font-size:0.7em; font-weight:normal;'>(${subInfo.join(' ')})</span>`;
                    }
                    div.innerHTML = `<div class="year-bubble" onclick="openContextModal(${item.id})">${item.year}</div><div class="content clearfix" style="background-color:${cardBg};">${imgTag} <span class="era-tag">${item.era}</span><div class="title-text" onclick="openModal(${item.id})">${titleHtml}</div><small>${cleanTextForCard(item.desc)}</small>${btns}</div>`;
                    root.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.className = 'minor-row';
                    div.innerHTML = `<div class="minor-dot" data-tooltip="${item.year} : ${item.name}" onclick="openModal(${item.id})"></div>`;
                    root.appendChild(div);
                }
            });
            setTimeout(adjustPadding, 100);
        }

        function populateEraFilter() { const s = document.getElementById('eraFilter'); const e = [...new Set(db.map(item => item.era).filter(e => e))].sort(); s.innerHTML = '<option value="all">ëª¨ë“  ì‹œëŒ€</option>'; e.forEach(era => { s.innerHTML += `<option value="${era}">${era}</option>`; }); }
        function filterData() { render(document.getElementById('searchInput').value.toLowerCase(), document.getElementById('eraFilter').value); }
        function searchTag(tag) { document.getElementById('searchInput').value = tag; filterData(); }
        function toggleAdmin() { document.getElementById('adminPanel').style.display = document.getElementById('adminPanel').style.display === 'block' ? 'none' : 'block'; }
        function toggleConfig() { document.getElementById('configForm').style.display = document.getElementById('configForm').style.display === 'none' ? 'block' : 'none'; }
        function toggleSimplified(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'none' || el.style.display === '' ? 'block' : 'none'; }
        function saveConfig() { localStorage.setItem('tangTimelineConfig', JSON.stringify(config)); applyConfigUI(); render(); alert('ì €ì¥ë¨'); }
        function updateFormUI() {}
        
        function editItem(id) {
            const item = db.find(d => d.id === Number(id)); if (!item) return;
            document.getElementById('adminPanel').style.display = 'block'; 
            document.getElementById('inShow').checked = item.isShow;
            document.getElementById('inType').value = item.type; 
            document.getElementById('inYear').value = item.year; document.getElementById('inDeathYear').value = item.deathYear || ""; 
            document.getElementById('inEra').value = item.era; document.getElementById('inName').value = item.name; 
            document.getElementById('inHanja').value = item.hanja || ""; document.getElementById('inTags').value = item.tags ? item.tags.join(", ") : "";
            document.getElementById('inRelations').value = item.relations || ""; 
            document.getElementById('inDesc').value = item.desc; document.getElementById('inImg').value = item.img || "";
            document.getElementById('inCardColor').value = item.cardColor || "#ffffff";
            document.getElementById('inLat').value = item.lat || ""; document.getElementById('inLng').value = item.lng || ""; document.getElementById('inGeoName').value = item.geoName || "";

            const contentBox = document.getElementById('inContent');
            if (item.type === 'poet' && item.poems) {
                contentBox.value = item.poems.map(p => {
                    let text = `${p.title}|${p.content}`;
                    if (p.simplified) text += `\n\n+++\n${p.simplified}`;
                    if (p.desc) text += `\n\n---\n${p.desc}`;
                    return text;
                }).join('\n\n===\n\n');
            } else { contentBox.value = item.historyDetail || ""; }
            editingId = item.id; document.getElementById('btnSave').innerText = "ìˆ˜ì • ì™„ë£Œ"; window.scrollTo(0, 0);
        }

        function saveData() {
            const isShow = document.getElementById('inShow').checked; const type = document.getElementById('inType').value;
            const year = document.getElementById('inYear').value; const deathYear = document.getElementById('inDeathYear').value;
            const era = document.getElementById('inEra').value; const name = document.getElementById('inName').value; const hanja = document.getElementById('inHanja').value;
            const tags = document.getElementById('inTags').value.split(',').map(t=>t.trim()).filter(t=>t);
            const relations = document.getElementById('inRelations').value;
            const desc = document.getElementById('inDesc').value; const img = document.getElementById('inImg').value;
            const cardColor = document.getElementById('inCardColor').value; const rawContent = document.getElementById('inContent').value;
            const lat = document.getElementById('inLat').value; const lng = document.getElementById('inLng').value; const geoName = document.getElementById('inGeoName').value;

            if (!year || !name) { alert('í•„ìˆ˜ í•­ëª© ëˆ„ë½'); return; }
            let poems = []; let historyDetail = "";
            if (type === 'poet' && rawContent.trim()) { 
                const blocks = rawContent.split('==='); 
                poems = blocks.map(b => { 
                    let temp = b; let pDesc = ""; const descParts = temp.split('---');
                    if (descParts.length > 1) { pDesc = descParts.slice(1).join('---').trim(); temp = descParts[0]; }
                    let pSimp = ""; const simpParts = temp.split('+++');
                    if (simpParts.length > 1) { pSimp = simpParts.slice(1).join('+++').trim(); temp = simpParts[0]; }
                    const idx = temp.indexOf('|'); 
                    if (idx !== -1) return { title: temp.substring(0, idx).trim(), content: temp.substring(idx + 1).trim(), simplified: pSimp, desc: pDesc };
                    return null; 
                }).filter(p => p); 
            } else { historyDetail = rawContent.trim(); }
            
            const newData = { id: editingId || Date.now(), year, deathYear, era, type, name, hanja, tags, relations, desc, img, isShow, cardColor, poems, historyDetail, lat, lng, geoName };
            if (editingId) { const idx = db.findIndex(d => d.id === editingId); if (idx !== -1) db[idx] = newData; } else { db.push(newData); }
            saveToLocal(); render(); populateEraFilter(); clearForm();
        }

        function clearForm() {
            document.getElementById('inYear').value = ''; document.getElementById('inDeathYear').value = '';
            document.getElementById('inName').value = ''; document.getElementById('inHanja').value = '';
            document.getElementById('inTags').value = ''; document.getElementById('inRelations').value = '';
            document.getElementById('inDesc').value = ''; document.getElementById('inImg').value = ''; document.getElementById('inContent').value = '';
            document.getElementById('inLat').value = ''; document.getElementById('inLng').value = ''; document.getElementById('inGeoName').value = '';
            document.getElementById('inShow').checked = true; document.getElementById('inCardColor').value = "#ffffff";
            editingId = null; document.getElementById('btnSave').innerText = "ì €ì¥";
        }
        function deleteItem(id) { if(confirm('ì‚­ì œ?')) { db = db.filter(i => i.id !== id); saveToLocal(); render(); populateEraFilter(); } }
        function resetAllData() { if(confirm('ì „ì²´ ì‚­ì œ?')) { localStorage.removeItem('tangTimelineDB'); location.reload(); } }

        function openModal(id, keepHistory = false) {
            const item = db.find(d => d.id === id); if (!item) return;
            if (!keepHistory) { modalHistory = []; document.getElementById('backBtn').style.display = 'none'; }
            currentOpenId = id;
            document.getElementById('floatingCloseBtn').style.display = 'block';
            
            const editBtnHtml = isAdmin ? `<div style="text-align:right; margin-bottom:10px; clear:both;"><span class="btn-text btn-edit" onclick="editItem(${item.id}); closeModal('detailModal');">[ìˆ˜ì •]</span><span class="btn-text btn-del" onclick="deleteItem(${item.id}); closeModal('detailModal');">[ì‚­ì œ]</span></div>` : '';
            
            let nameHtml = `${cleanTitle(item.name)}`;
            if (item.type === 'poet') {
                let subInfo = []; if (item.hanja) subInfo.push(item.hanja);
                if (item.deathYear) subInfo.push(`${item.year}~${item.deathYear}`); else subInfo.push(item.year);
                if (subInfo.length > 0) nameHtml += ` <span style='font-size:0.6em; color:#888; font-weight:normal;'>(${subInfo.join(' ')})</span>`;
            } else { nameHtml += ` <span style='font-size:0.6em; color:#888; font-weight:normal;'>(${item.year})</span>`; }
            
            document.getElementById('mName').innerHTML = nameHtml;
            const tagsHtml = item.tags ? item.tags.map(t => `<span class="tag-badge" onclick="searchTag('${t}'); closeModal('detailModal');">#${t}</span>`).join('') : "";
            document.getElementById('mTags').innerHTML = tagsHtml;
            const mImg = document.getElementById('mImg');
            if(item.img) { mImg.src = item.img; mImg.style.display = 'block'; } else { mImg.style.display = 'none'; }
            document.getElementById('mDesc').innerHTML = editBtnHtml + parseText(item.desc, false);
            
            const mapContainer = document.getElementById('itemMapContainer');
            if (item.lat && item.lng) {
                mapContainer.style.display = 'block';
                if(itemMap) { itemMap.remove(); }
                setTimeout(() => {
                    itemMap = L.map('itemMapContainer').setView([item.lat, item.lng], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(itemMap);
                    L.marker([item.lat, item.lng]).addTo(itemMap).bindPopup(`<b>${item.geoName||item.name}</b>`).openPopup();
                }, 200);
            } else { mapContainer.style.display = 'none'; }

            const area = document.getElementById('mContentArea'); area.innerHTML = '';
            if (item.type === 'poet' && item.poems) {
                item.poems.forEach((p, index) => {
                    const details = document.createElement('details'); details.className = 'outer-details';
                    let body = `<div class="hanja-text">${parseText(p.content, true)}</div>`; 
                    if (p.simplified) body += `<span class="simp-btn" onclick="toggleSimplified('simp_${item.id}_${index}')">ğŸ‡¨ğŸ‡³ ê°„ì²´ì ë³´ê¸°</span><div id="simp_${item.id}_${index}" class="simplified-box"><div style="margin-top:5px;">${parseText(p.simplified, true)}</div></div>`;
                    if(p.desc) body += `<details class="inner-details"><summary class="inner-summary">[í•´ì„¤ ë³´ê¸°]</summary><div class="explain-text">${parseText(p.desc, false)}</div></details>`; 
                    details.innerHTML = `<summary class="outer-summary">${cleanTitle(p.title)}</summary><div class="poem-body">${body}</div>`;
                    area.appendChild(details);
                });
            } else if (item.historyDetail) { area.innerHTML = `<div class="poem-body">${parseText(item.historyDetail, false)}</div>`; }
            document.getElementById('detailModal').style.display = "block";
        }

        function openStatModal() {
            const totalCards = db.length; 
            const stats = {}; let totalPoems = 0;
            db.forEach(item => {
                if (item.type === 'poet' && item.poems) {
                    const key = cleanTitle(item.name);
                    const count = item.poems.length;
                    stats[key] = (stats[key] || 0) + count;
                    totalPoems += count;
                }
            });
            const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            let html = `<table class="stat-table"><tr><th>ì´ ë°ì´í„°(ì¹´ë“œ)</th><td>${totalCards}ê°œ</td></tr><tr><th>ìˆ˜ë¡ëœ ì‘í’ˆ ìˆ˜</th><td>${totalPoems}ìˆ˜</td></tr><tr><th colspan="2" style="text-align:center; background:#eee;">ğŸ† ì¸ë¬¼ë³„ ì‘í’ˆ ìˆ˜ ë­í‚¹</th></tr></table><div class="stat-scroll-box"><table class="stat-rank-table">`;
            sortedStats.forEach((entry, index) => { html += `<tr><td class="rank-num">${index + 1}</td><td>${entry[0]}</td><td style="text-align:right; font-weight:bold;">${entry[1]}ìˆ˜</td></tr>`; });
            if (sortedStats.length === 0) html += `<tr><td colspan="3" style="text-align:center; padding:20px;">ì§‘ê³„ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            html += `</table></div>`;
            document.getElementById('statContent').innerHTML = html; document.getElementById('statModal').style.display = 'block';
        }

        function openContextModal(targetId) {
            const targetItem = db.find(d => d.id === targetId); if (!targetItem) return;
            const idx = db.findIndex(d => d.id === targetId);
            document.getElementById('ctxTargetYear').innerText = targetItem.year;
            const siblings = db.slice(Math.max(0, idx - 5), Math.min(db.length, idx + 6));
            const list = document.getElementById('ctxList'); list.innerHTML = '';
            siblings.forEach(item => {
                const li = document.createElement('li'); const isMinor = !item.isShow;
                li.className = `ctx-item ${item.id === targetId ? 'current' : ''} ${isMinor ? 'minor' : ''}`;
                li.onclick = () => { closeModal('contextModal'); openModal(item.id); };
                li.innerHTML = `<div class="ctx-year">${item.year}</div><div class="ctx-info"><div class="ctx-name">${item.name}</div><span class="ctx-desc">${item.desc.substring(0, 40)}...</span></div>`;
                list.appendChild(li);
            });
            document.getElementById('contextModal').style.display = "block";
        }
        function openModalByName(name) {
            const item = db.find(d => cleanTitle(d.name) === name.trim());
            if(item) { if(currentOpenId) modalHistory.push(currentOpenId); document.getElementById('backBtn').style.display='block'; openModal(item.id); }
            else alert("DBì— ì—†ëŠ” ì¸ë¬¼ì…ë‹ˆë‹¤.");
        }
        function closeModal(id) { document.getElementById(id).style.display = "none"; document.getElementById('floatingCloseBtn').style.display = 'none'; }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) { e.target.style.display="none"; document.getElementById('floatingCloseBtn').style.display = 'none'; } }
        
        init();
    </script>
</body>
</html>
