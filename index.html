<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ íƒ€ì„ë¼ì¸ DB</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=KoPub+Batang:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        * { box-sizing: border-box !important; }
        :root { --line-color: #8B0000; --text-color: #333; --bg-color: #fdfbf7; }
        body { font-family: 'KoPub Batang', 'Noto Serif KR', serif; color: var(--text-color); margin: 0; padding: 0; background-color: var(--bg-color); transition: background 0.3s; }
        
        /* [í—¤ë”] */
        #stickyHeader { position: -webkit-sticky; position: sticky; top: 0; z-index: 1000; background-color: var(--bg-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding-top: 20px; transition: background 0.3s; }
        header { text-align: center; margin-bottom: 10px; padding: 0 20px;}
        h1 { color: var(--line-color); margin: 0 0 5px 0; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); }
        .page-desc { color: #555; font-size: 0.95rem; margin-bottom: 15px; font-weight: bold; }
        
        /* ê²€ìƒ‰ì°½ */
        .search-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; position: relative; }
        .search-wrapper { position: relative; display: inline-block; }
        .search-input { padding: 8px 30px 8px 15px; border: 2px solid var(--line-color); border-radius: 20px; width: 250px; outline: none; }
        .search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-weight: bold; display: none; }
        .search-clear:hover { color: red; }

        .filter-select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-common { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: transform 0.1s;}
        .btn-common:active { transform: scale(0.95); }
        .btn-map { background: #007bff; } .btn-rel { background: #6f42c1; }

        .timeline-headers { position: relative; max-width: 1000px; width: 100%; height: 60px; margin: 0 auto; padding-bottom: 15px; }
        #badgeLeft, #badgeRight { position: absolute; top: 0; display: inline-block; padding: 12px 0; width: 160px; border-radius: 15px; font-weight: bold; font-size: 1.2rem; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); text-align: center; background-color: #fff; }
        #badgeLeft { right: 50%; margin-right: 50px; } #badgeRight { left: 50%; margin-left: 50px; }

        /* [íƒ€ì„ë¼ì¸] */
        .timeline { position: relative; max-width: 1000px; margin: 0 auto; padding-bottom: 80px; padding-top: 20px; }
        .timeline::after { content: ''; position: absolute; width: 4px; background-color: var(--line-color); top: 0; bottom: 0; left: 50%; margin-left: -2px; z-index: 0; }
        .container { padding: 10px 50px; position: relative; width: 50%; }
        .left { left: 0; text-align: right; } .right { left: 50%; text-align: left; }
        
        /* [ì¹´ë“œ ìŠ¤íƒ€ì¼] */
        .content { 
            padding: 20px; position: relative; border-radius: 8px; 
            border: 1px solid rgba(0,0,0,0.05); box-shadow: 2px 2px 5px rgba(0,0,0,0.05); 
            background: white; text-align: left;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
            transform-origin: center center; overflow: hidden; cursor: pointer;
        }
        .left .content { text-align: right; }
        .content.active { transform: scale(1.1); box-shadow: 0 10px 25px rgba(139, 0, 0, 0.15); z-index: 50; border-color: rgba(139,0,0,0.2); }
        .content:hover, .content.active:hover { transform: scale(1.2) !important; box-shadow: 0 15px 30px rgba(0,0,0,0.2) !important; z-index: 100 !important; }
        
        .thumb-img { float: left; margin-right: 15px; margin-bottom: 5px; width: 120px; height: 120px; border-radius: 5px; border: 1px solid #ddd; padding: 2px; background: #fff; object-fit: cover; }
        
        .title-text { font-size: 1.4em; font-weight: bold; color: #000; display: inline; line-height: 1.3; }
        .title-text:hover { color: var(--line-color); text-decoration: underline; }
        .era-tag { font-size: 0.8em; color: #666; font-weight:bold; display: inline-block; margin-right: 5px; vertical-align: middle;}
        .tag-container { margin-bottom: 8px; line-height: 1.4; display: block; margin-top: 5px;}
        .tag-badge { display: inline-block; font-size: 0.75rem; background: #eef; color: #0044cc; padding: 1px 6px; border-radius: 3px; margin-right: 3px; }
        .desc-text { font-size: 0.95rem; color: #444; line-height: 1.6; display: block; margin-top: 5px;}

        .action-btns { clear: both; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #eee; text-align: right; font-size: 0.85rem; display: none; }
        .btn-text { cursor: pointer; text-decoration: underline; margin-left: 10px; font-weight: bold; }
        .btn-edit { color: var(--edit-color); } .btn-del { color: #dc3545; }

        .year-bubble { position: absolute; width: 50px; height: 50px; background-color: white; border: 3px solid var(--line-color); border-radius: 50%; z-index: 20; text-align: center; line-height: 50px; font-weight: bold; font-size: 13px; color: var(--line-color); top: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background:#fff; }
        .year-bubble:hover { background-color: var(--line-color); color: white; transform: scale(1.1); }
        .left .year-bubble { right: -25px; } .right .year-bubble { left: -25px; }
        
        .minor-row { width: 100%; height: 20px; position: relative; margin: 5px 0; }
        .minor-dot { position: absolute; left: 50%; margin-left: -6px; width: 12px; height: 12px; background-color: white; border: 2px solid #aaa; border-radius: 50%; cursor: pointer; z-index: 5; transition: all 0.2s; }
        .minor-dot:hover { background-color: #0056b3; transform: scale(1.5); }
        .minor-dot::before { content: attr(data-tooltip); position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .minor-dot:hover::before { opacity: 1; }

        /* [ê´€ë¦¬ì íŒ¨ë„] */
        .admin-btn { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #333; color: white; border: none; cursor: pointer; z-index: 2000; border-radius: 5px; display: none; }
        .login-trigger { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; font-size: 12px; cursor: pointer; z-index: 2000;}
        #adminPanel { display: none; position: fixed; top: 60px; right: 20px; width: 500px; background: white; border: 2px solid #333; padding: 20px; z-index: 2100; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; font-family: sans-serif; border-radius: 8px;}
        .form-group { margin-bottom: 10px; } .form-group label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 4px;}
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; font-size: 14px; border-radius: 4px; }
        textarea { resize: vertical; } input[type="color"] { padding: 0; height: 35px; cursor: pointer;}
        
        .syntax-guide { font-size: 11px; color: #555; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; line-height: 1.5; }
        .syntax-guide code { background: #fff; border: 1px solid #ccc; padding: 1px 4px; border-radius: 3px; color: #d63384; font-family: monospace; font-weight: bold; }
        .tool-btn { color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 3px; margin-bottom: 3px; }
        .btn-green { background-color: #28a745; } .btn-blue { background-color: #007bff; } .btn-purple { background-color: #6f42c1; } .btn-orange { background-color: #fd7e14; }

        .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .admin-actions button, .admin-actions label { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; font-size: 14px; }
        .btn-save { background: #218838; color: white; grid-column: span 1; }
        .btn-cancel { background: #666; color: white; grid-column: span 1; }
        .btn-down { background: #007bff; color: white; }
        .btn-up { background: #17a2b8; color: white; display: block; box-sizing: border-box; margin:0;}
        .btn-reset { background: #dc3545; color: white; grid-column: span 2; margin-top: 5px;}

        /* [ëª¨ë‹¬] */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 2% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; position: sticky; top: 0; right: 0; z-index: 10; background: rgba(255,255,255,0.9); padding: 0 10px; border-radius: 5px;}
        #floatingCloseBtn { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 3000; background-color: rgba(0, 0, 0, 0.75); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .back-btn { display: none; float: left; background: #eee; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #333; }
        
        /* [ê°œì„ ëœ íƒ€ì„ë¼ì¸ ë¬¸ë§¥ íŒì—… ìŠ¤íƒ€ì¼] */
        #contextModal .modal-content { max-width: 600px; background: #fdfbf7; padding: 25px; border-radius: 15px; }
        .ctx-list { list-style: none; padding: 0; margin-top: 20px; }
        .ctx-item { 
            padding: 15px; margin-bottom: 10px;
            background: white; border-radius: 10px; border: 1px solid #eee;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; cursor: pointer;
            transition: all 0.2s ease;
        }
        .ctx-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: var(--line-color); z-index:10; }
        .ctx-item.current { border: 2px solid var(--line-color); background: #fff0f0; }
        .ctx-item.minor { opacity: 0.8; background: #fafafa; }
        .ctx-year { font-weight: bold; color: var(--line-color); width: 80px; font-size: 1.3em; text-align: center; border-right: 2px solid #eee; margin-right: 15px; }
        .ctx-info { flex: 1; } 
        .ctx-name { font-weight: bold; font-size: 1.15em; color: #333; margin-bottom: 5px; display: block;} 
        .ctx-desc { font-size: 0.9em; color: #666; display: block; line-height: 1.4;}

        /* [ê¸°íƒ€] */
        .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem;}
        .stat-table th, .stat-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .stat-table th { background-color: #f2f2f2; font-weight: bold; }
        #network { width: 100%; height: 600px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }
        #map { width: 100%; height: 500px; border-radius: 8px; border: 2px solid #333; }
        #miniMapWrapper { width: 100%; margin: 15px 0; display: none; }
        #miniMap { width: 100%; height: 200px; border-radius: 8px; border: 1px solid #ccc; }
        #miniMapCaption { text-align: center; font-size: 0.85rem; color: #666; margin-top: 5px; font-weight: bold; }
        #relContainer { text-align:center; margin-top:10px; }
        .rel-badge { display:inline-block; padding: 5px 10px; margin: 3px; border: 1px solid #ccc; background: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        .rel-badge:hover { background: #eef; transform: scale(1.05); }
        
        .img-card-figure { display: block; margin: 15px auto; text-align: center; max-width: 90%; border: 1px solid #eee; padding: 5px; background: #fff; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .img-card-figure img { max-width: 100%; display: block; margin: 0 auto; border-radius: 3px; }
        .img-card-figure figcaption { font-size: 0.85em; color: #666; margin-top: 5px; font-weight: bold; }
        .source-credit { margin-top: 20px; text-align: right; border-top: 1px dashed #ddd; padding-top: 10px; font-size: 0.85rem; color: #666; display: block; }
        .source-credit img { vertical-align: middle; margin-right: 5px; max-height: 18px; margin-bottom: 2px; }
        .source-credit a { text-decoration: none; color: #555; font-weight: bold; border-bottom: 1px dotted #999; }
        
        .tag-cloud-box { background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center; line-height: 1.8; }
        .tag-cloud-item { display: inline-block; margin: 0 5px; cursor: pointer; color: #555; transition: all 0.2s; text-decoration: none; }
        .tag-cloud-item:hover { color: var(--line-color); transform: scale(1.2); text-decoration: underline; }
        
        .wiki-link { color: #d63384; font-weight: bold; cursor: pointer; border-bottom: 1px dotted #d63384; }
        .poem-body { padding: 15px; white-space: pre-wrap; line-height: 2.2; color: #444; border-top: 1px solid #eee; }
        .hanja-text { font-size: 1.2rem; color: #222; margin-bottom: 5px; font-family: 'KoPub Batang', serif; }
        ruby { display: inline-block; text-align: center; margin: 0 2px; ruby-position: under; }
        rt { font-size: 0.6em; color: #777; font-family: sans-serif; }
        details.inner-details { border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 10px; line-height: 1.6;}
        summary.outer-summary { padding: 10px; cursor: pointer; background: #f9f9f9; font-weight: bold; list-style: none; }

        /* [í¬ë¡­ ëª¨ë‹¬] */
        #cropperModal { display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); }
        .crop-container { width:90%; height:70vh; margin:5vh auto; background:#000; }
        .crop-controls { text-align:center; margin-top:10px; }
        .crop-btn { padding:10px 20px; font-size:16px; background:white; border:none; cursor:pointer; margin:0 5px; border-radius:5px;}

        @media (max-width: 768px) {
            .timeline-headers { display: flex; height: auto; padding: 0 10px; }
            #badgeLeft, #badgeRight { position: static; width: 48%; margin: 0 1%; padding: 10px 0; font-size: 1rem; }
            .container { padding: 10px 30px; } .thumb-img { display:none; }
        }
    </style>
</head>
<body>
    <div id="stickyHeader">
        <header>
            <h1 id="pageTitle">ë‚˜ë§Œì˜ ì—­ì‚¬ ì—°í‘œ</h1>
            <p id="pageDesc" class="page-desc">ë¡œë”© ì¤‘...</p>
            <div class="search-bar">
                <div class="search-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="ì´ë¦„, ë‚´ìš©, íƒœê·¸ ê²€ìƒ‰..." onkeyup="filterData()">
                    <span id="clearSearchBtn" class="search-clear" onclick="clearSearch()">âœ–</span>
                </div>
                <select id="eraFilter" class="filter-select" onchange="filterData()"> <option value="all">ëª¨ë“  ì‹œëŒ€</option> </select>
                <button class="btn-common btn-rel" onclick="openRelModal()">ğŸ•¸ï¸ ê´€ê³„ë„</button>
                <button class="btn-common btn-map" onclick="openMapModal()">ğŸ—ºï¸ ì§€ë„</button>
                <button class="btn-common" onclick="openStatModal()">ğŸ“Š í†µê³„</button>
                <button class="btn-common" style="background:#333" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </header>
        <div class="timeline-headers"><span class="header-badge" id="badgeLeft">Label Left</span><span class="header-badge" id="badgeRight">Label Right</span></div>
    </div>

    <button id="floatingCloseBtn" onclick="closeModal('detailModal')">âŒ ë‹«ê¸°</button>
    <button id="adminToggle" class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬/ì„¤ì •</button>

    <div id="adminPanel">
        <div class="config-section">
            <button class="config-toggle" onclick="toggleConfig()">ğŸ› ï¸ ë””ìì¸ ë° ì„¤ì • (í¼ì¹˜ê¸°)</button>
            <div id="configForm" style="display:none; margin-top:10px;">
                <div class="form-group"><label>ë©”ì¸ ì œëª©</label> <input type="text" id="cfgTitle"></div>
                <div class="form-group"><label>ì•ˆë‚´ ë¬¸êµ¬</label> <textarea id="cfgDesc" rows="2"></textarea></div>
                <div class="form-group"><label>ë°”ë‹¥ê¸€(Copyright)</label> <input type="text" id="cfgCopyright"></div>
                <div class="form-group" style="display:flex; gap:5px;"><div style="flex:1"><label>ì™¼ìª½ ì´ë¦„</label><input type="text" id="cfgLabelLeft"></div><div style="flex:1"><label>ì˜¤ë¥¸ìª½ ì´ë¦„</label><input type="text" id="cfgLabelRight"></div></div>
                <div class="form-group"><label>ë°°ê²½ìƒ‰/ì´ë¯¸ì§€</label> <div style="display:flex; gap:5px;"><input type="color" id="cfgBgColor"><input type="text" id="cfgBgImage" placeholder="ì´ë¯¸ì§€URL" style="flex:1;"></div></div>
                <div class="form-group"><label>ì¢Œìš°ì¸¡ ì¹´ë“œìƒ‰</label> <div style="display:flex; gap:5px;"><input type="color" id="cfgLeftColor"><input type="color" id="cfgRightColor"></div></div>
                <button class="btn-save" style="width:100%" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            </div>
        </div>
        
        <h3 style="margin-top:20px; border-top:2px solid #333; padding-top:10px; margin-bottom:10px;">ë°ì´í„° ì…ë ¥</h3>
        <div class="form-group" style="background:#fff3cd; padding:8px; border-radius:5px;"><label>ğŸ¨ ê°œë³„ ê°•ì¡°ìƒ‰ (í°ìƒ‰=ìë™)</label><input type="color" id="inCardColor" value="#ffffff" style="width:100%;"></div>
        <div class="form-group"><label><input type="checkbox" id="inShow" checked> <strong>í¬ê²Œ ë³´ì´ê¸° (ì²´í¬í•´ì œì‹œ ê´€ê³„ë„ ì œì™¸)</strong></label></div>
        
        <div class="form-group" style="background:#e8f5e9; padding:10px; border-radius:5px;">
             <label>ğŸ“ ì§€ë„ ìœ„ì¹˜</label>
             <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" id="inLocationSearch" placeholder="ì¢Œí‘œ ê²€ìƒ‰ (ì˜ˆ: Xi'an)" style="flex:1;"><button type="button" onclick="searchLocation()" style="background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ”</button></div>
             <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="number" id="inLat" placeholder="ìœ„ë„" style="flex:1;"><input type="number" id="inLng" placeholder="ê²½ë„" style="flex:1;"></div>
             <div style="display:flex; gap:5px;"><input type="text" id="inGeoName" placeholder="ì¥ì†Œëª…" style="flex:1;"><input type="text" id="inGeoDesc" placeholder="ì§€ë„ì„¤ëª…" style="flex:1;"></div>
        </div>

        <div class="form-group"><select id="inType" onchange="updateFormUI()"><option value="poet" id="optLeft">ì™¼ìª½</option><option value="history" id="optRight">ì˜¤ë¥¸ìª½</option></select></div>
        <div class="form-group">
            <label id="lblYear">ì—°ë„</label>
            <div style="display:flex; gap:5px;"><input type="number" id="inYear" placeholder="ì‹œì‘/ì¶œìƒ" style="flex:1;" oninput="detectEra()"><input type="number" id="inDeathYear" placeholder="ì‚¬ë§" style="flex:1; display:none;"><input type="text" id="inEra" placeholder="ì‹œëŒ€(ìë™)" style="flex:1;"></div>
            <div id="eraHint" style="font-size:0.8rem; color:#d63384; margin-top:5px; min-height:20px;"></div>
        </div>
        
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <div style="flex:1"><label>ì œëª© (í•œê¸€)</label><input type="text" id="inName"></div>
            <div style="flex:1" id="divHanja"><label>í•œì ì´ë¦„</label><input type="text" id="inHanja" placeholder="æç™½"></div>
        </div>

        <div class="form-group"><input type="text" id="inRelations" placeholder="ê´€ê³„ (ì´ë¦„:ê´€ê³„, ...)"></div>
        <div class="form-group"><input type="text" id="inTags" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)"></div>
        <div class="form-group"><textarea id="inDesc" rows="3" placeholder="ìš”ì•½"></textarea></div>
        
        <div class="form-group">
            <label>ì´ë¯¸ì§€</label>
            <input type="text" id="inImg" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ (URL)">
            <div style="margin-top:5px; display:flex; gap:5px; align-items:center;">
                <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImageSelect(this)">
                <button type="button" onclick="document.getElementById('imgInput').click()" style="background:#666; color:white; border:none; padding:6px 10px; cursor:pointer; border-radius:3px;">ğŸ“ ë‚´ PC ì‚¬ì§„ ì„ íƒ</button>
                <div id="imgPreview" style="width:40px; height:40px; border:1px solid #ccc; background-size:cover; border-radius:50%; display:none;"></div>
            </div>
        </div>

        <div class="form-group">
            <label style="margin-bottom:5px; display:block;">ìƒì„¸ ë‚´ìš© (ë„êµ¬)</label>
            <div style="margin-bottom:5px;">
                <button class="tool-btn btn-green" onclick="autoPinyin()">ë³‘ìŒ</button> 
                <button class="tool-btn btn-blue" onclick="autoTone()">í‰ì¸¡</button> 
                <button class="tool-btn btn-orange" onclick="insertAudio()">ì˜¤ë””ì˜¤</button> 
                <button class="tool-btn btn-blue" onclick="insertImageTag()">ğŸ–¼ï¸ì´ë¯¸ì§€íƒœê·¸</button> 
                <button class="tool-btn btn-purple" onclick="insertLicense()">ì¶œì²˜</button>
            </div>
            <div class="syntax-guide">
                <code>[ê¸€ì](ì£¼ì†Œ)</code> (ë§í¬) &nbsp; <code>{{ì´ë¯¸ì§€|ì£¼ì†Œ|ì„¤ëª…}}</code><br>
                <code>ì œëª© | ë‚´ìš©</code> (ì²«ì¤„) &nbsp; <code>---</code> (í•´ì„¤) &nbsp; <code>===</code> (êµ¬ë¶„)<br>
                <code>### ë‚´ìš© ###</code> (ì¶œì²˜) &nbsp; <code>%%ê°•ì¡°%%</code> &nbsp; <code>$$ì´íƒ¤ë¦­$$</code>
            </div>
            <textarea id="inContent" rows="10" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>

        <div class="admin-actions">
            <button id="btnSave" class="btn-save" onclick="saveData()">ì €ì¥</button>
            <button class="btn-cancel" onclick="clearForm()">ì·¨ì†Œ</button>
            <button class="btn-down" onclick="exportData()">ğŸ’¾ DB ë‹¤ìš´ë¡œë“œ</button>
            <label for="fileInput" class="btn-up">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</label>
            <input type="file" id="fileInput" onchange="importData(this)" style="display:none;">
            <button class="btn-reset" onclick="resetAllData()">âš ï¸ ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>
    
    <div class="timeline" id="timeline-root"></div>
    <footer id="pageFooter"></footer>
    <div class="login-trigger" onclick="adminLogin()">Admin</div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button class="back-btn" id="backBtn" onclick="goBack()">â¬… ë’¤ë¡œ</button><span class="close" onclick="closeModal('detailModal')">&times;</span><div style="clear:both;"></div>
            <h2 id="mName" style="text-align:center;"></h2><div id="mTags" style="text-align:center; margin-bottom:10px;"></div>
            
            <div id="mDesc" style="background:#f5f5f5; padding:15px; border-radius:5px; white-space: pre-wrap;"></div>
            
            <div id="miniMapWrapper"><div id="miniMap"></div><div id="miniMapCaption"></div><div id="relContainer"></div></div><hr><div id="mContentArea"></div>
        </div>
    </div>
    
    <div id="contextModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('contextModal')">&times;</span><h3 style="text-align:center; border-bottom:2px solid #8B0000; padding-bottom:15px; margin-bottom:15px;">âŒ› <span id="ctxTargetYear"></span>ë…„ íƒ€ì„ë¼ì¸</h3><ul id="ctxList" class="ctx-list"></ul></div></div>
    
    <div id="statModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('statModal')">&times;</span><h3>ğŸ“Š ë°ì´í„° í†µê³„</h3><div id="statContent"></div></div></div>
    <div id="mapModal" class="modal"><div class="modal-content" style="max-width: 900px;"><span class="close" onclick="closeModal('mapModal')">&times;</span><h3>ğŸ—ºï¸ ì—­ì‚¬ ì§€ë„</h3><div id="map"></div></div></div>
    <div id="relModal" class="modal"><div class="modal-content" style="max-width: 1000px;"><span class="close" onclick="closeModal('relModal')">&times;</span><h3>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ë„</h3><div id="network"></div></div></div>
    <div id="cropperModal"><div class="crop-container"><div style="height:80%;"><img id="cropImage" style="max-width:100%;"></div><div class="crop-controls"><button class="crop-btn" onclick="performCrop()">âœ‚ï¸ ìë¥´ê¸° & ì €ì¥</button><button class="crop-btn" onclick="document.getElementById('cropperModal').style.display='none'">ì·¨ì†Œ</button></div></div></div>

    <script>
        const defaultConfig = { title: "ë‹¹ë‚˜ë¼ ì—­ì‚¬ì™€ ì‹œì¸ ì—°í‘œ", desc: "ë‚˜ë§Œì˜ ì—­ì‚¬ ë°ì´í„°ë² ì´ìŠ¤", leftLabel: "ì‹œì¸ / ì‘í’ˆ", rightLabel: "ì—­ì‚¬ / ì‚¬ê±´", bgColor: "#fdfbf7", bgImage: "", bgRepeat: "repeat", leftCardColor: "#ffffff", rightCardColor: "#ffffff", copyright: "" };
        let db=[], config={}, editingId=null, modalHistory=[], currentOpenId=null;
        let isAdmin = false; 
        let map = null; let markersLayer = null; let miniMap = null; let cropper = null; 

        const eraTheme = { "ì´ˆë‹¹": "#f1f8e9", "ì„±ë‹¹": "#fff8e1", "ì¤‘ë‹¹": "#e3f2fd", "ë§Œë‹¹": "#f3e5f5", "ì˜¤ëŒ€": "#eceff1", "ìˆ˜ë‚˜ë¼": "#e0f2f1" };
        const eraMap = { "ì´ˆë‹¹": "ì´ˆë‹¹(åˆå”)", "ì„±ë‹¹": "ì„±ë‹¹(ç››å”)", "ì¤‘ë‹¹": "ì¤‘ë‹¹(ä¸­å”)", "ë§Œë‹¹": "ë§Œë‹¹(æ™šå”)", "ì˜¤ëŒ€": "ì˜¤ëŒ€(äº”ä»£)", "ìˆ˜ë‚˜ë¼": "ìˆ˜(éš‹)" };
        const tangChronology = [
            { start: 581, end: 617, era: "ìˆ˜ë‚˜ë¼", emperor: "ë¬¸ì œ/ì–‘ì œ", reign: "" },
            { start: 618, end: 626, era: "ì´ˆë‹¹", emperor: "ê³ ì¡°", reign: "ë¬´ë•" },
            { start: 627, end: 649, era: "ì´ˆë‹¹", emperor: "íƒœì¢…", reign: "ì •ê´€" },
            { start: 650, end: 683, era: "ì´ˆë‹¹", emperor: "ê³ ì¢…", reign: "ì˜íœ˜/í˜„ê²½/ì˜ë´‰" },
            { start: 684, end: 704, era: "ì´ˆë‹¹", emperor: "ì¸¡ì²œë¬´í›„", reign: "ì²œìˆ˜/ì¥ìˆ˜" },
            { start: 705, end: 709, era: "ì´ˆë‹¹", emperor: "ì¤‘ì¢…", reign: "ì‹ ë£¡/ê²½ë£¡" },
            { start: 710, end: 712, era: "ì´ˆë‹¹", emperor: "ì˜ˆì¢…", reign: "ê²½ìš´/íƒœê·¹" },
            { start: 712, end: 741, era: "ì„±ë‹¹", emperor: "í˜„ì¢…", reign: "ê°œì›" },
            { start: 742, end: 755, era: "ì„±ë‹¹", emperor: "í˜„ì¢…", reign: "ì²œë³´" },
            { start: 756, end: 762, era: "ì¤‘ë‹¹", emperor: "ìˆ™ì¢…", reign: "ì§€ë•/ê±´ì›" },
            { start: 763, end: 779, era: "ì¤‘ë‹¹", emperor: "ëŒ€ì¢…", reign: "ê´‘ë•/ëŒ€ë ¥" },
            { start: 780, end: 804, era: "ì¤‘ë‹¹", emperor: "ë•ì¢…", reign: "ê±´ì¤‘/ì •ì›" },
            { start: 806, end: 820, era: "ì¤‘ë‹¹", emperor: "í—Œì¢…", reign: "ì›í™”" },
            { start: 821, end: 824, era: "ì¤‘ë‹¹", emperor: "ëª©ì¢…", reign: "ì¥ê²½" },
            { start: 827, end: 840, era: "ë§Œë‹¹", emperor: "ë¬¸ì¢…", reign: "ëŒ€í™”/ê°œì„±" },
            { start: 841, end: 846, era: "ë§Œë‹¹", emperor: "ë¬´ì¢…", reign: "íšŒì°½" },
            { start: 847, end: 859, era: "ë§Œë‹¹", emperor: "ì„ ì¢…", reign: "ëŒ€ì¤‘" },
            { start: 860, end: 873, era: "ë§Œë‹¹", emperor: "ì˜ì¢…", reign: "í•¨í†µ" },
            { start: 874, end: 888, era: "ë§Œë‹¹", emperor: "í¬ì¢…", reign: "ê±´ë¶€/ê´‘ëª…" },
            { start: 889, end: 904, era: "ë§Œë‹¹", emperor: "ì†Œì¢…", reign: "ëŒ€ìˆœ/ì²œìš°" },
            { start: 905, end: 907, era: "ë§Œë‹¹", emperor: "ì• ì œ", reign: "ì²œìš°" }
        ];

        async function init() {
            try {
                try { const r = await fetch('database.json'); if(r.ok) { const j = await r.json(); db = j.data || []; config = j.config || defaultConfig; } else throw new Error("No ext DB"); } 
                catch (e) { const s = localStorage.getItem('tangTimelineDB'); db = s ? JSON.parse(s) : []; const c = localStorage.getItem('tangTimelineConfig'); config = c ? JSON.parse(c) : {...defaultConfig}; }
                applyConfigUI(); populateEraFilter(); render();
                document.getElementById('pageDesc').innerText = config.desc; document.getElementById('adminToggle').style.display = 'none';
                adjustPadding(); window.addEventListener('resize', adjustPadding);
            } catch (e) { 
                console.error(e);
                render(); 
            }
        }

        function adjustPadding() { document.getElementById('timeline-root').style.paddingTop = '20px'; }
        function setupScrollAnimation() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const c = entry.target.querySelector('.content');
                    if (c) { if (entry.isIntersecting) c.classList.add('active'); else c.classList.remove('active'); }
                });
            }, { root: null, rootMargin: "-45% 0px -45% 0px", threshold: 0 });
            document.querySelectorAll('.container').forEach(el => observer.observe(el));
        }

        async function adminLogin() {
            if (isAdmin) return;
            const p = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (!p) return;
            const h = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p)))).map(b => b.toString(16).padStart(2, '0')).join('');
            if (h === "6eb20c53054a7218e6731761b7539d9e38f6f5e39e53c2d78e0edd732de650f2") { isAdmin = true; document.getElementById('adminToggle').style.display = 'block'; alert("ê´€ë¦¬ì ëª¨ë“œ"); render(); } else alert("ì˜¤ë¥˜");
        }

        function saveToLocal() { db.sort((a, b) => a.year - b.year); localStorage.setItem('tangTimelineDB', JSON.stringify(db)); }
        function exportData() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ data: db, config: config })); const n = document.createElement('a'); n.href = d; n.download = "database.json"; document.body.appendChild(n); n.click(); n.remove(); }
        function importData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(e) { const l = JSON.parse(e.target.result); if(l.data) { db = l.data; config = l.config || defaultConfig; } else db = l; saveToLocal(); applyConfigUI(); alert('ì™„ë£Œ'); }; r.readAsText(f); }

        function autoPinyin() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'symbol', nonZh: 'consecutive' }); i.setRangeText(t.map(x => x.isZh ? `${x.origin}(${x.pinyin})` : x.origin).join('')); }
        function autoTone() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'num', nonZh: 'consecutive' }); i.setRangeText(t.map(x => { if (!x.isZh) return x.origin; return `${x.origin}(${/[34]$/.test(x.pinyin)?'â—':'â—‹'})`; }).join('')); }
        
        function insertLicense() {
            const choice = prompt("1.ë™ì–‘ê³ ì „ì¢…í•©DB 2.ë‚˜ë¬´ìœ„í‚¤ 3.ìœ„í‚¤ë°±ê³¼");
            if (!choice) return;
            let html = "";
            if (choice === '1') html = "ìë£Œì¶œì²˜: <a href='http://db.cyberseodang.or.kr' target='_blank'><img src='http://db.cyberseodang.or.kr/images/front/logo_b.png'> ë™ì–‘ê³ ì „ì¢…í•©DB</a>";
            else if (choice === '2') html = "ì¶œì²˜: <a href='https://namu.wiki' target='_blank'>ë‚˜ë¬´ìœ„í‚¤</a> (CC BY-NC-SA 2.0 KR)";
            else if (choice === '3') html = "ì¶œì²˜: <a href='https://ko.wikipedia.org' target='_blank'>ìœ„í‚¤ë°±ê³¼</a> (CC BY-SA 3.0)";
            else return;
            const input = document.getElementById('inContent');
            const insertText = `\n### ${html} ###`;
            if (input.selectionStart || input.selectionStart == '0') {
                const startPos = input.selectionStart; const endPos = input.selectionEnd;
                input.value = input.value.substring(0, startPos) + insertText + input.value.substring(endPos, input.value.length);
            } else { input.value += insertText; }
        }

        function insertAudio() { let u = prompt("ì˜¤ë””ì˜¤ URL (íŒŒì¼ëª…ë§Œ ì…ë ¥í•˜ë©´ ìë™ê²½ë¡œ)"); if(u) { if(!u.startsWith('http')) u='https://tangshi.kr/mp3/'+u; document.getElementById('inContent').setRangeText(`{{ì˜¤ë””ì˜¤|${u}}}`); } }
        
        function insertImageTag() {
            const url = prompt("ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if(!url) return;
            const cap = prompt("ì„¤ëª…(ìº¡ì…˜)ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ):");
            document.getElementById('inContent').setRangeText(`{{ì´ë¯¸ì§€|${url}|${cap||''}}}`);
        }

        function cleanTitle(t) { return t ? t.replace(/\[.*?\]/g, '').trim() : ""; }
        function cleanTextForCard(t) { 
            if(!t) return ""; 
            // ì•ˆì „ì¥ì¹˜: ìˆ«ìê°€ ë“¤ì–´ì™€ë„ ë¬¸ìì—´ë¡œ ë³€í™˜
            t = String(t);
            return t.replace(/\{\{.*?\}\}/g, '').replace(/###.*?###/g, '').replace(/%%(.*?)%%/g, '$1').replace(/\$\$(.*?)\$\$/g, '$1').substring(0, 40)+"..."; 
        }
        
        function parseText(t, m=false) { 
            if(!t) return ""; 
            // ì•ˆì „ì¥ì¹˜: ìˆ«ìê°€ ë“¤ì–´ì™€ë„ ë¬¸ìì—´ë¡œ ë³€í™˜
            t = String(t);
            if(m) t = t.replace(/([\u4E00-\u9FFF])\(([^)]+)\)/g, "<ruby>$1<rt>$2</rt></ruby>"); 
            return t.replace(/\{\{ì´ë¯¸ì§€\|(.*?)\|(.*?)\}\}/g, '<figure class="img-card-figure"><img src="$1"><figcaption>$2</figcaption></figure>')
                    .replace(/%%(.*?)%%/g, '<b>$1</b>')
                    .replace(/\$\$(.*?)\$\$/g, '<span style="color:#888;font-style:italic;">$1</span>')
                    .replace(/\{\{ì˜¤ë””ì˜¤\|(.*?)\}\}/g, '<audio controls src="$1" style="width:100%;margin-top:10px;"></audio>')
                    .replace(/###(.*?)###/g, '<div class="source-credit">$1</div>')
                    .replace(/\[\[(.*?)\]\]/g, '<span class="wiki-link" onclick="openModalByName(\'$1\')">$1</span>'); 
        }

        async function searchLocation() {
            const q = document.getElementById('inLocationSearch').value; if(!q) return;
            try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`); const j = await r.json(); if(j.length>0) { document.getElementById('inLat').value = parseFloat(j[0].lat).toFixed(4); document.getElementById('inLng').value = parseFloat(j[0].lon).toFixed(4); alert("ë°œê²¬: "+j[0].display_name); } else alert("ì‹¤íŒ¨"); } catch(e){alert("ì˜¤ë¥˜");}
        }

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const modal = document.getElementById('cropperModal');
                    const img = document.getElementById('cropImage');
                    img.src = e.target.result;
                    modal.style.display = 'block';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function performCrop() {
            if(!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width:150, height:150 });
            const base64 = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('inImg').value = base64;
            const preview = document.getElementById('imgPreview');
            preview.style.display = 'block'; preview.style.backgroundImage = `url(${base64})`;
            document.getElementById('cropperModal').style.display='none';
            document.getElementById('imgInput').value = ''; 
        }

        function detectEra() {
            const y = parseInt(document.getElementById('inYear').value); if(!y) return;
            const f = tangChronology.find(i => y >= i.start && y <= i.end);
            if(f) { 
                document.getElementById('inEra').value = f.era; 
                document.getElementById('eraHint').innerHTML = `ğŸ’¡ ${f.era} - ${f.emperor} (${f.reign}) <button type="button" onclick="addAutoTags('${f.emperor}', '${f.reign}')" style="border:1px solid #d63384; background:#fff; cursor:pointer; font-size:10px; border-radius:3px;">íƒœê·¸ì¶”ê°€</button>`;
            }
        }
        function addAutoTags(e,r) { 
            const i=document.getElementById('inTags'); let t=i.value.split(',').map(x=>x.trim()).filter(x=>x); 
            if(e&&!t.includes(e))t.push(e); if(r) r.split('/').forEach(x=>{if(x&&!t.includes(x))t.push(x)}); i.value=t.join(', '); 
        }

        function updateFormUI() {
            const t = document.getElementById('inType').value;
            const d = document.getElementById('inDeathYear');
            const l = document.getElementById('lblYear');
            const h = document.getElementById('divHanja');
            if(t==='poet') { d.style.display='block'; l.innerText="ìƒëª°ë…„ë„"; h.style.display='block'; document.getElementById('optLeft').selected=true; } 
            else { d.style.display='none'; l.innerText="ì—°ë„"; h.style.display='none'; document.getElementById('optRight').selected=true; }
        }

        function formatDate(y) { if(!y || y==='0') return '?'; return y; }

        // [ê²€ìƒ‰ ì´ˆê¸°í™” ê¸°ëŠ¥]
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            filterData();
        }

        function render(q="", f="all") {
            const root = document.getElementById('timeline-root'); root.innerHTML = '';
            const safeQ = q.trim().toLowerCase();
            
            // ê²€ìƒ‰ X ë²„íŠ¼ í† ê¸€
            document.getElementById('clearSearchBtn').style.display = safeQ.length > 0 ? 'block' : 'none';

            const filtered = db.filter(i => {
                const eraMatch = f === 'all' || i.era === f;
                if (!safeQ) return eraMatch;
                let tm = (i.name && i.name.toLowerCase().includes(safeQ)) || (i.tags && i.tags.join(" ").toLowerCase().includes(safeQ));
                if (!tm && i.poems) if(i.poems.some(p => p.title.includes(safeQ))) tm = true;
                return eraMatch && tm;
            });

            filtered.forEach(item => {
                if (item.isShow) {
                    const div = document.createElement('div'); div.className = item.type === 'poet' ? 'container left' : 'container right';
                    const imgTag = item.img ? `<img src="${item.img}" class="thumb-img">` : '';
                    
                    const userColor = (item.cardColor && item.cardColor !== "#ffffff") ? item.cardColor : null;
                    let cardBg = userColor || (eraTheme[item.era] || (item.type==='poet' ? config.leftCardColor : config.rightCardColor));
                    if (!cardBg || cardBg === "#ffffff") cardBg = "#ffffff"; 

                    let tagHtml = item.tags ? '<div class="tag-container">' + item.tags.map(t => `<span class="tag-badge" onclick="searchTag('${t}')">#${t}</span>`).join('') + '</div>' : "";
                    
                    const btns = isAdmin ? `
                        <div class="action-btns" style="display:block;">
                            <span class="btn-text btn-edit" onclick="event.stopPropagation(); editItem(${item.id})">[ìˆ˜ì •]</span>
                            <span class="btn-text btn-del" onclick="event.stopPropagation(); deleteItem(${item.id})">[ì‚­ì œ]</span>
                        </div>` : '';
                    
                    let bubbleDate = formatDate(item.year);
                    
                    let titleHtml = cleanTitle(item.name);
                    const eraDisplay = eraMap[item.era] || item.era || "";
                    
                    if (item.type === 'poet') {
                        let subInfo = [];
                        if (item.hanja) subInfo.push(item.hanja);
                        const dateRange = `${formatDate(item.year)}~${formatDate(item.deathYear)}`;
                        subInfo.push(dateRange);
                        titleHtml += ` <span style='font-size:0.7em; font-weight:normal;'>(${subInfo.join(', ')})</span>`;
                    }

                    // [FIX] onclickì— ID ë”°ì˜´í‘œ ì¶”ê°€: openModal('${item.id}')
                    div.innerHTML = `
                        <div class="year-bubble" onclick="openContextModal('${item.id}')">${bubbleDate}</div>
                        <div class="content clearfix" style="background-color:${cardBg};" onclick="openModal('${item.id}')">
                            ${imgTag}
                            <div class="title-text">
                                <span class="era-tag">${eraDisplay}</span> ${titleHtml}
                            </div>
                            ${tagHtml}
                            <span class="desc-text">${cleanTextForCard(item.desc)}</span>
                            ${btns}
                        </div>`;
                    root.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.className = 'minor-row';
                    // [FIX] Minor dot onclickì—ë„ ë”°ì˜´í‘œ ì¶”ê°€
                    div.innerHTML = `<div class="minor-dot" data-tooltip="${formatDate(item.year)} : ${item.name}" onclick="openModal('${item.id}')"></div>`;
                    root.appendChild(div);
                }
            });
            setTimeout(() => { adjustPadding(); setupScrollAnimation(); }, 100);
        }

        function populateEraFilter() { const s = document.getElementById('eraFilter'); const e = [...new Set(db.map(i=>i.era))].sort(); s.innerHTML='<option value="all">ëª¨ë“  ì‹œëŒ€</option>'; e.forEach(x=>{s.innerHTML+=`<option value="${x}">${x}</option>`}); }
        function filterData() { render(document.getElementById('searchInput').value.toLowerCase(), document.getElementById('eraFilter').value); }
        function searchTag(t) { document.getElementById('searchInput').value=t; filterData(); }
        function toggleAdmin() { document.getElementById('adminPanel').style.display = document.getElementById('adminPanel').style.display==='block'?'none':'block'; }
        function toggleConfig() { document.getElementById('configForm').style.display = document.getElementById('configForm').style.display==='none'?'block':'none'; }
        
        function saveConfig() {
            config.title = document.getElementById('cfgTitle').value; config.desc = document.getElementById('cfgDesc').value;
            config.copyright = document.getElementById('cfgCopyright').value;
            config.leftLabel = document.getElementById('cfgLabelLeft').value; config.rightLabel = document.getElementById('cfgLabelRight').value;
            config.bgColor = document.getElementById('cfgBgColor').value; config.bgImage = document.getElementById('cfgBgImage').value;
            config.leftCardColor = document.getElementById('cfgLeftColor').value; config.rightCardColor = document.getElementById('cfgRightColor').value;
            
            localStorage.setItem('tangTimelineConfig', JSON.stringify(config)); 
            applyConfigUI(); render(); alert('ì €ì¥ë¨');
        }
        
        function applyConfigUI() {
            document.getElementById('pageTitle').innerText = config.title; document.getElementById('pageDesc').innerText = config.desc;
            document.title = config.title; 
            document.getElementById('pageFooter').innerHTML = config.copyright || "";
            document.getElementById('cfgCopyright').value = config.copyright || "";
            
            const badgeLeft = document.getElementById('badgeLeft'); const badgeRight = document.getElementById('badgeRight');
            badgeLeft.innerText = config.leftLabel; badgeRight.innerText = config.rightLabel;
            
            const lColor = config.leftCardColor || "#ffffff"; const rColor = config.rightCardColor || "#ffffff";
            badgeLeft.style.backgroundColor = lColor; badgeRight.style.backgroundColor = rColor;

            document.getElementById('cfgTitle').value = config.title; document.getElementById('cfgDesc').value = config.desc;
            document.getElementById('cfgLabelLeft').value = config.leftLabel; document.getElementById('cfgLabelRight').value = config.rightLabel;
            document.getElementById('cfgBgColor').value = config.bgColor || "#fdfbf7"; document.getElementById('cfgBgImage').value = config.bgImage || "";
            document.getElementById('cfgLeftColor').value = lColor; document.getElementById('cfgRightColor').value = rColor;
            
            document.getElementById('optLeft').innerText = "ì™¼ìª½: " + config.leftLabel; document.getElementById('optRight').innerText = "ì˜¤ë¥¸ìª½: " + config.rightLabel;
            document.body.style.backgroundColor = config.bgColor || "#fdfbf7";
            document.getElementById('stickyHeader').style.backgroundColor = config.bgColor || "#fdfbf7";
            document.getElementById('pageFooter').style.backgroundColor = config.bgColor || "#fdfbf7";
            
            if(config.bgImage) {
                document.body.style.backgroundImage = `url('${config.bgImage}')`;
                document.body.style.backgroundSize = 'cover';
            } else { document.body.style.backgroundImage = 'none'; }
            
            updateFormUI(); setTimeout(adjustPadding, 100);
        }

        // [FIX] ID ë¹„êµ ë¡œì§ ìˆ˜ì • (ëŠìŠ¨í•œ ë¹„êµ == ì‚¬ìš©)
        function editItem(id) {
            const item = db.find(d => d.id == id); if (!item) return;
            document.getElementById('adminPanel').style.display = 'block'; 
            document.getElementById('inShow').checked = item.isShow;
            document.getElementById('inType').value = item.type; 
            updateFormUI(); 
            document.getElementById('inYear').value = item.year; document.getElementById('inDeathYear').value = item.deathYear||"";
            document.getElementById('inEra').value = item.era; document.getElementById('inName').value = item.name; 
            document.getElementById('inHanja').value = item.hanja||""; 
            document.getElementById('inRelations').value = item.relations||""; document.getElementById('inTags').value = item.tags ? item.tags.join(", ") : "";
            document.getElementById('inDesc').value = item.desc; document.getElementById('inImg').value = item.img||"";
            document.getElementById('inCardColor').value = item.cardColor||"#ffffff";
            document.getElementById('inLat').value = item.lat||""; document.getElementById('inLng').value = item.lng||"";
            document.getElementById('inGeoName').value = item.geoName||""; document.getElementById('inGeoDesc').value = item.geoDesc||"";
            
            if(item.img && item.img.startsWith('data:image')) {
                const preview = document.getElementById('imgPreview');
                preview.style.display = 'block'; preview.style.backgroundImage = `url(${item.img})`;
            }

            const contentBox = document.getElementById('inContent');
            if (item.type === 'poet' && item.poems) {
                contentBox.value = item.poems.map(p => {
                    let text = `${p.title}|${p.content}`;
                    if (p.simplified) text += `\n\n+++\n${p.simplified}`;
                    if (p.desc) text += `\n\n---\n${p.desc}`;
                    return text;
                }).join('\n\n===\n\n');
            } else { contentBox.value = item.historyDetail || ""; }
            editingId = item.id; document.getElementById('btnSave').innerText = "ìˆ˜ì • ì™„ë£Œ"; window.scrollTo(0, 0);
        }

        function saveData() {
            const isShow = document.getElementById('inShow').checked; const type = document.getElementById('inType').value;
            const year = document.getElementById('inYear').value; const deathYear = document.getElementById('inDeathYear').value;
            const era = document.getElementById('inEra').value; const name = document.getElementById('inName').value; 
            const hanja = document.getElementById('inHanja').value; 
            const tags = document.getElementById('inTags').value.split(',').map(t=>t.trim()).filter(t=>t);
            const relations = document.getElementById('inRelations').value; const desc = document.getElementById('inDesc').value; 
            const img = document.getElementById('inImg').value; const cardColor = document.getElementById('inCardColor').value; 
            const rawContent = document.getElementById('inContent').value;
            const lat = document.getElementById('inLat').value; const lng = document.getElementById('inLng').value;
            const geoName = document.getElementById('inGeoName').value; const geoDesc = document.getElementById('inGeoDesc').value;

            if (!year || !name) { alert('í•„ìˆ˜ í•­ëª© ëˆ„ë½'); return; }
            
            let poems = []; let historyDetail = "";
            if (type === 'poet' && rawContent.trim()) { 
                const blocks = rawContent.split('==='); 
                poems = blocks.map(b => { 
                    let temp = b; let pDesc = ""; const descParts = temp.split('---');
                    if (descParts.length > 1) { pDesc = descParts.slice(1).join('---').trim(); temp = descParts[0]; }
                    let pSimp = ""; const simpParts = temp.split('+++');
                    if (simpParts.length > 1) { pSimp = simpParts.slice(1).join('+++').trim(); temp = simpParts[0]; }
                    const idx = temp.indexOf('|'); 
                    if (idx !== -1) return { title: temp.substring(0, idx).trim(), content: temp.substring(idx + 1).trim(), simplified: pSimp, desc: pDesc }; 
                    return null; 
                }).filter(p => p); 
            } else { historyDetail = rawContent.trim(); }
            
            const newData = { id: editingId || Date.now(), year, deathYear, era, type, name, hanja, tags, relations, desc, img, isShow, cardColor, poems, historyDetail, lat, lng, geoName, geoDesc };
            if (editingId) { const idx = db.findIndex(d => d.id == editingId); if (idx !== -1) db[idx] = newData; } else { db.push(newData); }
            saveToLocal(); render(); populateEraFilter(); clearForm();
        }

        function clearForm() {
            document.getElementById('inYear').value = ''; document.getElementById('inDeathYear').value = ''; 
            document.getElementById('inName').value = ''; document.getElementById('inHanja').value = '';
            document.getElementById('inTags').value = ''; document.getElementById('inRelations').value = '';
            document.getElementById('inDesc').value = ''; document.getElementById('inImg').value = ''; document.getElementById('inContent').value = ''; 
            document.getElementById('inLat').value = ''; document.getElementById('inLng').value = ''; document.getElementById('inGeoName').value = ''; document.getElementById('inGeoDesc').value = '';
            document.getElementById('imgPreview').style.display = 'none'; document.getElementById('eraHint').innerHTML = '';
            document.getElementById('inShow').checked = true; document.getElementById('inCardColor').value = "#ffffff";
            editingId = null; document.getElementById('btnSave').innerText = "ì €ì¥"; updateFormUI();
        }
        
        function deleteItem(id) { 
            if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                db = db.filter(i => i.id != id); 
                saveToLocal(); render(); populateEraFilter(); 
                if(currentOpenId === id) closeModal('detailModal');
            } 
        }
        
        function resetAllData() { if(confirm('ì „ì²´ ì‚­ì œ?')) { localStorage.removeItem('tangTimelineDB'); location.reload(); } }

        function openModal(id, keepHistory = false) {
            try {
                // UI ì´ˆê¸°í™” (ì´ì „ ë°ì´í„° ì”ìƒ ë°©ì§€)
                document.getElementById('miniMapCaption').innerText = ''; 
                document.getElementById('miniMap').innerHTML = '';
                document.getElementById('relContainer').innerHTML = '';

                const item = db.find(d => d.id == id); 
                if (!item) { console.error("Item not found:", id); return; }

                if (!keepHistory) { 
                    modalHistory = []; 
                    document.getElementById('backBtn').style.display = 'none'; 
                }
                currentOpenId = id;

                // íƒ€ì´í‹€
                let dateStr = formatDate(item.year); 
                if (item.type === 'poet') dateStr += ` ~ ${formatDate(item.deathYear)}`;
                
                let nameHtml = `${cleanTitle(item.name)}`;
                if (item.type === 'poet') {
                    let subInfo = [];
                    if (item.hanja) subInfo.push(item.hanja);
                    subInfo.push(dateStr);
                    nameHtml += ` <span style='font-size:0.7em; color:#888;'>(${subInfo.join(', ')})</span>`;
                } else { 
                    nameHtml += ` <span style='font-size:0.7em; color:#888;'>(${item.year})</span>`; 
                }
                document.getElementById('mName').innerHTML = nameHtml;
                
                // ì„¤ëª… & íƒœê·¸
                const editBtn = isAdmin ? `<div style="text-align:right; margin-bottom:10px;"><span class="btn-text btn-edit" onclick="editItem(${item.id}); closeModal('detailModal');">[ìˆ˜ì •]</span></div>` : '';
                document.getElementById('mDesc').innerHTML = editBtn + parseText(item.desc, false);
                document.getElementById('mTags').innerHTML = item.tags ? item.tags.map(t => `<span class="tag-badge">#${t}</span>`).join('') : "";
                
                // ì´ë¯¸ì§€
                const mImg = document.getElementById('mImg'); 
                if(item.img) { mImg.src = item.img; mImg.style.display = 'block'; } 
                else { mImg.style.display = 'none'; }
                
                // [ì•ˆì „ì¥ì¹˜] ë³¸ë¬¸ ë Œë”ë§
                const area = document.getElementById('mContentArea'); area.innerHTML = '';
                try {
                    if (item.type === 'poet' && Array.isArray(item.poems)) {
                        item.poems.forEach((p) => {
                            let body = `<div class="hanja-text">${parseText(p.content, true)}</div>`; 
                            if (p.simplified) body += `<div style="margin-top:5px; padding:10px; background:#f9f9f9; border-left:4px solid #d63384;">${parseText(p.simplified, true)}</div>`;
                            if(p.desc) body += `<details class="inner-details"><summary class="inner-summary">[í•´ì„¤]</summary><div class="explain-text">${parseText(p.desc, false)}</div></details>`; 
                            const details = document.createElement('details'); details.className = 'outer-details';
                            details.innerHTML = `<summary class="outer-summary">${cleanTitle(p.title)}</summary><div class="poem-body">${body}</div>`;
                            area.appendChild(details);
                        });
                    } else if (item.historyDetail) { 
                        area.innerHTML = `<div class="poem-body">${parseText(item.historyDetail, false)}</div>`; 
                    }
                } catch(e) { console.error("Content Render Error:", e); }
                
                // [ì•ˆì „ì¥ì¹˜] ê´€ê³„ ë°°ì§€
                try {
                    const relContainer = document.getElementById('relContainer');
                    if(item.relations && typeof item.relations === 'string') {
                        item.relations.split(',').forEach(r => {
                            const p = r.split(':');
                            if(p.length > 0) {
                                const badge = document.createElement('span'); badge.className = 'rel-badge';
                                badge.innerHTML = `${p[0]} <small>${p[1]||''}</small>`; 
                                badge.onclick = () => openModalByName(p[0]);
                                relContainer.appendChild(badge);
                            }
                        });
                    }
                } catch(e) { console.error("Rel Render Error:", e); }

                // [ì•ˆì „ì¥ì¹˜] ì§€ë„
                try {
                    const miniMapWrapper = document.getElementById('miniMapWrapper');
                    if(item.lat && item.lng) {
                        miniMapWrapper.style.display = 'block'; 
                        document.getElementById('miniMapCaption').innerText = item.geoDesc || "";
                        setTimeout(() => {
                            if (miniMap) miniMap.remove();
                            miniMap = L.map('miniMap').setView([item.lat, item.lng], 6);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(miniMap);
                            L.marker([item.lat, item.lng]).addTo(miniMap).bindPopup(`<b>${item.geoName||item.name}</b>`).openPopup();
                        }, 200);
                    } else { 
                        miniMapWrapper.style.display = (document.getElementById('relContainer').innerHTML ? 'block' : 'none'); 
                        if(!item.lat) document.getElementById('miniMap').style.display='none'; 
                    }
                } catch(e) { console.error("Map Render Error:", e); }

                // ëª¨ë‹¬ ë„ìš°ê¸°
                document.getElementById('detailModal').style.display = "block";
                document.getElementById('floatingCloseBtn').style.display = 'block';

            } catch (err) {
                console.error("Critical Modal Error:", err);
                // ì—ëŸ¬ê°€ ë‚˜ë„ ì¼ë‹¨ ì°½ì€ ë„ì›Œì„œ ë‚´ìš©ì€ í™•ì¸í•˜ê²Œ í•¨
                document.getElementById('detailModal').style.display = "block";
                document.getElementById('floatingCloseBtn').style.display = 'block';
            }
        }

        function openModalByName(name) {
            const target = db.find(d => cleanTitle(d.name) === name.trim());
            if(target) {
                if(currentOpenId) { modalHistory.push(currentOpenId); document.getElementById('backBtn').style.display='block'; }
                openModal(target.id);
            } else { alert("DBì— ì—†ëŠ” ì¸ë¬¼ì…ë‹ˆë‹¤."); }
        }

        function openStatModal() {
            const totalCards = db.length; let totalPoems = 0; const tagCounts = {};
            db.forEach(item => { 
                if (item.type === 'poet' && item.poems) totalPoems += item.poems.length; 
                if (item.tags) item.tags.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; });
            });
            const sortedTags = Object.entries(tagCounts).sort((a,b) => b[1]-a[1]).slice(0, 30);
            let cloudHtml = '<div class="tag-cloud-box">';
            const maxCount = sortedTags[0] ? sortedTags[0][1] : 1;
            sortedTags.forEach(([tag, count]) => {
                const size = 12 + (count / maxCount) * 18; 
                cloudHtml += `<a href="#" class="tag-cloud-item" style="font-size:${size}px;" onclick="searchTag('${tag}'); closeModal('statModal');">${tag}</a>`;
            });
            cloudHtml += '</div>';
            let html = `${cloudHtml}<table class="stat-table"><tr><th>ì´ ë°ì´í„°</th><td>${totalCards}ê°œ</td></tr><tr><th>ì´ ì‘í’ˆ ìˆ˜</th><td>${totalPoems}ìˆ˜</td></tr></table>`;
            document.getElementById('statContent').innerHTML = html; document.getElementById('statModal').style.display = 'block';
        }

        function openMapModal() {
            document.getElementById('mapModal').style.display = 'block';
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([34.26, 108.94], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
                    markersLayer = L.layerGroup().addTo(map);
                } else { map.invalidateSize(); }
                markersLayer.clearLayers();
                db.forEach(item => {
                    if(item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng]);
                        const txt = item.geoName || cleanTitle(item.name);
                        marker.bindPopup(`<div style="text-align:center;"><b>${txt}</b><br><span style="color:#666">${item.era}</span><br><button onclick="closeModal('mapModal');openModal(${item.id})">ì´ë™</button></div>`);
                        markersLayer.addLayer(marker);
                    }
                });
            }, 100);
        }

        function openRelModal() {
            document.getElementById('relModal').style.display = 'block';
            const nodes = []; const edges = []; const ids = new Set();
            
            db.forEach(item => {
                if(!item.isShow) return; 
                if(item.type==='poet') {
                    const name = cleanTitle(item.name);
                    if(!ids.has(name)) { 
                        const nodeOpt = { id: name, label: name, size: 25 };
                        if (item.img) {
                            nodeOpt.shape = 'circularImage'; nodeOpt.image = item.img; nodeOpt.borderWidth = 3;
                            nodeOpt.color = { border: eraTheme[item.era] || '#ccc', background: '#fff' };
                        } else {
                            nodeOpt.shape = 'dot';
                            nodeOpt.color = eraTheme[item.era] || '#eee';
                        }
                        nodes.push(nodeOpt); ids.add(name); 
                    }
                    if(item.relations && typeof item.relations === 'string') {
                        item.relations.split(',').forEach(r => {
                            const p = r.split(':');
                            const target = p[0].trim();
                            if(!ids.has(target)) { 
                                const tItem = db.find(d => cleanTitle(d.name) === target);
                                const tOpt = { id: target, label: target, size: 20 };
                                if (tItem && tItem.img) { tOpt.shape = 'circularImage'; tOpt.image = tItem.img; } else { tOpt.shape = 'dot'; tOpt.color = '#eee'; }
                                nodes.push(tOpt); ids.add(target); 
                            }
                            edges.push({ from: name, to: target, label: p[1]||'', arrows:'to', color:'#ccc' });
                        });
                    }
                }
            });
            const container = document.getElementById('network');
            const network = new vis.Network(container, { nodes, edges }, { nodes:{font:{size:16, face:'KoPub Batang'}}, physics:{stabilization:false, barnesHut: { gravitationalConstant: -2000, springConstant: 0.04, springLength: 95 }} });
            network.on("click", function(p) { if(p.nodes.length) openModalByName(p.nodes[0]); });
        }

        function openContextModal(targetId) {
            const targetItem = db.find(d => d.id == targetId); if (!targetItem) return;
            const idx = db.findIndex(d => d.id == targetId);
            document.getElementById('ctxTargetYear').innerText = targetItem.year;
            
            const siblings = db.slice(Math.max(0, idx - 5), Math.min(db.length, idx + 6));
            
            const list = document.getElementById('ctxList'); list.innerHTML = '';
            siblings.forEach(item => {
                const li = document.createElement('li'); 
                const isMinor = !item.isShow;
                li.className = `ctx-item ${item.id == targetId ? 'current' : ''} ${isMinor ? 'minor' : ''}`;
                li.onclick = () => { closeModal('contextModal'); openModal(item.id); };
                li.innerHTML = `<div class="ctx-year">${item.year}</div><div class="ctx-info"><span class="ctx-name">${item.name}</span><span class="ctx-desc">${item.desc.substring(0, 40)}...</span></div>`;
                list.appendChild(li);
            });
            document.getElementById('contextModal').style.display = "block";
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = "none"; 
            document.getElementById('floatingCloseBtn').style.display = 'none';
            if (id === 'detailModal') { document.getElementById('mContentArea').innerHTML = ''; document.getElementById('mDesc').innerHTML = ''; }
        }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) { closeModal(e.target.id); } }
        
        init();
    </script>
</body>
</html>
