<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ íƒ€ì„ë¼ì¸ DB</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=KoPub+Batang:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/pinyin-pro"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* ë ˆì´ì•„ì›ƒ ì˜¤ì°¨ ì œê±° */
        * { box-sizing: border-box !important; }

        /* --- 1. ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        :root { --line-color: #8B0000; --text-color: #333; --edit-color: #0056b3; --link-color: #1a0dab; --dot-color: #aaa; --tag-bg: #eef; --tag-text: #0044cc; }
        
        body { font-family: 'KoPub Batang', 'Noto Serif KR', serif; color: var(--text-color); margin: 0; padding: 0; background-color: #fdfbf7; background-attachment: fixed; transition: background 0.3s; }
        
        /* --- ìƒë‹¨ ê³ ì • ì˜ì—­ (Sticky) --- */
        #stickyHeader {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #fdfbf7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding-top: 20px;
            transition: background 0.3s;
        }

        header { text-align: center; margin-bottom: 10px; padding: 0 20px;}
        h1 { color: var(--line-color); word-break: keep-all; margin-bottom: 5px; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); margin-top: 0;}
        .page-desc { color: #555; font-size: 0.95rem; margin-bottom: 15px; font-weight: bold; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        
        .search-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-input { padding: 8px; border: 2px solid var(--line-color); border-radius: 20px; width: 250px; outline: none; }
        .filter-select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .stat-btn, .print-btn, .map-btn, .rel-btn { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .print-btn { background: #333; }
        .map-btn { background: #007bff; }
        .rel-btn { background: #6f42c1; } /* ë³´ë¼ìƒ‰ ë²„íŠ¼ */

        /* --- í—¤ë” ì ˆëŒ€ ì¢Œí‘œ ê³ ì • --- */
        .timeline-headers { 
            position: relative; 
            max-width: 1000px; 
            width: 100%;
            height: 60px; 
            margin: 0 auto; 
            padding-bottom: 15px;
        }
        
        #badgeLeft, #badgeRight {
            position: absolute;
            top: 0;
            display: inline-block; 
            padding: 12px 0; 
            width: 160px; 
            border-radius: 15px; 
            font-weight: bold; 
            font-size: 1.2rem; 
            color: #333; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            border: 1px solid rgba(0,0,0,0.05); 
            text-align: center; 
            background-color: #fff;
        }
        #badgeLeft { right: 50%; margin-right: 50px; }
        #badgeRight { left: 50%; margin-left: 50px; }

        /* --- íƒ€ì„ë¼ì¸ ë³¸ë¬¸ --- */
        .timeline { position: relative; max-width: 1000px; margin: 0 auto; padding-bottom: 80px; padding-top: 20px; }
        .timeline::after { content: ''; position: absolute; width: 4px; background-color: var(--line-color); top: 0; bottom: 0; left: 50%; margin-left: -2px; z-index: 0; }
        .container { padding: 10px 50px; position: relative; width: 50%; }
        .left { left: 0; text-align: right; } .right { left: 50%; text-align: left; }
        
        .content { padding: 15px; position: relative; transition: transform 0.2s; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 2px 2px 5px rgba(0,0,0,0.05); background: white; text-align: left; }
        .left .content { text-align: right; }
        .content:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; }
        
        .year-bubble { position: absolute; width: 50px; height: 50px; background-color: white; border: 3px solid var(--line-color); border-radius: 50%; z-index: 10; text-align: center; line-height: 50px; font-weight: bold; font-size: 14px; color: var(--line-color); top: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .year-bubble:hover { background-color: var(--line-color); color: white; transform: scale(1.1); }
        .left .year-bubble { right: -25px; } .right .year-bubble { left: -25px; }
        
        .minor-row { width: 100%; height: 20px; position: relative; margin: 5px 0; }
        .minor-dot { position: absolute; left: 50%; margin-left: -6px; width: 12px; height: 12px; background-color: white; border: 2px solid var(--dot-color); border-radius: 50%; cursor: pointer; z-index: 5; transition: all 0.2s; }
        .minor-dot:hover { background-color: var(--edit-color); border-color: var(--edit-color); transform: scale(1.5); }
        .minor-dot::before { content: attr(data-tooltip); position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .minor-dot:hover::before { opacity: 1; }

        .thumb-img { max-width: 80px; max-height: 80px; display: block; margin: 5px; border: 1px solid #ddd; padding: 2px; background: #fff; }
        .left .thumb-img { float: left; margin-right: 15px; } .right .thumb-img { float: right; margin-left: 15px; }
        .era-tag { font-size: 0.8em; color: #666; display: block; margin-bottom: 2px;}
        .title-text { font-size: 1.3em; font-weight: bold; cursor: pointer; color: #000; border-bottom: 1px dashed #bbb; }
        .title-text:hover { color: var(--line-color); border-bottom: 1px solid var(--line-color); }
        .clearfix::after { content: ""; clear: both; display: table; }
        .action-btns { margin-top: 5px; font-size: 0.8rem; display: none; }
        .btn-text { cursor: pointer; text-decoration: underline; margin-left: 8px; }
        .btn-del { color: red; } .btn-edit { color: var(--edit-color); }
        .tag-container { margin-top: 5px; }
        .tag-badge { display: inline-block; font-size: 0.75rem; background: var(--tag-bg); color: var(--tag-text); padding: 2px 6px; border-radius: 4px; margin-right: 4px; cursor: pointer; }
        .tag-badge:hover { background: #dcebff; text-decoration: underline; }
        .wiki-link { color: #d63384; font-weight: bold; cursor: pointer; border-bottom: 1px dotted #d63384; }
        .wiki-link:hover { background-color: #ffeef5; }
        a:not(.img-card):not(.qtfm-btn):not(.source-credit a) { color: var(--link-color); text-decoration: none; font-weight: bold; }
        a:not(.img-card):not(.qtfm-btn):not(.source-credit a):hover { text-decoration: underline; background-color: #eee; border-radius: 3px;}

        /* --- ëª¨ë°”ì¼ ìµœì í™” --- */
        @media (max-width: 768px) {
            .thumb-img, .tag-container, .content small, .action-btns { display: none !important; }
            .content { padding: 10px 15px; min-height: auto; display: flex; flex-direction: column; justify-content: center; }
            .title-text { font-size: 1.15rem; margin-bottom: 0; border-bottom: none; line-height: 1.3; }
            .era-tag { font-size: 0.85rem; margin-bottom: 3px; color: #666; font-weight: bold; }
            
            .timeline-headers { display: flex; height: auto; padding: 0 10px; }
            #badgeLeft, #badgeRight {
                position: static; 
                width: 48%; 
                margin: 0 1%;
                padding: 10px 0;
                font-size: 1rem;
            }
            .container { padding: 10px 30px; } 
            .left .content { align-items: flex-end; text-align: right; }
            .right .content { align-items: flex-start; text-align: left; }
        }

        /* --- ê´€ë¦¬ì íŒ¨ë„ --- */
        .admin-btn { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #333; color: white; border: none; cursor: pointer; z-index: 2000; border-radius: 5px; display: none; }
        .login-trigger { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; font-size: 12px; cursor: pointer; z-index: 2000;}
        
        #adminPanel { display: none; position: fixed; top: 60px; right: 20px; width: 500px; background: white; border: 2px solid #333; padding: 25px; z-index: 2100; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; font-family: sans-serif; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 5px;}
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; font-size: 14px; }
        textarea { resize: vertical; } input[type="color"] { padding: 0; height: 35px; cursor: pointer;}
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-save { background-color: var(--line-color); color: white; border: none; padding: 12px; flex: 1; cursor: pointer; font-weight: bold; font-size: 14px;}
        .btn-save.editing { background-color: var(--edit-color); }
        .btn-reset { background-color: #666; color: white; border: none; padding: 12px; cursor: pointer;}
        .config-section { background: #eef; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ccd; }
        .config-toggle { width: 100%; text-align: left; background: none; border: none; cursor: pointer; font-weight: bold; padding: 0; }
        .syntax-guide { font-size: 11px; color: #555; background: #f8f9fa; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; line-height: 1.5; letter-spacing: -0.5px; }
        .syntax-guide code { background: #fff; border: 1px solid #ccc; padding: 1px 4px; border-radius: 3px; color: #d63384; font-family: monospace; font-weight: bold; }
        
        .pinyin-btn, .tone-btn-input, .license-btn, .audio-btn { color: white; border: none; padding: 3px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-left: 5px; }
        .pinyin-btn { background-color: #28a745; } .pinyin-btn:hover { background-color: #218838; }
        .tone-btn-input { background-color: #007bff; } .tone-btn-input:hover { background-color: #0056b3; }
        .license-btn { background-color: #6f42c1; } .license-btn:hover { background-color: #59359a; }
        .audio-btn { background-color: #fd7e14; } .audio-btn:hover { background-color: #e36a05; }

        /* --- ëª¨ë‹¬ --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 2% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; position: sticky; top: 0; right: 0; z-index: 10; background: rgba(255,255,255,0.9); padding: 0 10px; border-radius: 5px;}
        .close:hover { color: #000; }
        
        #floatingCloseBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        #floatingCloseBtn:active { transform: translateX(-50%) scale(0.95); background-color: black; }

        .back-btn { display: none; float: left; background: #eee; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #333; }
        .back-btn:hover { background: #ddd; }
        
        .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem;}
        .stat-table th, .stat-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .stat-table th { background-color: #f2f2f2; font-weight: bold; }
        .stat-scroll-box { max-height: 300px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .stat-rank-table { width: 100%; border-collapse: collapse; }
        .stat-rank-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .stat-rank-table tr:hover { background-color: #f9f9f9; }
        .rank-num { font-weight: bold; color: #8B0000; width: 30px; text-align: center; }
        
        #contextModal .modal-content { max-width: 600px; background: #fdfdfd; }
        .ctx-list { list-style: none; padding: 0; margin-top: 20px; }
        .ctx-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .ctx-item:hover { background: #f0f0f0; }
        .ctx-item.current { background: #fff0f0; border-left: 4px solid var(--line-color); }
        .ctx-item.minor .ctx-name { color: #888; font-size: 0.95em; font-weight: normal; }
        .ctx-item.minor .ctx-year { color: #aaa; font-size: 1em; }
        .ctx-item.minor { opacity: 0.9; }
        .ctx-year { font-weight: bold; color: var(--line-color); width: 60px; font-size: 1.1em;}
        .ctx-info { flex: 1; }
        .ctx-name { font-weight: bold; font-size: 1.1em; color: #333; }
        .ctx-desc { font-size: 0.85em; color: #666; display: block;}
        .img-card { display: block; margin: 15px auto; text-align: center; border: 1px solid #ddd; padding: 5px; background: #fff; max-width: 90%; text-decoration: none !important; color: inherit !important; }
        .img-card:hover { transform: scale(1.02); }
        .img-card img { max-width: 100%; display: block; margin: 0 auto; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin: 15px 0; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        details.outer-details { margin-bottom: 10px; border: 1px solid #eee; }
        summary.outer-summary { padding: 10px; cursor: pointer; background: #f9f9f9; font-weight: bold; list-style: none; }
        summary.outer-summary::before { content: 'ğŸ“œ '; }
        .poem-body { padding: 15px; white-space: pre-wrap; line-height: 2.2; color: #444; border-top: 1px solid #eee; }
        .hanja-text { font-size: 1.2rem; color: #222; margin-bottom: 5px; font-family: 'KoPub Batang', serif; }
        details.inner-details { border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 10px; line-height: 1.6;}
        summary.inner-summary { font-size: 0.9rem; color: #666; cursor: pointer; list-style: none;}
        summary.inner-summary::before { content: 'ğŸ”½ '; }
        
        .simp-btn { font-size: 0.8rem; background: #fff0f5; color: #d63384; border: 1px solid #d63384; border-radius: 3px; cursor: pointer; padding: 2px 5px; margin-top: 5px; display: inline-block; margin-right: 5px;}
        .simp-btn:hover { background: #d63384; color: white; }
        
        .simplified-box { display: none; font-family: 'Noto Serif SC', serif; color: #555; background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #d63384; line-height: 1.8; }
        
        ruby { display: inline-block; text-align: center; margin: 0 2px; ruby-position: under; }
        rt { font-size: 0.6em; color: #777; font-family: sans-serif; display: block; line-height: 1.2; user-select: none; }
        
        .qtfm-btn { display: inline-block; background-color: #E60026; color: white; padding: 5px 12px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: bold; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .qtfm-btn:hover { transform: scale(1.05); background-color: #cc0022; text-decoration: none; color: white; }

        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map { width: 100%; height: 500px; border-radius: 8px; border: 2px solid #333; }
        #miniMapWrapper { width: 100%; margin: 15px 0; display: none; }
        #miniMap { width: 100%; height: 200px; border-radius: 8px; border: 1px solid #ccc; }
        #miniMapCaption { text-align: center; font-size: 0.85rem; color: #666; margin-top: 5px; font-weight: bold; }

        /* [NEW] ê´€ê³„ë„ ìŠ¤íƒ€ì¼ */
        #network { width: 100%; height: 600px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }

        /* Leaflet ëª¨ë‹¬ ì¶©ëŒ ë°©ì§€ */
        .leaflet-container { font-family: sans-serif !important; z-index: 1; }

        footer { text-align: center; padding: 20px; border-top: 1px solid #ddd; color: #888; font-size: 0.9rem; font-family: 'Noto Serif KR', serif; background-color: #fdfbf7; }

        @media print {
            .admin-btn, .search-bar, .action-btns, .config-section, .btn-group, .help-trigger, .modal, .simp-btn, .pinyin-btn, .tts-btn, .login-trigger, #floatingCloseBtn { display: none !important; }
            #stickyHeader { position: static; box-shadow: none; }
            body { background: white !important; color: black; padding-top: 0 !important; }
            .content { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; }
            .timeline::after { background-color: #ccc; }
            .year-bubble { border-color: #333; color: #333; }
        }
        
        .source-credit { margin-top: 20px; text-align: right; border-top: 1px dashed #ddd; padding-top: 10px; font-size: 0.8rem; color: #888; display: block; }
        .source-credit:hover { opacity: 1; color: #333; }
        .source-credit a { color: #555; text-decoration: none; border-bottom: 1px dotted #888; }
        .source-credit img { vertical-align: middle; margin-right: 3px; max-height: 20px; }
    </style>
</head>
<body>
    <div id="stickyHeader">
        <header>
            <h1 id="pageTitle">ë‚˜ë§Œì˜ ì—­ì‚¬ ì—°í‘œ</h1>
            <p id="pageDesc" class="page-desc">ë¡œë”© ì¤‘...</p>
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="ì´ë¦„, ë‚´ìš©, íƒœê·¸ ê²€ìƒ‰..." onkeyup="filterData()">
                <select id="eraFilter" class="filter-select" onchange="filterData()"> <option value="all">ëª¨ë“  ì‹œëŒ€</option> </select>
                <button class="rel-btn" onclick="openRelModal()">ğŸ•¸ï¸ ê´€ê³„ë„</button>
                <button class="map-btn" onclick="openMapModal()">ğŸ—ºï¸ ì§€ë„</button>
                <button class="stat-btn" onclick="openStatModal()">ğŸ“Š í†µê³„</button>
                <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </header>
        
        <div class="timeline-headers">
            <span class="header-badge" id="badgeLeft">Label Left</span>
            <span class="header-badge" id="badgeRight">Label Right</span>
        </div>
    </div>

    <button id="floatingCloseBtn" onclick="closeModal('detailModal')">âŒ ë‹«ê¸°</button>

    <button id="adminToggle" class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬/ì„¤ì •</button>

    <div id="adminPanel">
        <div class="config-section">
            <button class="config-toggle" onclick="toggleConfig()">ğŸ› ï¸ ë””ìì¸ ë° ì„¤ì • (í¼ì¹˜ê¸°)</button>
            <div id="configForm" style="display:none; margin-top:10px;">
                <div class="form-group"><label>ë©”ì¸ ì œëª©</label> <input type="text" id="cfgTitle"></div>
                <div class="form-group"><label>ì•ˆë‚´ ë¬¸êµ¬</label> <textarea id="cfgDesc" rows="2"></textarea></div>
                <div class="form-group"><label>ë°”ë‹¥ê¸€(Copyright) ë‚´ìš©</label> <input type="text" id="cfgCopyright" placeholder="ì˜ˆ: Copyright Â© 2026. All rights reserved."></div>
                <div class="form-group" style="display:flex; gap:5px;">
                    <div style="flex:1;"><label>ì™¼ìª½ ì´ë¦„</label><input type="text" id="cfgLabelLeft"></div>
                    <div style="flex:1;"><label>ì˜¤ë¥¸ìª½ ì´ë¦„</label><input type="text" id="cfgLabelRight"></div>
                </div>
                <div class="form-group"><label>ë°°ê²½ìƒ‰</label> <input type="color" id="cfgBgColor" style="width:100%;"></div>
                <div class="form-group"><label>ë°°ê²½ ì´ë¯¸ì§€</label> <input type="text" id="cfgBgImage"></div>
                <div class="form-group"><label>ë°˜ë³µ</label> <select id="cfgBgRepeat"><option value="repeat">ë°˜ë³µ</option><option value="cover">ê½‰ ì±„ìš°ê¸°</option></select></div>
                <div class="form-group" style="display:flex; gap:5px;">
                    <div style="flex:1;"><label>ì¢Œì¸¡ ìƒ‰</label><input type="color" id="cfgLeftColor" style="width:100%;"></div>
                    <div style="flex:1;"><label>ìš°ì¸¡ ìƒ‰</label><input type="color" id="cfgRightColor" style="width:100%;"></div>
                </div>
                <button class="btn-save" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            </div>
        </div>
        <h3 id="formTitle" style="margin-top:20px; border-top:2px solid #333; padding-top:10px;">ë°ì´í„° ì…ë ¥</h3>
        <div class="form-group" style="background:#fff3cd; padding:10px; border-radius:5px; border:1px solid #ffeeba; display:flex; gap:10px;">
            <div style="flex:1;"><label>ğŸ¨ ê°•ì¡°ìƒ‰</label><input type="color" id="inCardColor" value="#ffffff" style="width:100%;"></div>
            <div style="flex:0 0 auto;"><button type="button" onclick="document.getElementById('inCardColor').value = '';" style="font-size:11px;">ê¸°ë³¸ê°’</button></div>
        </div>
        <div class="form-group" style="background:#f0f8ff; padding:10px; border-radius:5px; border:1px solid #cceeff;">
            <label style="margin-bottom:0;"><input type="checkbox" id="inShow" checked> <strong>í¬ê²Œ ë³´ì´ê¸°</strong></label>
        </div>
        
        <div class="form-group" style="background:#e8f5e9; padding:10px; border-radius:5px; border:1px solid #c8e6c9;">
             <label>ğŸ“ ì§€ë„ ë° ìœ„ì¹˜ ì •ë³´</label>
             <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="inLocationSearch" placeholder="ì¢Œí‘œ ê²€ìƒ‰ (ì˜ˆ: Xi'an, ë‚™ì–‘)" style="flex:1;">
                <button type="button" onclick="searchLocation()" style="background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; width:60px;">ğŸ” ì°¾ê¸°</button>
             </div>
             <div style="display:flex; gap:5px; margin-bottom:5px;">
                 <input type="number" id="inLat" step="0.0001" placeholder="ìœ„ë„(Lat)" style="flex:1;">
                 <input type="number" id="inLng" step="0.0001" placeholder="ê²½ë„(Lng)" style="flex:1;">
             </div>
             <div style="display:flex; gap:5px;">
                 <input type="text" id="inGeoName" placeholder="ì¥ì†Œëª… (ë§ˆì»¤ìš©, ì˜ˆ: æµ™æ±Ÿçœ ç¾©çƒç¸£)" style="flex:1;">
                 <input type="text" id="inGeoDesc" placeholder="ì§€ë„ ì„¤ëª… (ì˜ˆ: <ë‚™ë¹ˆì™• ì¶œìƒì§€>)" style="flex:1;">
             </div>
        </div>

        <div class="form-group"><label>ìœ„ì¹˜ (ìœ í˜•)</label> <select id="inType" onchange="updateFormUI()"><option value="poet" id="optLeft">ì™¼ìª½ (ì‹œì¸/ì‘í’ˆ)</option><option value="history" id="optRight">ì˜¤ë¥¸ìª½ (ì—­ì‚¬/ì‚¬ê±´)</option></select></div>
        
        <div class="form-group">
            <label id="lblYear">ì—°ë„ / ì‹œëŒ€</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="inYear" placeholder="ì—°ë„ (ì‹œì‘/ì¶œìƒ)" style="flex:1;" oninput="detectEra()">
                <input type="number" id="inDeathYear" placeholder="ì‚¬ë§ë…„ë„" style="flex:1; display:none;">
                <input type="text" id="inEra" placeholder="ì‹œëŒ€ (ìë™)" style="flex:1;">
            </div>
            <div id="eraHint" style="font-size:0.8rem; color:#d63384; margin-top:3px; min-height:1.2em;"></div>
        </div>

        <div class="form-group"><label>ì œëª©</label> <input type="text" id="inName"></div>
        
        <div class="form-group">
            <label>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ (ì´ë¦„:ê´€ê³„, ì´ë¦„:ê´€ê³„)</label> 
            <input type="text" id="inRelations" placeholder="ì˜ˆ: ë‘ë³´:ìš°ì •, ë§¹í˜¸ì—°:ì¡´ê²½">
        </div>

        <div class="form-group"><label>íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label> <input type="text" id="inTags" placeholder="ì˜ˆ: ì „ìŸ, ì´ë³„, ìœ ë°°"></div>
        <div class="form-group"><label>ìš”ì•½ (4ì¤„)</label> <textarea id="inDesc" rows="4"></textarea></div>
        <div class="form-group"><label>ì´ë¯¸ì§€</label> <input type="text" id="inImg"></div>
        <div class="form-group">
            <label id="detailLabel" style="display:inline-block; margin-bottom:5px;">ìƒì„¸ ë‚´ìš©</label>
            <div style="margin-bottom:5px;">
                <button type="button" class="pinyin-btn" onclick="autoPinyin()">ğŸ”  ì„ íƒêµ¬ê°„ ë³‘ìŒ</button>
                <button type="button" class="tone-btn-input" onclick="autoTone()">ğŸ”² ì„ íƒêµ¬ê°„ í‰ì¸¡</button>
                <button type="button" class="audio-btn" onclick="insertAudio()">ğŸµ ì˜¤ë””ì˜¤ ì—°ê²°</button>
                <button type="button" class="license-btn" onclick="insertLicense()">ğŸ“œ ë¼ì´ì„ ìŠ¤ ì‚½ì…</button>
            </div>
            <div class="syntax-guide"><code>[ê¸€ì](ì£¼ì†Œ)</code> (ë§í¬) &nbsp; <code>{{ì´ë¯¸ì§€|ì£¼ì†Œ|ì„¤ëª…}}</code> &nbsp; <code>{{ì˜¤ë””ì˜¤|ì£¼ì†Œ}}</code><br><code>ì œëª© | ë‚´ìš©</code> (ì²«ì¤„) &nbsp; <code>---</code> (í•´ì„¤) &nbsp; <code>===</code> (êµ¬ë¶„) &nbsp; <code>+++</code> (ê°„ì²´) <br><code>### ë‚´ìš© ###</code> (ì €ì‘ê¶Œ/ì¶œì²˜ í‘œê¸°) <br><code>%%ê°•ì¡°%%</code> (êµµê²Œ) &nbsp; <code>$$íšŒìƒ‰ê¸°ìš¸ì„$$</code></div>
            <textarea id="inContent" rows="15"></textarea>
        </div>
        <div class="btn-group"><button id="btnSave" class="btn-save" onclick="saveData()">ì €ì¥</button><button class="btn-reset" onclick="clearForm()">ì·¨ì†Œ</button></div>
        <hr>
        <div class="btn-group"><button class="btn-download" onclick="exportData()">ğŸ’¾ DB ë‹¤ìš´ë¡œë“œ (ì—…ë¡œë“œìš©)</button><input type="file" id="fileInput" onchange="importData(this)" style="display:none;"><button class="btn-reset" style="width:100%;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ DB ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
        <button class="btn-reset" style="width:100%; background:darkred; margin-top:5px;" onclick="resetAllData()">âš ï¸ ë¡œì»¬ ì´ˆê¸°í™”</button>
    </div>
    
    <div class="timeline" id="timeline-root"></div>
    
    <footer id="pageFooter"></footer>
    
    <div class="login-trigger" onclick="adminLogin()">Admin</div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button id="backBtn" class="back-btn" onclick="goBack()">â¬… ë’¤ë¡œ</button>
            <span class="close" onclick="closeModal('detailModal')">&times;</span>
            <div style="clear:both;"></div>
            
            <img id="mImg" class="img-card" style="display:none; max-width:200px;">
            <h2 id="mName" style="text-align:center;"></h2>
            <div id="mTags" style="text-align:center; margin-bottom:10px;"></div>
            
            <div id="mDesc" style="background:#f5f5f5; padding:15px; border-radius:5px; white-space: pre-wrap;"></div>
            
            <div id="miniMapWrapper">
                <div id="miniMap"></div>
                <div id="miniMapCaption"></div>
            </div>

            <hr>
            <div id="mContentArea"></div>
        </div>
    </div>
    
    <div id="contextModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('contextModal')">&times;</span><h3 style="text-align:center; border-bottom:2px solid #8B0000; padding-bottom:10px;">âŒ› <span id="ctxTargetYear"></span>ë…„ ì „í›„ ê¸°ë¡</h3><ul id="ctxList" class="ctx-list"></ul></div></div>
    <div id="statModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('statModal')">&times;</span><h3>ğŸ“Š ë°ì´í„° í†µê³„</h3><div id="statContent"></div></div></div>

    <div id="mapModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('mapModal')">&times;</span>
            <h3>ğŸ—ºï¸ ì—­ì‚¬ ì§€ë„</h3>
            <p style="font-size:0.9rem; color:#666;">ë“±ë¡ëœ ì‚¬ê±´ ë° ì¸ë¬¼ì˜ ìœ„ì¹˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
            <div id="map"></div>
        </div>
    </div>

    <div id="relModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="closeModal('relModal')">&times;</span>
            <h3>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ë„</h3>
            <p style="font-size:0.9rem; color:#666;">ì¸ë¬¼ ê°„ì˜ ê´€ê³„ë¥¼ ì‹œê°í™”í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. (ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¡œ ì´ë™)</p>
            <div id="network"></div>
        </div>
    </div>

    <script>
        const defaultConfig = { title: "ë‹¹ë‚˜ë¼ ì—­ì‚¬ì™€ ì‹œì¸ ì—°í‘œ", desc: "ë‚˜ë§Œì˜ ì—­ì‚¬ ë°ì´í„°ë² ì´ìŠ¤", leftLabel: "ì‹œì¸ / ì‘í’ˆ", rightLabel: "ì—­ì‚¬ / ì‚¬ê±´", bgColor: "#fdfbf7", bgImage: "", bgRepeat: "repeat", leftCardColor: "#ffffff", rightCardColor: "#ffffff", copyright: "" };
        let db=[], config={}, editingId=null, modalHistory=[], currentOpenId=null;
        let isAdmin = false; 
        
        let map = null;
        let markersLayer = null;
        let miniMap = null;
        let miniMarker = null;

        const eraTheme = {
            "ì´ˆë‹¹": "#f1f8e9", "ì„±ë‹¹": "#fff8e1", "ì¤‘ë‹¹": "#e3f2fd", "ë§Œë‹¹": "#f3e5f5", "ì˜¤ëŒ€": "#eceff1", "ìˆ˜ë‚˜ë¼": "#e0f2f1"
        };

        const tangChronology = [
            { start: 581, end: 617, era: "ìˆ˜ë‚˜ë¼", emperor: "ë¬¸ì œ/ì–‘ì œ", reign: "" },
            { start: 618, end: 626, era: "ì´ˆë‹¹", emperor: "ê³ ì¡°", reign: "ë¬´ë•" },
            { start: 627, end: 649, era: "ì´ˆë‹¹", emperor: "íƒœì¢…", reign: "ì •ê´€" },
            { start: 650, end: 683, era: "ì´ˆë‹¹", emperor: "ê³ ì¢…", reign: "ì˜íœ˜/í˜„ê²½/ì˜ë´‰" },
            { start: 684, end: 704, era: "ì´ˆë‹¹", emperor: "ì¸¡ì²œë¬´í›„", reign: "ì²œìˆ˜/ì¥ìˆ˜" },
            { start: 705, end: 709, era: "ì´ˆë‹¹", emperor: "ì¤‘ì¢…", reign: "ì‹ ë£¡/ê²½ë£¡" },
            { start: 710, end: 712, era: "ì´ˆë‹¹", emperor: "ì˜ˆì¢…", reign: "ê²½ìš´/íƒœê·¹" },
            { start: 712, end: 741, era: "ì„±ë‹¹", emperor: "í˜„ì¢…", reign: "ê°œì›" },
            { start: 742, end: 755, era: "ì„±ë‹¹", emperor: "í˜„ì¢…", reign: "ì²œë³´" },
            { start: 756, end: 762, era: "ì¤‘ë‹¹", emperor: "ìˆ™ì¢…", reign: "ì§€ë•/ê±´ì›" },
            { start: 763, end: 779, era: "ì¤‘ë‹¹", emperor: "ëŒ€ì¢…", reign: "ê´‘ë•/ëŒ€ë ¥" },
            { start: 780, end: 804, era: "ì¤‘ë‹¹", emperor: "ë•ì¢…", reign: "ê±´ì¤‘/ì •ì›" },
            { start: 805, end: 805, era: "ì¤‘ë‹¹", emperor: "ìˆœì¢…", reign: "ì˜ì •" },
            { start: 806, end: 820, era: "ì¤‘ë‹¹", emperor: "í—Œì¢…", reign: "ì›í™”" },
            { start: 821, end: 824, era: "ì¤‘ë‹¹", emperor: "ëª©ì¢…", reign: "ì¥ê²½" },
            { start: 825, end: 826, era: "ì¤‘ë‹¹", emperor: "ê²½ì¢…", reign: "ë³´ë ¥" },
            { start: 827, end: 840, era: "ë§Œë‹¹", emperor: "ë¬¸ì¢…", reign: "ëŒ€í™”/ê°œì„±" },
            { start: 841, end: 846, era: "ë§Œë‹¹", emperor: "ë¬´ì¢…", reign: "íšŒì°½" },
            { start: 847, end: 859, era: "ë§Œë‹¹", emperor: "ì„ ì¢…", reign: "ëŒ€ì¤‘" },
            { start: 860, end: 873, era: "ë§Œë‹¹", emperor: "ì˜ì¢…", reign: "í•¨í†µ" },
            { start: 874, end: 888, era: "ë§Œë‹¹", emperor: "í¬ì¢…", reign: "ê±´ë¶€/ê´‘ëª…" },
            { start: 889, end: 904, era: "ë§Œë‹¹", emperor: "ì†Œì¢…", reign: "ëŒ€ìˆœ/ì²œìš°" },
            { start: 905, end: 907, era: "ë§Œë‹¹", emperor: "ì• ì œ", reign: "ì²œìš°" }
        ];

        async function init() {
            try {
                try {
                    const response = await fetch('database.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        db = jsonData.data || [];
                        config = jsonData.config || defaultConfig;
                    } else { throw new Error("No external DB"); }
                } catch (err) {
                    const savedData = localStorage.getItem('tangTimelineDB'); db = savedData ? JSON.parse(savedData) : [];
                    const savedConfig = localStorage.getItem('tangTimelineConfig'); config = savedConfig ? JSON.parse(savedConfig) : {...defaultConfig};
                }
                applyConfigUI(); populateEraFilter(); render();
                document.getElementById('pageDesc').innerText = config.desc;
                document.getElementById('adminToggle').style.display = 'none';
                adjustPadding();
                window.addEventListener('resize', adjustPadding);
            } catch (e) { alert("ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message); }
        }

        function adjustPadding() {
            const headerHeight = document.getElementById('stickyHeader').offsetHeight;
            document.getElementById('timeline-root').style.paddingTop = '20px'; 
        }

        async function adminLogin() {
            if (isAdmin) return;
            const password = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!password) return;
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            const mySecret = "6eb20c53054a7218e6731761b7539d9e38f6f5e39e53c2d78e0edd732de650f2"; 
            if (hashHex === mySecret) { isAdmin = true; document.getElementById('adminToggle').style.display = 'block'; alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”!"); render(); } 
            else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
        }

        function saveToLocal() { db.sort((a, b) => a.year - b.year); localStorage.setItem('tangTimelineDB', JSON.stringify(db)); }

        function exportData() {
            const exportObj = { data: db, config: config };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
            const node = document.createElement('a'); node.href = dataStr; node.download = "database.json";
            document.body.appendChild(node); node.click(); node.remove();
        }

        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(loaded.data) { db = loaded.data; config = loaded.config || defaultConfig; } 
                    else { if(Array.isArray(loaded)) db = loaded; }
                    localStorage.setItem('tangTimelineConfig', JSON.stringify(config));
                    saveToLocal(); applyConfigUI(); alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
                } catch(err) { alert('ì˜¤ë¥˜: ' + err.message); }
            }; reader.readAsText(file);
        }

        function autoPinyin() {
            const input = document.getElementById('inContent');
            if (!input.value) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (typeof pinyinPro === 'undefined') { alert('ì¸í„°ë„· ì—°ê²° í™•ì¸ í•„ìš”'); return; }
            const { pinyin } = pinyinPro;
            const start = input.selectionStart; const end = input.selectionEnd;
            if (start === end) { alert("ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const selectedText = input.value.substring(start, end);
            const converted = convertToPinyinString(selectedText, pinyin);
            input.setRangeText(converted);
        }

        function convertToPinyinString(str, pinyinFunc) {
            const result = pinyinFunc(str, { type: 'all', toneType: 'symbol', nonZh: 'consecutive' });
            return result.map(item => item.isZh ? `${item.origin}(${item.pinyin})` : item.origin).join('');
        }

        function autoTone() {
            const input = document.getElementById('inContent');
            if (!input.value) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (typeof pinyinPro === 'undefined') { alert('ì¸í„°ë„· ì—°ê²° í™•ì¸ í•„ìš”'); return; }
            const { pinyin } = pinyinPro;
            const start = input.selectionStart; const end = input.selectionEnd;
            if (start === end) { alert("ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const selectedText = input.value.substring(start, end);
            const tokens = pinyin(selectedText, { type: 'all', toneType: 'num', nonZh: 'consecutive' });
            const converted = tokens.map(t => {
                if (!t.isZh) return t.origin;
                const isZe = /[34]$/.test(t.pinyin); 
                return `${t.origin}(${isZe ? 'â—' : 'â—‹'})`; 
            }).join('');
            input.setRangeText(converted);
        }
        
        function insertLicense() {
            const choice = prompt("1.ë™ì–‘ê³ ì „ì¢…í•©DB 2.ë‚˜ë¬´ìœ„í‚¤ 3.ìœ„í‚¤ë°±ê³¼");
            if (!choice) return;
            let creditHtml = "";
            if (choice === '1') creditHtml = "ìë£Œì¶œì²˜: <a href='http://db.cyberseodang.or.kr' target='_blank'><img src='http://db.cyberseodang.or.kr/images/front/logo_b.png'> ë™ì–‘ê³ ì „ì¢…í•©DB</a>";
            else if (choice === '2') creditHtml = "ì¶œì²˜: <a href='https://namu.wiki' target='_blank'>ë‚˜ë¬´ìœ„í‚¤</a> (CC BY-NC-SA 2.0 KR)";
            else if (choice === '3') creditHtml = "ì¶œì²˜: <a href='https://ko.wikipedia.org' target='_blank'>ìœ„í‚¤ë°±ê³¼</a> (CC BY-SA 3.0)";
            const input = document.getElementById('inContent');
            const insertText = `\n### ${creditHtml} ###`;
            input.setRangeText(insertText);
        }

        function insertAudio() {
            let url = prompt("ì˜¤ë””ì˜¤ ì£¼ì†Œ (íŒŒì¼ëª…ë§Œ ì…ë ¥ì‹œ tangshi.kr/mp3/ ìë™ì¶”ê°€)");
            if (!url) return;
            if (!url.startsWith('http')) { url = 'https://tangshi.kr/mp3/' + url; }
            const input = document.getElementById('inContent');
            input.setRangeText(`{{ì˜¤ë””ì˜¤|${url}}}`);
        }

        function cleanTitle(text) { return text ? text.replace(/\[.*?\]/g, '').trim() : ""; }
        
        function cleanTextForCard(text) {
            if (!text) return "";
            text = text.replace(/\{\{.*?\}\}/g, '').replace(/###.*?###/g, '').replace(/%%(.*?)%%/g, '$1').replace(/\$\$(.*?)\$\$/g, '$1').replace(/\[\[(.*?)\]\]/g, '$1');
            return text.substring(0, 40) + (text.length > 40 ? "..." : "");
        }

        function parseText(text, isPoetMode = false) {
            if (!text) return "";
            if (isPoetMode) { text = text.replace(/([\u2E80-\u2EFF\u31C0-\u31EF\u3200-\u32FF\u3400-\u4DBF\u4E00-\u9FBF\uF900-\uFAFF])\(([^)]+)\)/g, "<ruby>$1<rt>$2</rt></ruby>"); }
            text = text.replace(/%%(.*?)%%/g, '<b>$1</b>');
            text = text.replace(/\$\$(.*?)\$\$/g, '<span style="color:#888; font-style:italic;">$1</span>');
            text = text.replace(/\{\{ì˜¤ë””ì˜¤\|(.*?)\}\}/g, '<div style="margin-top:10px;"><audio controls src="$1" style="width:100%; border-radius:20px;"></audio></div>');
            text = text.replace(/###(.*?)###/g, '<div class="source-credit">$1</div>');
            text = text.replace(/\[\[(.+?)\]\]/g, '<span class="wiki-link" onclick="openModalByName(\'$1\')">$1</span>');
            text = text.replace(/\{\{(.+?)\s*\|\s*(.+?)\s*\|\s*(.+?)\}\}/g, '<a href="$2" target="_blank" class="img-card"><img src="$1" alt="$3"><span class="img-caption">$3</span></a>');
            text = text.replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/)|youtu\.be\/)([\w-]{11})(?:[&?][^"\s]*)?/g, '<div class="video-container"><iframe src="https://www.youtube.com/embed/$1" title="YouTube" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>');
            text = text.replace(/(https?:\/\/www\.qtfm\.cn\S+)/g, '<a href="$1" target="_blank" class="qtfm-btn">ğŸ§ èœ»èœ“FM ë‚­ì†¡ ë“£ê¸°</a>');
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">ğŸ”— $1</a>');
            return text;
        }

        async function searchLocation() {
            const query = document.getElementById('inLocationSearch').value;
            if (!query) { alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            const btn = event.target; const originalText = btn.innerText; btn.innerText = "âŒ›";
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();
                if (results && results.length > 0) {
                    const bestMatch = results[0];
                    document.getElementById('inLat').value = parseFloat(bestMatch.lat).toFixed(4);
                    document.getElementById('inLng').value = parseFloat(bestMatch.lon).toFixed(4);
                    alert(`ì°¾ì•˜ìŠµë‹ˆë‹¤!\n${bestMatch.display_name}`);
                } else { alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í˜„ëŒ€ ì§€ëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”."); }
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); } finally { btn.innerText = originalText; }
        }

        function detectEra() {
            const y = parseInt(document.getElementById('inYear').value);
            if (!y) return;
            const found = tangChronology.find(item => y >= item.start && y <= item.end);
            if (found) {
                document.getElementById('inEra').value = found.era;
                const hintText = `ğŸ’¡ ${found.era} - ${found.emperor} (${found.reign})`;
                const hintEl = document.getElementById('eraHint');
                hintEl.innerHTML = `${hintText} <button onclick="addAutoTags('${found.emperor}', '${found.reign}')" style="border:1px solid #d63384; background:#fff; cursor:pointer; font-size:10px; border-radius:3px;">íƒœê·¸ ì¶”ê°€</button>`;
            }
        }

        function addAutoTags(emperor, reign) {
            const tagsInput = document.getElementById('inTags');
            let currentTags = tagsInput.value.split(',').map(t=>t.trim()).filter(t=>t);
            if(emperor && !currentTags.includes(emperor)) currentTags.push(emperor);
            if(reign) {
                const reigns = reign.split('/');
                reigns.forEach(r => { if(r && !currentTags.includes(r)) currentTags.push(r); });
            }
            tagsInput.value = currentTags.join(', ');
        }

        function updateFormUI() {
            const type = document.getElementById('inType').value;
            const deathInput = document.getElementById('inDeathYear');
            const lblYear = document.getElementById('lblYear');
            
            if (type === 'poet') {
                deathInput.style.display = 'block';
                lblYear.innerText = "ìƒëª°ë…„ë„ (ì¶œìƒ ~ ì‚¬ë§)";
                document.getElementById('optLeft').selected = true;
            } else {
                deathInput.style.display = 'none';
                lblYear.innerText = "ì—°ë„ / ì‹œëŒ€";
                document.getElementById('inDeathYear').value = '';
                document.getElementById('optRight').selected = true;
            }
        }

        function render(query = "", eraFilter = "all") {
            const root = document.getElementById('timeline-root'); root.innerHTML = '';
            const safeQuery = query ? query.trim().toLowerCase() : "";

            const filtered = db.filter(item => {
                const eraMatch = eraFilter === 'all' || item.era === eraFilter;
                if (!safeQuery) return eraMatch;
                let textMatch = false;
                if ((item.name && item.name.toLowerCase().includes(safeQuery)) || 
                    (item.desc && item.desc.toLowerCase().includes(safeQuery)) || 
                    (item.tags && item.tags.join(" ").toLowerCase().includes(safeQuery))) textMatch = true;
                if (!textMatch && item.historyDetail && item.historyDetail.toLowerCase().includes(safeQuery)) textMatch = true;
                if (!textMatch && item.poems) {
                    if(item.poems.some(p => (p.title && p.title.toLowerCase().includes(safeQuery)) || (p.content && p.content.toLowerCase().includes(safeQuery)))) textMatch = true;
                }
                return eraMatch && textMatch;
            });

            filtered.forEach(item => {
                if (item.isShow) {
                    const div = document.createElement('div'); div.className = item.type === 'poet' ? 'container left' : 'container right';
                    const imgTag = item.img ? `<img src="${item.img}" class="thumb-img">` : '';
                    
                    let cardBg = item.cardColor; 
                    if(!cardBg || cardBg === "#ffffff" || cardBg === "") {
                        if (eraTheme[item.era]) cardBg = eraTheme[item.era];
                        else cardBg = (item.type === 'poet' ? config.leftCardColor : config.rightCardColor) || "#ffffff";
                    }

                    let tagHtml = item.tags && item.tags.length > 0 ? '<div class="tag-container">' + item.tags.map(t => `<span class="tag-badge" onclick="searchTag('${t}')">#${t}</span>`).join('') + '</div>' : "";
                    const btns = isAdmin ? `<div class="action-btns" style="display:block;"><span class="btn-text btn-edit" onclick="editItem(${item.id})">[ìˆ˜ì •]</span><span class="btn-text btn-del" onclick="deleteItem(${item.id})">[ì‚­ì œ]</span></div>` : '';

                    let dateDisplay = item.year;
                    if (item.type === 'poet' && item.deathYear) { dateDisplay = `<span style="font-size:0.8em">${item.year}~${item.deathYear}</span>`; }
                    const titleHtml = `${cleanTitle(item.name)} ${item.type==='poet' && item.deathYear ? `<span style='font-size:0.7em; font-weight:normal;'>(${item.year}~${item.deathYear})</span>` : ''}`;

                    div.innerHTML = `<div class="year-bubble" onclick="openContextModal(${item.id})">${dateDisplay}</div><div class="content clearfix" style="background-color:${cardBg};">${imgTag} <span class="era-tag">${item.era}</span><div class="title-text" onclick="openModal(${item.id})">${titleHtml}</div>${tagHtml} <small>${cleanTextForCard(item.desc)}</small>${btns}</div>`;
                    root.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.className = 'minor-row';
                    div.innerHTML = `<div class="minor-dot" data-tooltip="${item.year} : ${item.name}" onclick="openModal(${item.id})"></div>`;
                    root.appendChild(div);
                }
            });
            setTimeout(adjustPadding, 100);
        }

        function populateEraFilter() {
            const eras = [...new Set(db.map(item => item.era).filter(e => e))].sort();
            const select = document.getElementById('eraFilter'); select.innerHTML = '<option value="all">ëª¨ë“  ì‹œëŒ€</option>';
            eras.forEach(era => { select.innerHTML += `<option value="${era}">${era}</option>`; });
        }
        function filterData() { render(document.getElementById('searchInput').value.toLowerCase(), document.getElementById('eraFilter').value); }
        function openModalByName(name) {
            if(currentOpenId !== null) { modalHistory.push(currentOpenId); document.getElementById('backBtn').style.display = 'block'; }
            const item = db.find(d => d.name.trim() === name.trim());
            if(item) openModal(item.id, true); else alert("ì—†ëŠ” ì¹´ë“œì…ë‹ˆë‹¤.");
        }
        function goBack() { if(modalHistory.length > 0) { const prevId = modalHistory.pop(); if(modalHistory.length === 0) document.getElementById('backBtn').style.display = 'none'; openModal(prevId, true); } }
        function searchTag(tag) { document.getElementById('searchInput').value = tag; filterData(); }
        function toggleAdmin() { document.getElementById('adminPanel').style.display = document.getElementById('adminPanel').style.display === 'block' ? 'none' : 'block'; }
        function toggleConfig() { document.getElementById('configForm').style.display = document.getElementById('configForm').style.display === 'none' ? 'block' : 'none'; }
        
        function toggleSimplified(id) { 
            const el = document.getElementById(id); 
            el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
        }
        
        function applyConfigUI() {
            document.getElementById('pageTitle').innerText = config.title; document.getElementById('pageDesc').innerText = config.desc;
            document.title = config.title; 
            document.getElementById('pageFooter').innerHTML = config.copyright || "";
            document.getElementById('cfgCopyright').value = config.copyright || "";
            const badgeLeft = document.getElementById('badgeLeft'); const badgeRight = document.getElementById('badgeRight');
            badgeLeft.innerText = config.leftLabel; badgeRight.innerText = config.rightLabel;
            badgeLeft.style.backgroundColor = config.leftCardColor || "#ffffff"; badgeRight.style.backgroundColor = config.rightCardColor || "#ffffff";
            document.getElementById('cfgTitle').value = config.title; document.getElementById('cfgDesc').value = config.desc;
            document.getElementById('cfgLabelLeft').value = config.leftLabel; document.getElementById('cfgLabelRight').value = config.rightLabel;
            document.getElementById('cfgBgColor').value = config.bgColor || "#fdfbf7"; document.getElementById('cfgBgImage').value = config.bgImage || "";
            document.getElementById('cfgLeftColor').value = config.leftCardColor || "#ffffff"; document.getElementById('cfgRightColor').value = config.rightCardColor || "#ffffff";
            document.getElementById('optLeft').innerText = "ì™¼ìª½: " + config.leftLabel; document.getElementById('optRight').innerText = "ì˜¤ë¥¸ìª½: " + config.rightLabel;
            document.body.style.backgroundColor = config.bgColor || "#fdfbf7";
            document.getElementById('stickyHeader').style.backgroundColor = config.bgColor || "#fdfbf7";
            document.getElementById('pageFooter').style.backgroundColor = config.bgColor || "#fdfbf7";
            if(config.bgImage) {
                document.body.style.backgroundImage = `url('${config.bgImage}')`;
                document.body.style.backgroundSize = config.bgRepeat === 'cover' ? 'cover' : 'auto';
                document.body.style.backgroundRepeat = config.bgRepeat === 'cover' ? 'no-repeat' : 'repeat';
            } else { document.body.style.backgroundImage = 'none'; }
            updateFormUI(); setTimeout(adjustPadding, 100);
        }
        function saveConfig() {
            config.title = document.getElementById('cfgTitle').value; config.desc = document.getElementById('cfgDesc').value;
            config.copyright = document.getElementById('cfgCopyright').value;
            config.leftLabel = document.getElementById('cfgLabelLeft').value; config.rightLabel = document.getElementById('cfgLabelRight').value;
            config.bgColor = document.getElementById('cfgBgColor').value; config.bgImage = document.getElementById('cfgBgImage').value;
            config.bgRepeat = document.getElementById('cfgBgRepeat').value; config.leftCardColor = document.getElementById('cfgLeftColor').value;
            config.rightCardColor = document.getElementById('cfgRightColor').value;
            localStorage.setItem('tangTimelineConfig', JSON.stringify(config)); applyConfigUI(); render(); alert('ì €ì¥ë¨');
        }
        function updateFormUI() {
            const type = document.getElementById('inType').value;
            const deathInput = document.getElementById('inDeathYear');
            const lblYear = document.getElementById('lblYear');
            
            if (type === 'poet') {
                deathInput.style.display = 'block';
                lblYear.innerText = "ìƒëª°ë…„ë„ (ì¶œìƒ ~ ì‚¬ë§)";
            } else {
                deathInput.style.display = 'none';
                lblYear.innerText = "ì—°ë„ / ì‹œëŒ€";
            }
        }

        function editItem(id) {
            const item = db.find(d => d.id === Number(id)); 
            if (!item) { alert("ì˜¤ë¥˜"); return; }
            document.getElementById('adminPanel').style.display = 'block'; 
            document.getElementById('inShow').checked = item.isShow;
            document.getElementById('inType').value = item.type; 
            updateFormUI(); 

            document.getElementById('inYear').value = item.year; 
            document.getElementById('inDeathYear').value = item.deathYear || ""; 
            document.getElementById('inEra').value = item.era;
            document.getElementById('inName').value = item.name; 
            document.getElementById('inRelations').value = item.relations || ""; // [NEW] ê´€ê³„ ë¡œë“œ
            document.getElementById('inTags').value = item.tags ? item.tags.join(", ") : "";
            document.getElementById('inDesc').value = item.desc; 
            document.getElementById('inImg').value = item.img || "";
            document.getElementById('inCardColor').value = item.cardColor || "#ffffff";
            document.getElementById('inLat').value = item.lat || "";
            document.getElementById('inLng').value = item.lng || "";
            document.getElementById('inGeoName').value = item.geoName || "";
            document.getElementById('inGeoDesc').value = item.geoDesc || "";
            document.getElementById('inLocationSearch').value = "";

            const contentBox = document.getElementById('inContent');
            if (item.type === 'poet' && item.poems) {
                contentBox.value = item.poems.map(p => {
                    let text = `${p.title}|${p.content}`;
                    if (p.simplified) text += `\n\n+++\n${p.simplified}`;
                    if (p.desc) text += `\n\n---\n${p.desc}`;
                    return text;
                }).join('\n\n===\n\n');
            } else { contentBox.value = item.historyDetail || ""; }
            editingId = item.id; 
            document.getElementById('btnSave').innerText = "ìˆ˜ì • ì™„ë£Œ"; 
            window.scrollTo(0, 0);
        }

        function saveData() {
            const isShow = document.getElementById('inShow').checked; const type = document.getElementById('inType').value;
            const year = document.getElementById('inYear').value; const era = document.getElementById('inEra').value;
            const deathYear = document.getElementById('inDeathYear').value;
            const name = document.getElementById('inName').value; const tags = document.getElementById('inTags').value.split(',').map(t=>t.trim()).filter(t=>t);
            const relations = document.getElementById('inRelations').value; // [NEW] ê´€ê³„ ì €ì¥
            const desc = document.getElementById('inDesc').value; const img = document.getElementById('inImg').value;
            const cardColor = document.getElementById('inCardColor').value; const rawContent = document.getElementById('inContent').value;
            const lat = document.getElementById('inLat').value; const lng = document.getElementById('inLng').value;
            const geoName = document.getElementById('inGeoName').value; const geoDesc = document.getElementById('inGeoDesc').value;

            if (!year || !name) { alert('í•„ìˆ˜ í•­ëª© ëˆ„ë½'); return; }
            
            let poems = []; let historyDetail = "";
            if (type === 'poet' && rawContent.trim()) { 
                const blocks = rawContent.split('==='); 
                poems = blocks.map(b => { 
                    let temp = b; let pDesc = ""; const descParts = temp.split('---');
                    if (descParts.length > 1) { pDesc = descParts.slice(1).join('---').trim(); temp = descParts[0]; }
                    let pSimp = ""; const simpParts = temp.split('+++');
                    if (simpParts.length > 1) { pSimp = simpParts.slice(1).join('+++').trim(); temp = simpParts[0]; }
                    const idx = temp.indexOf('|'); 
                    if (idx !== -1) { return { title: temp.substring(0, idx).trim(), content: temp.substring(idx + 1).trim(), simplified: pSimp, desc: pDesc }; }
                    return null; 
                }).filter(p => p); 
            } else { historyDetail = rawContent.trim(); }
            
            const newData = { id: editingId || Date.now(), year, deathYear, era, type, name, tags, relations, desc, img, isShow, cardColor, poems, historyDetail, lat, lng, geoName, geoDesc };
            
            if (editingId) { const idx = db.findIndex(d => d.id === editingId); if (idx !== -1) db[idx] = newData; } else { db.push(newData); }
            saveToLocal(); render(); populateEraFilter(); clearForm();
        }

        function clearForm() {
            document.getElementById('inYear').value = ''; document.getElementById('inDeathYear').value = ''; 
            document.getElementById('inName').value = ''; document.getElementById('inTags').value = ''; 
            document.getElementById('inDesc').value = ''; document.getElementById('inImg').value = ''; 
            document.getElementById('inRelations').value = '';
            document.getElementById('inContent').value = ''; document.getElementById('inLat').value = ''; 
            document.getElementById('inLng').value = ''; document.getElementById('inGeoName').value = ''; 
            document.getElementById('inGeoDesc').value = ''; document.getElementById('inLocationSearch').value = '';
            document.getElementById('eraHint').innerHTML = '';
            document.getElementById('inShow').checked = true; document.getElementById('inCardColor').value = "#ffffff";
            editingId = null; document.getElementById('btnSave').innerText = "ì €ì¥";
            updateFormUI();
        }
        function deleteItem(id) { if(confirm('ì‚­ì œ?')) { db = db.filter(i => i.id !== id); saveToLocal(); render(); populateEraFilter(); } }
        function resetAllData() { if(confirm('ì „ì²´ ì‚­ì œ?')) { localStorage.removeItem('tangTimelineDB'); location.reload(); } }

        function openModal(id, keepHistory = false) {
            const item = db.find(d => d.id === id); if (!item) return;
            if (!keepHistory) { modalHistory = []; document.getElementById('backBtn').style.display = 'none'; }
            currentOpenId = id;
            document.getElementById('floatingCloseBtn').style.display = 'block';
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const editBtnHtml = isAdmin ? `<div style="text-align:right; margin-bottom:10px;"><span class="btn-text btn-edit" onclick="editItem(${item.id}); closeModal('detailModal');">[ìˆ˜ì •]</span><span class="btn-text btn-del" onclick="deleteItem(${item.id}); closeModal('detailModal');">[ì‚­ì œ]</span></div>` : '';
            
            let dateStr = item.year;
            if (item.type === 'poet' && item.deathYear) dateStr += ` ~ ${item.deathYear}`;
            document.getElementById('mName').innerHTML = `${cleanTitle(item.name)} <span style='font-size:0.7em; color:#888;'>(${dateStr})</span>`;
            
            document.getElementById('mDesc').innerHTML = editBtnHtml + parseText(item.desc, false);
            const tagsHtml = item.tags ? item.tags.map(t => `<span class="tag-badge">#${t}</span>`).join('') : "";
            document.getElementById('mTags').innerHTML = tagsHtml;
            const mImg = document.getElementById('mImg');
            if(item.img) { mImg.src = item.img; mImg.style.display = 'block'; } else { mImg.style.display = 'none'; }
            
            const area = document.getElementById('mContentArea'); area.innerHTML = '';
            if (item.type === 'poet' && item.poems) {
                item.poems.forEach((p, index) => {
                    let isMatch = true;
                    if (query) {
                        const matchTitle = p.title && p.title.toLowerCase().includes(query);
                        const matchContent = p.content && p.content.toLowerCase().includes(query);
                        if (!matchTitle && !matchContent) { isMatch = false; }
                    }
                    const details = document.createElement('details'); details.className = 'outer-details';
                    if (!isMatch) { details.style.display = 'none'; } else { if (query) details.open = true; }
                    let body = `<div class="hanja-text">${parseText(p.content, true)}</div>`; 
                    if (p.simplified) { const simpId = `simp_${item.id}_${index}`; body += `<span class="simp-btn" onclick="toggleSimplified('${simpId}')">ğŸ‡¨ğŸ‡³ ê°„ì²´ì ë³´ê¸°</span>`; body += `<div id="${simpId}" class="simplified-box"><div style="margin-top:5px;">${parseText(p.simplified, true)}</div></div>`; }
                    if(p.desc) { body += `<details class="inner-details"><summary class="inner-summary">[í•´ì„¤ ë³´ê¸°]</summary><div class="explain-text">${parseText(p.desc, false)}</div></details>`; }
                    details.innerHTML = `<summary class="outer-summary">${cleanTitle(p.title)}</summary><div class="poem-body">${body}</div>`;
                    area.appendChild(details);
                });
            } else if (item.historyDetail) { area.innerHTML = `<div class="poem-body">${parseText(item.historyDetail, false)}</div>`; }
            
            const miniMapWrapper = document.getElementById('miniMapWrapper');
            const miniMapCaption = document.getElementById('miniMapCaption');
            if(item.lat && item.lng) {
                miniMapWrapper.style.display = 'block';
                miniMapCaption.innerText = item.geoDesc || "";
                setTimeout(() => {
                    if (miniMap) { miniMap.remove(); }
                    miniMap = L.map('miniMap').setView([item.lat, item.lng], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(miniMap);
                    const markerText = item.geoName || item.name;
                    L.marker([item.lat, item.lng]).addTo(miniMap).bindPopup(`<b>${markerText}</b>`).openPopup();
                }, 200);
            } else { miniMapWrapper.style.display = 'none'; }

            document.getElementById('detailModal').style.display = "block";
        }

        // [NEW] ê´€ê³„ë„ ì‹œê°í™” ë¡œì§
        function openRelModal() {
            document.getElementById('relModal').style.display = 'block';
            
            const nodes = [];
            const edges = [];
            const ids = new Set(); // ì¤‘ë³µ ë…¸ë“œ ë°©ì§€ìš©

            // 1. ëª¨ë“  ì¸ë¬¼ì„ ë…¸ë“œë¡œ ì¶”ê°€
            db.forEach(item => {
                if(item.type === 'poet') {
                    const cleanName = cleanTitle(item.name);
                    if(!ids.has(cleanName)) {
                        // ì‹œëŒ€ë³„ ìƒ‰ìƒ ì ìš©
                        let color = eraTheme[item.era] || '#ddd';
                        nodes.push({ id: cleanName, label: cleanName, color: { background: color }, shape: 'dot', size: 25 });
                        ids.add(cleanName);
                    }
                }
            });

            // 2. ê´€ê³„(ì—£ì§€) ì—°ê²°
            db.forEach(item => {
                const source = cleanTitle(item.name);
                if(item.relations) {
                    // "ì´ë¦„:ê´€ê³„, ì´ë¦„:ê´€ê³„" íŒŒì‹±
                    const rels = item.relations.split(',').map(r => r.trim());
                    rels.forEach(r => {
                        const parts = r.split(':');
                        if(parts.length >= 1) {
                            const target = parts[0].trim();
                            const label = parts[1] ? parts[1].trim() : "";
                            
                            // íƒ€ê²Ÿ ë…¸ë“œê°€ DBì— ì—†ì–´ë„ ë…¸ë“œ ìƒì„± (ê°€ìƒ ì¸ë¬¼ ë“±)
                            if(!ids.has(target)) {
                                nodes.push({ id: target, label: target, color: '#eee', shape: 'dot', size: 15 });
                                ids.add(target);
                            }

                            edges.push({ from: source, to: target, label: label, arrows: 'to' });
                        }
                    });
                }
            });

            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: { font: { size: 16, face: 'KoPub Batang' } },
                edges: { color: '#888', font: { size: 12, align: 'middle' }, smooth: { type: 'continuous' } },
                physics: { stabilization: false, barnesHut: { springLength: 200 } }
            };

            const container = document.getElementById('network');
            const network = new vis.Network(container, data, options);

            // ë…¸ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ì¸ë¬¼ ëª¨ë‹¬ ì—´ê¸°
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeName = params.nodes[0];
                    // ì´ë¦„ìœ¼ë¡œ DB ê²€ìƒ‰ (ë…¸ë“œ ì´ë¦„ì´ ê³§ ID)
                    const item = db.find(d => cleanTitle(d.name) === nodeName);
                    if(item) {
                        closeModal('relModal'); // ê´€ê³„ë„ ë‹«ê³ 
                        openModal(item.id);     // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
                    }
                }
            });
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = "none"; 
            document.getElementById('floatingCloseBtn').style.display = 'none';
            if (id === 'detailModal') { document.getElementById('mContentArea').innerHTML = ''; document.getElementById('mDesc').innerHTML = ''; }
        }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) { closeModal(e.target.id); } }
        init();
    </script>
</body>
</html>
