<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ íƒ€ì„ë¼ì¸ DB</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=KoPub+Batang:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>

    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { box-sizing: border-box !important; }
        :root { --line-color: #8B0000; --text-color: #333; --edit-color: #0056b3; --bg-color: #fdfbf7; }
        body { font-family: 'KoPub Batang', 'Noto Serif KR', serif; color: var(--text-color); margin: 0; padding: 0; background-color: var(--bg-color); transition: background 0.3s; }
        
        /* [í—¤ë”] */
        #stickyHeader { position: -webkit-sticky; position: sticky; top: 0; z-index: 1000; background-color: var(--bg-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding-top: 20px; transition: background 0.3s; }
        header { text-align: center; margin-bottom: 10px; padding: 0 20px;}
        h1 { color: var(--line-color); margin: 0 0 5px 0; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); }
        .page-desc { color: #555; font-size: 0.95rem; margin-bottom: 15px; font-weight: bold; }
        
        .search-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; position: relative; }
        .search-wrapper { position: relative; display: inline-block; }
        .search-input { padding: 8px 30px 8px 15px; border: 2px solid var(--line-color); border-radius: 20px; width: 220px; outline: none; }
        .search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; display: none; }
        .search-clear:hover { color: red; }

        .filter-select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .btn-common { background: #555; color: white; border: none; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: transform 0.1s; }
        .btn-common:hover { transform: scale(1.05); }
        .btn-map { background: #28a745; } .btn-rel { background: #6f42c1; } .btn-stat { background: #17a2b8; }

        .timeline-headers { position: relative; max-width: 1000px; width: 100%; height: 60px; margin: 0 auto; padding-bottom: 15px; }
        #badgeLeft, #badgeRight { position: absolute; top: 0; display: inline-block; padding: 12px 0; width: 160px; border-radius: 15px; font-weight: bold; font-size: 1.2rem; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); text-align: center; background-color: #fff; }
        #badgeLeft { right: 50%; margin-right: 50px; } #badgeRight { left: 50%; margin-left: 50px; }

        /* [íƒ€ì„ë¼ì¸] */
        .timeline { position: relative; max-width: 1000px; margin: 0 auto; padding-bottom: 80px; padding-top: 20px; }
        .timeline::after { content: ''; position: absolute; width: 4px; background-color: var(--line-color); top: 0; bottom: 0; left: 50%; margin-left: -2px; z-index: 0; }
        .container { padding: 10px 50px; position: relative; width: 50%; }
        .left { left: 0; text-align: right; } .right { left: 50%; text-align: left; }
        
        .content { padding: 15px; position: relative; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 2px 2px 5px rgba(0,0,0,0.05); background: white; text-align: left; transition: transform 0.2s; cursor: pointer; }
        .left .content { text-align: right; }
        .content:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; }
        
        .year-bubble { position: absolute; width: 50px; height: 50px; background-color: white; border: 3px solid var(--line-color); border-radius: 50%; z-index: 10; text-align: center; line-height: 50px; font-weight: bold; font-size: 14px; color: var(--line-color); top: 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s;}
        .year-bubble:hover { background-color: var(--line-color); color: white; transform: scale(1.1); }
        .left .year-bubble { right: -25px; } .right .year-bubble { left: -25px; }
        .minor-row { width: 100%; height: 20px; position: relative; margin: 5px 0; }
        .minor-dot { position: absolute; left: 50%; margin-left: -6px; width: 12px; height: 12px; background-color: white; border: 2px solid #aaa; border-radius: 50%; cursor: pointer; z-index: 5; }
        .minor-dot:hover { background-color: var(--edit-color); transform: scale(1.5); }

        .thumb-img { max-width: 80px; max-height: 80px; display: block; margin: 5px; border: 1px solid #ddd; padding: 2px; background: #fff; float: left; margin-right: 10px;}
        .left .thumb-img { float: left; margin-right: 15px; } .right .thumb-img { float: right; margin-left: 15px; }
        .era-tag { font-size: 0.8em; color: #666; display: block; margin-bottom: 2px; font-weight: bold;}
        .title-text { font-size: 1.3em; font-weight: bold; color: #000; border-bottom: 1px dashed #bbb; }
        .tag-container { margin-top: 5px; }
        .tag-badge { display: inline-block; font-size: 0.75rem; background: #eef; color: #0044cc; padding: 2px 6px; border-radius: 4px; margin-right: 4px; }
        .clearfix::after { content: ""; clear: both; display: table; }

        /* [ê´€ë¦¬ì íŒ¨ë„] */
        .admin-btn { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #333; color: white; border: none; cursor: pointer; z-index: 2000; border-radius: 5px; display: none; }
        .login-trigger { position: fixed; bottom: 10px; right: 10px; opacity: 0.3; font-size: 12px; cursor: pointer; z-index: 2000;}
        #adminPanel { display: none; position: fixed; top: 60px; right: 20px; width: 500px; background: white; border: 2px solid #333; padding: 20px; z-index: 2100; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; font-family: sans-serif; border-radius: 8px;}
        .form-group { margin-bottom: 10px; } .form-group label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 4px;}
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; font-size: 14px; border-radius: 4px; }
        
        .tool-btn { color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 3px; margin-bottom: 3px; }
        .btn-green { background-color: #28a745; } .btn-blue { background-color: #007bff; } .btn-purple { background-color: #6f42c1; } .btn-orange { background-color: #fd7e14; }
        .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .admin-actions button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color:white;}
        .btn-save { background: #218838; grid-column: span 1; } .btn-cancel { background: #666; grid-column: span 1; }
        .btn-down { background: #007bff; } .btn-reset { background: #dc3545; grid-column: span 2; }
        
        /* [ëª¨ë‹¬ ë° ê¸°ëŠ¥ì°½] */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fff; margin: 3% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; position: relative; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #floatingCloseBtn { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 3100; background-color: rgba(0, 0, 0, 0.8); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; }
        
        /* [íŠ¹ìˆ˜ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼] */
        #map { width: 100%; height: 500px; border-radius: 8px; border: 2px solid #333; }
        #network { width: 100%; height: 600px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }
        #miniMap { width: 100%; height: 200px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 10px; margin-top: 10px;}
        #cropperModal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); }
        .crop-container { width:90%; height:70vh; margin:5vh auto; }
        .crop-controls { text-align:center; margin-top:10px; }
        .rel-badge { display:inline-block; padding: 3px 8px; margin: 2px; border: 1px solid #ccc; background: #f8f9fa; border-radius: 15px; cursor: pointer; font-size: 0.8rem; }
        .rel-badge:hover { background: #e2e6ea; }

        /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .poem-body { padding: 15px; white-space: pre-wrap; line-height: 2.2; color: #444; border-top: 1px solid #eee; }
        .hanja-text { font-size: 1.2rem; color: #222; margin-bottom: 5px; font-family: 'KoPub Batang', serif; }
        .source-credit { font-size: 0.8rem; color: #888; text-align: right; border-top: 1px dashed #ddd; padding-top: 5px; margin-top: 15px;}
        ruby { display: inline-block; text-align: center; margin: 0 2px; ruby-position: under; } rt { font-size: 0.6em; color: #777; }
        .img-card { display: block; margin: 15px auto; text-align: center; max-width: 90%; } .img-card img { max-width: 100%; border-radius: 5px;}
        .stat-table { width: 100%; border-collapse: collapse; margin-top: 10px;} .stat-table th, .stat-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .timeline-headers { display: flex; padding: 0 10px; }
            #badgeLeft, #badgeRight { position: static; width: 48%; margin: 0 1%; }
            .container { padding: 10px 20px; }
            .thumb-img, .tag-container, .action-btns { display: none !important; }
            .content { text-align: center; padding: 10px; }
            .left .content, .right .content { text-align: center; }
        }
    </style>
</head>
<body>
    <div id="stickyHeader">
        <header>
            <h1 id="pageTitle">ë‚˜ë§Œì˜ ì—­ì‚¬ ì—°í‘œ</h1>
            <p id="pageDesc" class="page-desc">ë¡œë”© ì¤‘...</p>
            <div class="search-bar">
                <div class="search-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="ê²€ìƒ‰..." onkeyup="filterData()">
                    <span id="clearSearchBtn" class="search-clear" onclick="clearSearch()">âœ–</span>
                </div>
                <select id="eraFilter" class="filter-select" onchange="filterData()"> <option value="all">ëª¨ë“  ì‹œëŒ€</option> </select>
                <button class="btn-common btn-rel" onclick="openRelModal()">ğŸ•¸ï¸ ê´€ê³„ë„</button>
                <button class="btn-common btn-map" onclick="openMapModal()">ğŸ—ºï¸ ì§€ë„</button>
                <button class="btn-common btn-stat" onclick="openStatModal()">ğŸ“Š í†µê³„</button>
                <button class="btn-common" style="background:#333" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </header>
        <div class="timeline-headers"><span id="badgeLeft">Left</span><span id="badgeRight">Right</span></div>
    </div>

    <button id="floatingCloseBtn" onclick="closeModal('detailModal')">âŒ ë‹«ê¸°</button>
    <button id="adminToggle" class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬</button>

    <div id="adminPanel">
        <div class="config-section">
            <button class="config-toggle" onclick="document.getElementById('configForm').style.display='block'" style="width:100%; padding:5px;">ğŸ› ï¸ ì„¤ì • ì—´ê¸°</button>
            <div id="configForm" style="display:none; margin-top:10px;">
                <div class="form-group"><label>ì œëª©</label><input type="text" id="cfgTitle"></div>
                <div class="form-group"><label>ì•ˆë‚´ë¬¸</label><textarea id="cfgDesc" rows="2"></textarea></div>
                <div class="form-group"><label>ì €ì‘ê¶Œ</label><input type="text" id="cfgCopyright"></div>
                <div class="form-group" style="display:flex; gap:5px;"><div style="flex:1"><label>ì¢Œì¸¡ëª…</label><input type="text" id="cfgLabelLeft"></div><div style="flex:1"><label>ìš°ì¸¡ëª…</label><input type="text" id="cfgLabelRight"></div></div>
                <button class="btn-save" style="width:100%" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
            </div>
        </div>
        <hr>
        <h3 style="margin-top:10px;">ë°ì´í„° ì…ë ¥</h3>
        <div class="form-group" style="background:#fff3cd; padding:5px; border-radius:5px;"><label>ğŸ¨ ì¹´ë“œìƒ‰</label><input type="color" id="inCardColor" value="#ffffff" style="width:100%;"></div>
        <div class="form-group"><label><input type="checkbox" id="inShow" checked> í¬ê²Œ ë³´ì´ê¸°</label></div>
        
        <div class="form-group" style="background:#e8f5e9; padding:10px; border-radius:5px;">
             <label>ğŸ“ ì§€ë„ ìœ„ì¹˜</label>
             <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" id="inLocationSearch" placeholder="ì˜ˆ: Chang'an" style="flex:1;"><button type="button" onclick="searchLocation()" class="btn-green" style="color:white;">ğŸ”</button></div>
             <div style="display:flex; gap:5px;"><input type="number" id="inLat" placeholder="ìœ„ë„"><input type="number" id="inLng" placeholder="ê²½ë„"></div>
             <input type="text" id="inGeoName" placeholder="ì¥ì†Œëª…" style="margin-top:5px;">
        </div>

        <div class="form-group"><select id="inType"><option value="poet">ì™¼ìª½</option><option value="history">ì˜¤ë¥¸ìª½</option></select></div>
        <div class="form-group"><div style="display:flex; gap:5px;"><input type="number" id="inYear" placeholder="ì—°ë„" style="flex:1;" oninput="detectEra()"><input type="text" id="inEra" placeholder="ì‹œëŒ€ (ìë™)" style="flex:1;"></div></div>
        <div class="form-group"><div id="eraHint" style="font-size:0.8rem; color:#d63384;"></div></div>
        
        <div class="form-group"><input type="text" id="inName" placeholder="ì´ë¦„/ì œëª©"></div>
        <div class="form-group"><label>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„</label><input type="text" id="inRelations" placeholder="ì˜ˆ: ë‘ë³´:ì¹œêµ¬, ë§¹í˜¸ì—°:ì¡´ê²½"></div>
        
        <div class="form-group"><input type="text" id="inTags" placeholder="íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)"></div>
        <div class="form-group"><textarea id="inDesc" rows="2" placeholder="ìš”ì•½"></textarea></div>
        
        <div class="form-group">
            <label>ì´ë¯¸ì§€</label>
            <input type="text" id="inImg" placeholder="ì´ë¯¸ì§€ URL">
            <div style="margin-top:5px; display:flex; gap:5px; align-items:center;">
                <button type="button" onclick="document.getElementById('imgInput').click()" style="background:#666; color:white; border:none; padding:5px 10px; border-radius:3px;">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</button>
                <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImageSelect(this)">
            </div>
        </div>

        <div class="form-group">
            <label>ìƒì„¸ ë‚´ìš© (ë„êµ¬)</label>
            <div style="margin-bottom:5px;">
                <button class="tool-btn btn-green" onclick="autoPinyin()">ë³‘ìŒ</button> 
                <button class="tool-btn btn-blue" onclick="autoTone()">í‰ì¸¡</button> 
                <button class="tool-btn btn-orange" onclick="insertAudio()">ì˜¤ë””ì˜¤</button> 
                <button class="tool-btn btn-purple" onclick="insertLicense()">ì¶œì²˜</button>
            </div>
            <textarea id="inContent" rows="8" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
        </div>

        <div class="admin-actions">
            <button id="btnSave" class="btn-save" onclick="saveData()">ì €ì¥</button>
            <button class="btn-cancel" onclick="clearForm()">ì·¨ì†Œ</button>
            <button class="btn-down" onclick="exportData()">ğŸ’¾ DB ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn-reset" onclick="resetAllData()">âš ï¸ ì´ˆê¸°í™”</button>
        </div>
    </div>
    
    <div class="timeline" id="timeline-root"></div>
    <footer id="pageFooter"></footer>
    <div class="login-trigger" onclick="adminLogin()">Admin</div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button class="back-btn" id="backBtn" onclick="goBack()">â¬… ë’¤ë¡œ</button><span class="close" onclick="closeModal('detailModal')">&times;</span>
            <div style="clear:both;"></div><img id="mImg" class="img-card" style="display:none;">
            <h2 id="mName" style="text-align:center;"></h2><div id="mTags" style="text-align:center; margin-bottom:10px;"></div>
            <div id="mDesc" style="background:#f5f5f5; padding:15px; border-radius:5px; white-space: pre-wrap;"></div>
            
            <div id="miniMapWrapper" style="display:none;">
                <div id="miniMap"></div><div id="miniMapCaption" style="text-align:center; font-size:0.8rem; color:#666;"></div>
            </div>
            <div id="relContainer" style="text-align:center; margin-top:10px;"></div>
            <hr>
            <div id="mContentArea"></div>
        </div>
    </div>
    
    <div id="contextModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('contextModal')">&times;</span><h3 style="text-align:center;">âŒ› <span id="ctxTargetYear"></span>ë…„ ì „í›„</h3><ul id="ctxList" class="ctx-list"></ul></div></div>
    <div id="statModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('statModal')">&times;</span><h3>ğŸ“Š ë°ì´í„° í†µê³„</h3><div id="statContent"></div></div></div>
    <div id="mapModal" class="modal"><div class="modal-content" style="max-width: 900px;"><span class="close" onclick="closeModal('mapModal')">&times;</span><h3>ğŸ—ºï¸ ì—­ì‚¬ ì§€ë„</h3><div id="map"></div></div></div>
    <div id="relModal" class="modal"><div class="modal-content" style="max-width: 1000px;"><span class="close" onclick="closeModal('relModal')">&times;</span><h3>ğŸ•¸ï¸ ì¸ë¬¼ ê´€ê³„ë„</h3><div id="network"></div></div></div>
    <div id="cropperModal"><div class="crop-container"><div style="height:80%;"><img id="cropImage" style="max-width:100%;"></div><div class="crop-controls"><button class="btn-green tool-btn" style="font-size:16px;" onclick="performCrop()">âœ‚ï¸ ìë¥´ê¸° & ì €ì¥</button><button class="btn-cancel tool-btn" style="font-size:16px;" onclick="document.getElementById('cropperModal').style.display='none'">ì·¨ì†Œ</button></div></div></div>

    <script>
        const defaultConfig = { title: "ë‹¹ë‚˜ë¼ ì—­ì‚¬ì™€ ì‹œì¸ ì—°í‘œ", desc: "ë‚˜ë§Œì˜ ì—­ì‚¬ ë°ì´í„°ë² ì´ìŠ¤", leftLabel: "ì‹œì¸ / ì‘í’ˆ", rightLabel: "ì—­ì‚¬ / ì‚¬ê±´", bgColor: "#fdfbf7", bgImage: "", bgRepeat: "repeat", leftCardColor: "#ffffff", rightCardColor: "#ffffff", copyright: "" };
        const tangChronology = [{s:618,e:626,n:"ì´ˆë‹¹"},{s:627,e:712,n:"ì´ˆë‹¹"},{s:713,e:765,n:"ì„±ë‹¹"},{s:766,e:835,n:"ì¤‘ë‹¹"},{s:836,e:907,n:"ë§Œë‹¹"}];
        let db=[], config={}, editingId=null, modalHistory=[], currentOpenId=null;
        let isAdmin = false; 
        let map = null; let miniMap = null; let markersLayer = null; let cropper = null; 

        async function init() {
            try {
                try { const r = await fetch('database.json'); if(r.ok) { const j = await r.json(); db = j.data || []; config = j.config || defaultConfig; } else throw new Error("No DB"); } 
                catch (e) { const s = localStorage.getItem('tangTimelineDB'); db = s ? JSON.parse(s) : []; const c = localStorage.getItem('tangTimelineConfig'); config = c ? JSON.parse(c) : {...defaultConfig}; }
                applyConfigUI(); populateEraFilter(); render();
                document.getElementById('pageDesc').innerText = config.desc; document.getElementById('adminToggle').style.display = 'none';
                adjustPadding(); window.addEventListener('resize', adjustPadding);
            } catch (e) { console.error(e); render(); }
        }

        function adjustPadding() { document.getElementById('timeline-root').style.paddingTop = '20px'; }
        
        async function adminLogin() {
            if (isAdmin) return;
            const p = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (!p) return;
            const h = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p)))).map(b => b.toString(16).padStart(2, '0')).join('');
            if (h === "6eb20c53054a7218e6731761b7539d9e38f6f5e39e53c2d78e0edd732de650f2") { isAdmin = true; document.getElementById('adminToggle').style.display = 'block'; alert("ê´€ë¦¬ì ëª¨ë“œ"); render(); } else alert("ì˜¤ë¥˜");
        }

        function saveToLocal() { db.sort((a, b) => a.year - b.year); localStorage.setItem('tangTimelineDB', JSON.stringify(db)); }
        function exportData() { const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ data: db, config: config })); const n = document.createElement('a'); n.href = d; n.download = "database.json"; document.body.appendChild(n); n.click(); n.remove(); }
        
        // [v13.1 ë³µêµ¬] ìë™ ì‹œëŒ€ ê³„ì‚°
        function detectEra() {
            const y = parseInt(document.getElementById('inYear').value); if(!y) return;
            const f = tangChronology.find(i => y >= i.s && y <= i.e);
            if(f) { document.getElementById('inEra').value = f.n; document.getElementById('eraHint').innerText = `ğŸ’¡ ${f.n} ì‹œê¸°ì…ë‹ˆë‹¤.`; }
        }

        // [ê¸°ëŠ¥] ì§€ë„ ê²€ìƒ‰
        async function searchLocation() {
            const q = document.getElementById('inLocationSearch').value; if(!q) return;
            try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`); const j = await r.json(); if(j.length>0) { document.getElementById('inLat').value = parseFloat(j[0].lat).toFixed(4); document.getElementById('inLng').value = parseFloat(j[0].lon).toFixed(4); alert("ë°œê²¬: "+j[0].display_name); } else alert("ì‹¤íŒ¨"); } catch(e){alert("ì˜¤ë¥˜");}
        }

        // [ê¸°ëŠ¥] ì´ë¯¸ì§€ í¬ë¡­
        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cropperModal').style.display = 'block';
                    const img = document.getElementById('cropImage'); img.src = e.target.result;
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function performCrop() {
            if(!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width:150, height:150 });
            document.getElementById('inImg').value = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('cropperModal').style.display='none';
        }

        // [ê¸°ëŠ¥] ë„êµ¬ ëª¨ìŒ
        function autoPinyin() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'symbol', nonZh: 'consecutive' }); i.setRangeText(t.map(x => x.isZh ? `${x.origin}(${x.pinyin})` : x.origin).join('')); }
        function autoTone() { const i = document.getElementById('inContent'); const s = i.selectionStart; const e = i.selectionEnd; if(s===e) return alert("ì„ íƒí•„ìš”"); const t = pinyinPro.pinyin(i.value.substring(s,e), { type: 'all', toneType: 'num', nonZh: 'consecutive' }); i.setRangeText(t.map(x => { if (!x.isZh) return x.origin; return `${x.origin}(${/[34]$/.test(x.pinyin)?'â—':'â—‹'})`; }).join('')); }
        function insertAudio() { let u = prompt("ì˜¤ë””ì˜¤ íŒŒì¼ëª… (í™•ì¥ìí¬í•¨)"); if(u) { if(!u.startsWith('http')) u='https://tangshi.kr/mp3/'+u; document.getElementById('inContent').setRangeText(`{{ì˜¤ë””ì˜¤|${u}}}`); } }
        function insertLicense() { document.getElementById('inContent').setRangeText(`\n### ìë£Œì¶œì²˜: ë™ì–‘ê³ ì „ì¢…í•©DB ###`); }

        // [í…ìŠ¤íŠ¸ ì²˜ë¦¬]
        function cleanTitle(t) { return t ? t.replace(/\[.*?\]/g, '').trim() : ""; }
        function cleanTextForCard(t) { if(!t) return ""; return t.replace(/\{\{.*?\}\}/g, '').replace(/###.*?###/g, '').replace(/%%(.*?)%%/g, '$1').replace(/\$\$(.*?)\$\$/g, '$1').substring(0, 40)+"..."; }
        function parseText(t, m=false) { 
            if(!t) return "";
            if(m) t = t.replace(/([\u4E00-\u9FFF])\(([^)]+)\)/g, "<ruby>$1<rt>$2</rt></ruby>"); 
            return t.replace(/\{\{ì´ë¯¸ì§€\|(.*?)\|(.*?)\}\}/g, '<div class="img-card"><img src="$1"><br><small>$2</small></div>')
                    .replace(/%%(.*?)%%/g, '<b>$1</b>').replace(/\$\$(.*?)\$\$/g, '<span style="color:#888;font-style:italic;">$1</span>')
                    .replace(/\{\{ì˜¤ë””ì˜¤\|(.*?)\}\}/g, '<audio controls src="$1" style="width:100%;margin-top:10px;"></audio>')
                    .replace(/###(.*?)###/g, '<div class="source-credit">$1</div>')
                    .replace(/\[\[(.*?)\]\]/g, '<span class="wiki-link" onclick="openModalByName(\'$1\')">$1</span>'); 
        }

        // [ê´€ë¦¬ì ê¸°ëŠ¥]
        function updateFormUI() {}
        function editItem(id) {
            const item = db.find(d => d.id == id); if (!item) return;
            document.getElementById('adminPanel').style.display = 'block'; 
            document.getElementById('inShow').checked = item.isShow;
            document.getElementById('inType').value = item.type; 
            document.getElementById('inYear').value = item.year; document.getElementById('inEra').value = item.era; 
            document.getElementById('inName').value = item.name; document.getElementById('inTags').value = item.tags ? item.tags.join(", ") : "";
            document.getElementById('inRelations').value = item.relations || ""; 
            document.getElementById('inDesc').value = item.desc; document.getElementById('inImg').value = item.img||"";
            document.getElementById('inCardColor').value = item.cardColor||"#ffffff";
            document.getElementById('inLat').value = item.lat || ""; document.getElementById('inLng').value = item.lng || "";
            document.getElementById('inGeoName').value = item.geoName || "";

            const contentBox = document.getElementById('inContent');
            if (item.type === 'poet' && item.poems) {
                contentBox.value = item.poems.map(p => {
                    let text = `${p.title}|${p.content}`;
                    if (p.simplified) text += `\n\n+++\n${p.simplified}`;
                    if (p.desc) text += `\n\n---\n${p.desc}`;
                    return text;
                }).join('\n\n===\n\n');
            } else { contentBox.value = item.historyDetail || ""; }
            editingId = item.id; document.getElementById('btnSave').innerText = "ìˆ˜ì • ì™„ë£Œ"; window.scrollTo(0, 0);
        }

        function saveData() {
            const isShow = document.getElementById('inShow').checked; const type = document.getElementById('inType').value;
            const year = document.getElementById('inYear').value; const era = document.getElementById('inEra').value;
            const name = document.getElementById('inName').value; const tags = document.getElementById('inTags').value.split(',').map(t=>t.trim()).filter(t=>t);
            const relations = document.getElementById('inRelations').value;
            const desc = document.getElementById('inDesc').value; const img = document.getElementById('inImg').value;
            const cardColor = document.getElementById('inCardColor').value; const rawContent = document.getElementById('inContent').value;
            const lat = document.getElementById('inLat').value; const lng = document.getElementById('inLng').value;
            const geoName = document.getElementById('inGeoName').value;

            if (!year || !name) { alert('í•„ìˆ˜ í•­ëª© ëˆ„ë½'); return; }
            
            let poems = []; let historyDetail = "";
            if (type === 'poet') {
                if (rawContent.trim()) {
                    const blocks = rawContent.split('==='); 
                    poems = blocks.map(b => { 
                        let temp = b; let pDesc = ""; const descParts = temp.split('---');
                        if (descParts.length > 1) { pDesc = descParts.slice(1).join('---').trim(); temp = descParts[0]; }
                        let pSimp = ""; const simpParts = temp.split('+++');
                        if (simpParts.length > 1) { pSimp = simpParts.slice(1).join('+++').trim(); temp = simpParts[0]; }
                        const idx = temp.indexOf('|'); 
                        if (idx !== -1) return { title: temp.substring(0, idx).trim(), content: temp.substring(idx + 1).trim(), simplified: pSimp, desc: pDesc }; 
                        return { title: 'ë‚´ìš©', content: temp.trim(), simplified: pSimp, desc: pDesc }; 
                    }).filter(p => p);
                }
            } else { historyDetail = rawContent.trim(); }
            
            const newData = { id: editingId || Date.now(), year, era, type, name, tags, relations, desc, img, isShow, cardColor, poems, historyDetail, lat, lng, geoName };
            if (editingId) { const idx = db.findIndex(d => d.id == editingId); if (idx !== -1) db[idx] = newData; } else { db.push(newData); }
            saveToLocal(); render(); populateEraFilter(); clearForm();
        }

        function clearForm() {
            document.getElementById('inYear').value = ''; document.getElementById('inName').value = '';
            document.getElementById('inTags').value = ''; document.getElementById('inRelations').value = '';
            document.getElementById('inDesc').value = ''; document.getElementById('inImg').value = ''; document.getElementById('inContent').value = ''; 
            document.getElementById('inLat').value = ''; document.getElementById('inLng').value = ''; document.getElementById('inGeoName').value = '';
            document.getElementById('inShow').checked = true; document.getElementById('inCardColor').value = "#ffffff";
            editingId = null; document.getElementById('btnSave').innerText = "ì €ì¥";
        }
        
        function resetAllData() { if(confirm('ì „ì²´ ì‚­ì œ?')) { localStorage.removeItem('tangTimelineDB'); location.reload(); } }

        function openModal(id, keepHistory = false) {
            try {
                const item = db.find(d => d.id == id); if (!item) return;
                if (!keepHistory) { modalHistory = []; document.getElementById('backBtn').style.display = 'none'; }
                currentOpenId = id;

                let nameHtml = `${cleanTitle(item.name)} <span style='font-size:0.7em; color:#888;'>(${item.year})</span>`;
                document.getElementById('mName').innerHTML = nameHtml;
                
                const editBtn = isAdmin ? `<div style="text-align:right; margin-bottom:10px;">
                    <span class="btn-text btn-edit" onclick="editItem(${item.id}); closeModal('detailModal');">[ìˆ˜ì •]</span>
                    <span class="btn-text btn-del" onclick="deleteItem(${item.id}); closeModal('detailModal');">[ì‚­ì œ]</span>
                </div>` : '';
                document.getElementById('mDesc').innerHTML = editBtn + parseText(item.desc, false);
                document.getElementById('mTags').innerHTML = item.tags ? item.tags.map(t => `<span class="tag-badge">#${t}</span>`).join('') : "";
                
                const mImg = document.getElementById('mImg'); 
                if(item.img) { mImg.src = item.img; mImg.style.display = 'block'; } else { mImg.style.display = 'none'; }
                
                // [v13.1] ë¯¸ë‹ˆë§µ ë° ê´€ê³„ ë°°ì§€ í‘œì‹œ
                const miniMapWrapper = document.getElementById('miniMapWrapper');
                const relContainer = document.getElementById('relContainer');
                relContainer.innerHTML = '';
                
                if (item.lat && item.lng) {
                    miniMapWrapper.style.display = 'block';
                    document.getElementById('miniMapCaption').innerText = item.geoName || "ì§€ë„ ìœ„ì¹˜";
                    setTimeout(() => {
                        if (miniMap) miniMap.remove();
                        miniMap = L.map('miniMap').setView([item.lat, item.lng], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(miniMap);
                        L.marker([item.lat, item.lng]).addTo(miniMap);
                    }, 200);
                } else { miniMapWrapper.style.display = 'none'; }

                if (item.relations) {
                    item.relations.split(',').forEach(r => {
                        const p = r.split(':');
                        const badge = document.createElement('span'); badge.className = 'rel-badge';
                        badge.innerHTML = `${p[0]} <small>${p[1]||''}</small>`;
                        badge.onclick = () => openModalByName(p[0]);
                        relContainer.appendChild(badge);
                    });
                }

                const area = document.getElementById('mContentArea'); area.innerHTML = '';
                if (item.type === 'poet' && item.poems) {
                    item.poems.forEach((p) => {
                        let body = `<div class="hanja-text">${parseText(p.content, true)}</div>`; 
                        if (p.simplified) body += `<div style="margin-top:5px; padding:10px; background:#f9f9f9; border-left:4px solid #d63384;">${parseText(p.simplified, true)}</div>`;
                        if(p.desc) body += `<details class="inner-details"><summary class="inner-summary">[í•´ì„¤ ë³´ê¸°]</summary><div class="explain-text">${parseText(p.desc, false)}</div></details>`; 
                        const details = document.createElement('details'); details.className = 'outer-details';
                        details.innerHTML = `<summary class="outer-summary">${cleanTitle(p.title)}</summary><div class="poem-body">${body}</div>`;
                        area.appendChild(details);
                    });
                } else { area.innerHTML = `<div class="poem-body">${parseText(item.historyDetail||"", false)}</div>`; }
                
                document.getElementById('detailModal').style.display = "block";
                document.getElementById('floatingCloseBtn').style.display = 'block';
            } catch (e) { console.error(e); }
        }

        // [v13.1] ê²€ìƒ‰ ì´ˆê¸°í™” (Xë²„íŠ¼)
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            filterData();
        }

        // [ê¸°ëŠ¥] ì§€ë„ ëª¨ë‹¬ ì—´ê¸°
        function openMapModal() {
            document.getElementById('mapModal').style.display = 'block';
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([34.26, 108.94], 5); // ì¥ì•ˆ(ì‹œì•ˆ) ì¤‘ì‹¬
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
                    markersLayer = L.layerGroup().addTo(map);
                } else { map.invalidateSize(); }
                markersLayer.clearLayers();
                db.forEach(item => {
                    if(item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng]);
                        marker.bindPopup(`<b>${item.geoName||item.name}</b><br><button onclick="closeModal('mapModal');openModal(${item.id})">ì´ë™</button>`);
                        markersLayer.addLayer(marker);
                    }
                });
            }, 200);
        }

        // [ê¸°ëŠ¥] ê´€ê³„ë„ ëª¨ë‹¬ ì—´ê¸°
        function openRelModal() {
            document.getElementById('relModal').style.display = 'block';
            const nodes = []; const edges = []; const ids = new Set();
            db.forEach(item => {
                if(!item.isShow || !item.relations) return;
                const name = cleanTitle(item.name);
                if(!ids.has(name)) { nodes.push({id:name, label:name, size:25, shape:'dot', color:'#ffcc00'}); ids.add(name); }
                item.relations.split(',').forEach(r => {
                    const p = r.split(':');
                    const target = p[0].trim();
                    if(!ids.has(target)) { nodes.push({id:target, label:target, size:20, shape:'dot', color:'#eee'}); ids.add(target); }
                    edges.push({from:name, to:target, label:p[1]||'', arrows:'to'});
                });
            });
            const container = document.getElementById('network');
            new vis.Network(container, { nodes, edges }, { nodes:{font:{size:16, face:'KoPub Batang'}}, physics:{stabilization:false} });
        }

        // [v12.4] í†µê³„ ëª¨ë‹¬
        function openStatModal() {
            const totalCards = db.length; 
            const stats = {}; let totalPoems = 0;
            db.forEach(item => {
                if (item.type === 'poet' && item.poems) {
                    const key = cleanTitle(item.name);
                    const count = item.poems.length;
                    stats[key] = (stats[key] || 0) + count;
                    totalPoems += count;
                }
            });
            const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            let html = `<table class="stat-table"><tr><th>ì´ ì¹´ë“œ</th><td>${totalCards}ê°œ</td></tr><tr><th>ì´ ì‘í’ˆ</th><td>${totalPoems}ìˆ˜</td></tr><tr><th colspan="2" style="background:#eee;">ğŸ† ì‘ê°€ë³„ ìˆœìœ„</th></tr>`;
            sortedStats.forEach((e, i) => html += `<tr><td>${i+1}. ${e[0]}</td><td style="text-align:right;">${e[1]}</td></tr>`);
            html += `</table>`;
            document.getElementById('statContent').innerHTML = html; document.getElementById('statModal').style.display = 'block';
        }

        function openContextModal(id) { document.getElementById('contextModal').style.display="block"; }
        
        function render(q="", f="all") {
            const root = document.getElementById('timeline-root'); root.innerHTML = '';
            const safeQ = q.trim().toLowerCase();
            document.getElementById('clearSearchBtn').style.display = safeQ ? 'block' : 'none';
            const filtered = db.filter(i => {
                const eraMatch = f === 'all' || i.era === f;
                if (!safeQ) return eraMatch;
                let tm = (i.name && i.name.toLowerCase().includes(safeQ)) || (i.tags && i.tags.join(" ").toLowerCase().includes(safeQ));
                return eraMatch && tm;
            });
            filtered.forEach(item => {
                if (item.isShow) {
                    const div = document.createElement('div'); div.className = item.type === 'poet' ? 'container left' : 'container right';
                    const imgTag = item.img ? `<img src="${item.img}" class="thumb-img">` : '';
                    let cardBg = item.cardColor || "#ffffff";
                    let tagHtml = item.tags ? '<div class="tag-container">' + item.tags.map(t => `<span class="tag-badge" onclick="searchTag('${t}')">#${t}</span>`).join('') + '</div>' : "";
                    const btns = isAdmin ? `<div class="action-btns" style="display:block;"><span class="btn-text btn-edit" onclick="editItem(${item.id})">[ìˆ˜ì •]</span><span class="btn-text btn-del" onclick="deleteItem(${item.id})">[ì‚­ì œ]</span></div>` : '';
                    div.innerHTML = `<div class="year-bubble">${item.year}</div><div class="content clearfix" style="background-color:${cardBg};" onclick="openModal('${item.id}')">${imgTag}<div class="title-text">${cleanTitle(item.name)}</div>${tagHtml}<small>${cleanTextForCard(item.desc)}</small>${btns}</div>`;
                    root.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.className = 'minor-row';
                    div.innerHTML = `<div class="minor-dot" data-tooltip="${item.year} : ${item.name}" onclick="openModal('${item.id}')"></div>`;
                    root.appendChild(div);
                }
            });
            setTimeout(adjustPadding, 100);
        }
        function populateEraFilter() { const s = document.getElementById('eraFilter'); const e = [...new Set(db.map(i=>i.era))].sort(); s.innerHTML='<option value="all">ëª¨ë“  ì‹œëŒ€</option>'; e.forEach(x=>{s.innerHTML+=`<option value="${x}">${x}</option>`}); }
        function filterData() { render(document.getElementById('searchInput').value.toLowerCase(), document.getElementById('eraFilter').value); }
        function saveConfig() { localStorage.setItem('tangTimelineConfig', JSON.stringify(config)); applyConfigUI(); alert('ì €ì¥ë¨'); }
        function applyConfigUI() { 
            document.getElementById('pageTitle').innerText = config.title; 
            document.body.style.backgroundColor = config.bgColor || "#fdfbf7"; 
            if(config.bgImage) document.body.style.backgroundImage = `url('${config.bgImage}')`;
        }
        function deleteItem(id) { if(confirm('ì‚­ì œ?')) { db = db.filter(i => i.id != id); saveToLocal(); render(); } }
        function closeModal(id) { document.getElementById(id).style.display = "none"; document.getElementById('floatingCloseBtn').style.display='none'; }
        function toggleAdmin() { document.getElementById('adminPanel').style.display = document.getElementById('adminPanel').style.display==='block'?'none':'block'; }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) closeModal(e.target.id); }
        init();
    </script>
</body>
</html>
